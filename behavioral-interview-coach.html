<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Behavioral Interview Coach</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* STAR component colors - muted pastels */
            --color-situation: #A8D5BA;
            --color-task: #AED9E0;
            --color-action: #FFD9A8;
            --color-result: #F4B4D4;
            
            /* Accent colors */
            --color-primary: #7B9AA6;
            --color-success: #9DC88D;
            --color-warning: #F5D76E;
            --color-danger: #E8A0A0;
            
            /* LP colors - Material Design palette */
            --lp-customer-obsession: #E91E63;
            --lp-ownership: #9C27B0;
            --lp-invent-and-simplify: #673AB7;
            --lp-are-right-a-lot: #3F51B5;
            --lp-learn-and-be-curious: #2196F3;
            --lp-hire-and-develop-the-best: #00BCD4;
            --lp-insist-on-highest-standards: #009688;
            --lp-think-big: #4CAF50;
            --lp-bias-for-action: #FF9800;
            --lp-frugality: #795548;
            --lp-earn-trust: #607D8B;
            --lp-dive-deep: #00796B;
            --lp-have-backbone: #C62828;
            --lp-deliver-results: #2E7D32;
            --lp-strive-to-be-earths-best-employer: #1565C0;
            --lp-success-and-scale: #6A1B9A;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #7B9AA6 0%, #9DC88D 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #7B9AA6 0%, #9DC88D 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #ddd;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 18px 22px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.95em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
            position: relative;
        }

        .nav-tab:hover {
            background: #e9ecef;
            color: #333;
        }

        .nav-tab.active {
            color: var(--color-primary);
            background: white;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--color-primary);
        }

        .content {
            padding: 40px;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .intro-box {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-success) 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .intro-box h2 {
            font-size: 1.6em;
            margin-bottom: 12px;
        }

        .intro-box p {
            font-size: 1.05em;
            line-height: 1.5;
            opacity: 0.95;
        }

        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .input-section h3 {
            font-size: 1.3em;
            margin-bottom: 12px;
            color: #333;
        }

        .input-section textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 0.95em;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .input-section textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .input-section input[type="text"],
        .input-section input[type="number"],
        .input-section select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95em;
            margin-bottom: 12px;
        }

        .input-section input:focus,
        .input-section select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .btn {
            padding: 12px 24px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 8px 8px 8px 0;
            display: inline-block;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(123, 154, 166, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-warning {
            background: var(--color-warning);
            color: #333;
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-container {
            display: none;
        }

        .results-container.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        /* Story Web Styles */
        .web-canvas {
            background: #fafafa;
            border: 2px solid #ddd;
            border-radius: 15px;
            min-height: 500px;
            position: relative;
            margin: 20px 0;
            overflow: auto;
            font-size: 1.1em; /* Larger base font for readability */
            line-height: 1.5;
        }

        .web-node {
            position: absolute;
            background: white;
            border: 3px solid;
            border-radius: 12px;
            padding: 15px;
            min-width: 200px;
            cursor: move;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }

        .web-node:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.25);
        }

        .web-node.situation { border-color: var(--color-situation); }
        .web-node.task { border-color: var(--color-task); }
        .web-node.action { border-color: var(--color-action); }
        .web-node.result { border-color: var(--color-result); }

        .node-header {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .node-anchor {
            font-size: 1.3em;
        }

        .node-content {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 10px;
        }

        .node-lps {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .lp-tag {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            white-space: nowrap;
            background: #607D8B; /* Fallback for unmatched LPs */
        }

        /* All 16 Leadership Principles */
        .lp-tag.customer-obsession { background: var(--lp-customer-obsession); }
        .lp-tag.ownership { background: var(--lp-ownership); }
        .lp-tag.invent-and-simplify { background: var(--lp-invent-and-simplify); }
        .lp-tag.are-right-a-lot { background: var(--lp-are-right-a-lot); }
        .lp-tag.learn-and-be-curious { background: var(--lp-learn-and-be-curious); }
        .lp-tag.hire-and-develop-the-best { background: var(--lp-hire-and-develop-the-best); }
        .lp-tag.insist-on-highest-standards { background: var(--lp-insist-on-highest-standards); }
        .lp-tag.think-big { background: var(--lp-think-big); }
        .lp-tag.bias-for-action { background: var(--lp-bias-for-action); }
        .lp-tag.frugality { background: var(--lp-frugality); }
        .lp-tag.earn-trust { background: var(--lp-earn-trust); }
        .lp-tag.dive-deep { background: var(--lp-dive-deep); }
        .lp-tag.have-backbone-disagree-and-commit, 
        .lp-tag.have-backbone { background: var(--lp-have-backbone); }
        .lp-tag.deliver-results { background: var(--lp-deliver-results); }
        .lp-tag.strive-to-be-earths-best-employer { background: var(--lp-strive-to-be-earths-best-employer); }
        .lp-tag.success-and-scale-bring-broad-responsibility { background: var(--lp-success-and-scale); }

        /* Question Drill Styles */
        .question-card {
            background: white;
            border: 2px solid var(--color-primary);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }

        .question-text {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .question-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .question-tag {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            background: #e9ecef;
            color: #495057;
        }

        .question-tag.context { background: #d4edda; color: #155724; }
        .question-tag.specific-ask { background: #d1ecf1; color: #0c5460; }
        .question-tag.constraint { background: #fff3cd; color: #856404; }
        .question-tag.lp-signal { background: #e7e3ff; color: #5a46a8; }

        .timer-display {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 700;
            margin: 15px 0;
        }

        .timer-display.running {
            background: var(--color-warning);
        }

        .timer-display.expired {
            background: var(--color-danger);
            color: white;
        }

        .star-timer-breakdown {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .star-timer-segment {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        .star-timer-segment.situation { background: var(--color-situation); }
        .star-timer-segment.task { background: var(--color-task); }
        .star-timer-segment.action { background: var(--color-action); }
        .star-timer-segment.result { background: var(--color-result); }

        .audio-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .audio-wave {
            height: 60px;
            background: #e9ecef;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }

        .evaluation-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .score-display {
            font-size: 3em;
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
            color: var(--color-primary);
        }

        .feedback-section {
            margin: 20px 0;
        }

        .feedback-section h4 {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #333;
        }

        .feedback-item {
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .feedback-item.strength {
            background: #d4edda;
            border-left-color: var(--color-success);
            color: #155724;
        }

        .feedback-item.weakness {
            background: #f8d7da;
            border-left-color: var(--color-danger);
            color: #721c24;
        }

        .feedback-item.suggestion {
            background: #fff3cd;
            border-left-color: var(--color-warning);
            color: #856404;
        }

        /* Analytics Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--color-primary);
        }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-success);
            transition: width 0.5s;
        }

        .alert-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 0.85em;
            font-weight: 700;
        }

        .alert-badge.red { background: var(--color-danger); color: white; }
        .alert-badge.yellow { background: var(--color-warning); color: #333; }
        .alert-badge.green { background: var(--color-success); color: white; }

        /* Heat Map */
        .heatmap-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: 200px repeat(auto-fill, minmax(80px, 1fr));
            gap: 5px;
            margin-top: 20px;
        }

        .heatmap-cell {
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            font-weight: 600;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
        }

        .heatmap-label {
            background: #e9ecef;
            color: #333;
            justify-content: flex-start;
            padding-left: 15px;
        }

        .heatmap-header {
            background: var(--color-primary);
            color: white;
        }

        .coverage-none { background: #f8f9fa; color: #999; }
        .coverage-low { background: #fff3cd; color: #856404; }
        .coverage-medium { background: #d1ecf1; color: #0c5460; }
        .coverage-high { background: #d4edda; color: #155724; }
        .coverage-strong { background: var(--color-success); color: white; }

        /* Responsive */
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .nav-tab {
                padding: 12px 16px;
                font-size: 0.85em;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .star-timer-breakdown {
                grid-template-columns: 1fr 1fr;
            }
        }

        .highlight-box {
            background: #fff3cd;
            border-left: 5px solid var(--color-warning);
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .guide-section {
            background: #e7f3ff;
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            border-left: 5px solid var(--color-primary);
        }

        .guide-section h3 {
            color: var(--color-primary);
            margin-bottom: 15px;
        }

        .guide-section ul {
            margin-left: 20px;
            line-height: 2;
        }

        /* Story selection */
        .story-selector {
            margin: 20px 0;
        }

        .story-option {
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .story-option:hover {
            background: #f8f9fa;
            border-color: var(--color-primary);
        }

        .story-option.selected {
            background: #e7e3ff;
            border-color: var(--color-primary);
            border-width: 3px;
        }

        .checkbox-group {
            margin: 15px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin: 5px 0;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- BYOK API Key Modal -->
    <div id="byok-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="font-size: 3em; margin-bottom: 20px;">üîë</div>
            <h2 style="margin-bottom: 15px; color: #333;">API Key Required</h2>
            <p style="color: #666; margin-bottom: 25px; line-height: 1.6;">
                This tool uses Claude AI for story analysis and practice. Enter your Anthropic API key to enable AI features.
                <br><br>
                <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: #667eea;">Get your API key from Anthropic Console ‚Üí</a>
            </p>
            <div style="margin-bottom: 20px;">
                <input type="password" id="byok-api-key-input" placeholder="sk-ant-api03-..." style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em; font-family: monospace;">
            </div>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="saveApiKey()" style="padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 1em; cursor: pointer; font-weight: 600;">Save API Key</button>
                <button onclick="skipApiKey()" style="padding: 12px 20px; background: #f0f0f0; color: #666; border: none; border-radius: 10px; font-size: 1em; cursor: pointer;">Skip (Limited Mode)</button>
            </div>
            <p style="margin-top: 20px; font-size: 0.85em; color: #999;">
                Your API key is stored locally in your browser and never sent to any server except Anthropic's API.
            </p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üéØ Behavioral Interview Coach</h1>
            <p id="header-subtitle">Complete Interview Preparation System</p>
            <div id="api-status" style="margin-top: 10px; display: none;">
                <span id="api-status-text" style="background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 15px; font-size: 0.85em;"></span>
                <button onclick="showApiKeyModal()" style="background: none; border: none; color: white; text-decoration: underline; cursor: pointer; margin-left: 10px; font-size: 0.85em;">Change Key</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('analyzer')">üìù Analyze</button>
            <button class="nav-tab" onclick="showSection('web-builder')">üï∏Ô∏è Story Web</button>
            <button class="nav-tab" onclick="showSection('timeline')">üìÖ Timeline</button>
            <button class="nav-tab" onclick="showSection('coverage')">üìä Competency Map</button>
            <button class="nav-tab" onclick="showSection('simulator')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">üéØ Practice</button>
            <button class="nav-tab" onclick="showSection('qa-analyzer')">üìã Q&A Review</button>
            <button class="nav-tab" onclick="showSection('guide')">üìö Guide</button>
            <button class="nav-tab" onclick="showSection('research')" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">üîç Research</button>
            <button class="nav-tab" onclick="showSection('settings')">‚öôÔ∏è Settings</button>
        </div>

        <div class="content">
            <!-- TAB 1: Story Analyzer (EXISTING - KEEP) -->
            <div id="analyzer" class="section active">
                <div class="intro-box">
                    <h2>üìù Story Depth Analyzer</h2>
                    <p>Evaluate if your story is "meaty" enough for 40 minutes of follow-up questions. Get depth scoring and improvement suggestions.</p>
                    <button class="btn btn-sm btn-secondary" onclick="showStoryManager()" style="margin-top: 10px;">üìö Manage Saved Stories</button>
                </div>
                
                <!-- Resume Storage Section -->
                <div style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border: 2px solid #667eea; border-radius: 12px; margin-bottom: 20px; overflow: hidden;">
                    <div onclick="toggleResumeSection()" style="padding: 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <span style="font-size: 1.3em;">üìÑ</span>
                        <span style="font-weight: bold; flex: 1;">Your Resume</span>
                        <span id="resume-status" style="font-size: 0.85em; opacity: 0.9;">Not saved</span>
                        <span id="resume-toggle-icon" style="font-size: 1.2em; transition: transform 0.3s;">‚ñº</span>
                    </div>
                    <div id="resume-section" style="display: none; padding: 15px;">
                        <p style="font-size: 0.9em; color: #555; margin-bottom: 10px;">
                            Paste your resume here. AI Brainstorm and response suggestions will use this to give you personalized, grounded suggestions based on your actual experience.
                        </p>
                        <textarea id="resume-input" rows="8" placeholder="Paste your resume text here...
                        
Example:
EXPERIENCE
Company Name | Role | Dates
‚Ä¢ Achievement with metrics
‚Ä¢ Another achievement..." style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 0.9em; resize: vertical;"></textarea>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-sm btn-success" onclick="saveResume()">üíæ Save Resume</button>
                            <button class="btn btn-sm btn-secondary" onclick="clearResume()">üóëÔ∏è Clear</button>
                            <span id="resume-save-status" style="display: none; margin-left: auto; padding: 5px 10px; border-radius: 5px; font-size: 0.85em;"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Job Posting Section -->
                <div style="background: linear-gradient(135deg, #ff980015 0%, #f4433615 100%); border: 2px solid #ff5722; border-radius: 12px; margin-bottom: 20px; overflow: hidden;">
                    <div onclick="toggleJobSection()" style="padding: 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; background: linear-gradient(135deg, #ff9800 0%, #f44336 100%); color: white;">
                        <span style="font-size: 1.3em;">üíº</span>
                        <span style="font-weight: bold; flex: 1;">Target Job Posting</span>
                        <span id="job-status" style="font-size: 0.85em; opacity: 0.9;">Not saved</span>
                        <span id="job-toggle-icon" style="font-size: 1.2em; transition: transform 0.3s;">‚ñº</span>
                    </div>
                    <div id="job-section" style="display: none; padding: 15px;">
                        <p style="font-size: 0.9em; color: #555; margin-bottom: 10px;">
                            Paste the job posting details. AI will use this to tailor questions, focus on relevant LPs, and customize guidance for your specific role.
                        </p>
                        <div style="margin-bottom: 12px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em;">Job URL (optional, for reference)</label>
                            <input type="text" id="job-url-input" placeholder="https://amazon.jobs/en/jobs/..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.9em;">
                        </div>
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em;">Job Title & Level</label>
                            <input type="text" id="job-title-input" placeholder="e.g., Senior Financial Analyst, L5" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.9em; margin-bottom: 10px;">
                        </div>
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 5px; font-size: 0.9em;">Job Description (paste full text)</label>
                            <textarea id="job-description-input" rows="8" placeholder="Paste the full job description here...

Key things to include:
‚Ä¢ Job responsibilities
‚Ä¢ Required qualifications
‚Ä¢ Preferred qualifications
‚Ä¢ Team/org info" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 0.9em; resize: vertical;"></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-sm btn-success" onclick="saveJobPosting()">üíæ Save Job</button>
                            <button class="btn btn-sm btn-secondary" onclick="clearJobPosting()">üóëÔ∏è Clear</button>
                            <span id="job-save-status" style="display: none; margin-left: auto; padding: 5px 10px; border-radius: 5px; font-size: 0.85em;"></span>
                        </div>
                        <div id="job-analysis-container" style="display: none; margin-top: 15px; padding: 15px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <div style="font-weight: bold; margin-bottom: 8px;">üéØ AI Analysis of This Role</div>
                            <div id="job-analysis-content" style="font-size: 0.9em; line-height: 1.6;"></div>
                        </div>
                    </div>
                </div>

                <div class="input-section">
                    <h3>Your Story</h3>
                    <textarea id="story-input" placeholder="Paste your complete story here..."></textarea>
                    <button class="btn btn-primary" onclick="analyzeStory()">üîç Analyze Story Depth</button>
                    <button class="btn btn-secondary" onclick="clearStoryAnalyzer()">Clear</button>
                </div>

                <div class="loading" id="story-loading">
                    <div class="spinner"></div>
                    <p>AI is analyzing your story...</p>
                </div>

                <div class="results-container" id="story-results"></div>
            </div>

            <!-- TAB 2: Story Web Builder (NEW) -->
            <div id="web-builder" class="section">
                <div class="intro-box">
                    <h2>üï∏Ô∏è Story Web</h2>
                    <p>Visual anchors trigger recall under stress. <strong>Practice Mode</strong> trains your memory by hiding details until you retrieve them.</p>
                </div>

                <div class="input-section" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Select Story</label>
                        <select id="web-story-select" onchange="loadStoryWeb()" style="width: 100%; font-size: 1em; padding: 12px; border-radius: 8px; border: 2px solid #ddd;">
                            <option value="">-- Select a story --</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">&nbsp;</label>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="importFromJSON()" style="padding: 12px 16px;">
                                üì• Import JSON
                            </button>
                            <button class="btn btn-secondary" onclick="showStoryManager()" style="padding: 12px 16px;">
                                üìÇ Manage
                            </button>
                        </div>
                    </div>
                    <div id="mode-toggle-container" style="display: none;">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Mode</label>
                        <div style="display: flex; border-radius: 8px; overflow: hidden; border: 2px solid var(--color-primary);">
                            <button id="mode-review-btn" onclick="setWebMode('review')" class="btn" style="border-radius: 0; margin: 0; padding: 12px 20px; background: var(--color-primary); color: white;">üëÅÔ∏è Review</button>
                            <button id="mode-practice-btn" onclick="setWebMode('practice')" class="btn" style="border-radius: 0; margin: 0; padding: 12px 20px; background: white; color: #333;">üß† Practice</button>
                        </div>
                    </div>
                </div>

                <div id="web-editor" style="display: none;">
                    <!-- Toolbar -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <h3 id="web-story-title" style="margin: 0;">Story Web</h3>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-sm btn-success" onclick="showAISuggestModal()">ü§ñ AI Suggest</button>
                            <button class="btn btn-sm btn-secondary" onclick="toggleRawStory()">üìñ Original</button>
                            <button class="btn btn-sm btn-secondary" onclick="toggleManualEditor()">‚úèÔ∏è Add Node</button>
                            <button class="btn btn-sm btn-warning" onclick="regenerateStoryWeb()">üîÑ Regenerate</button>
                            <div style="position: relative; display: inline-block;">
                                <button class="btn btn-sm btn-primary" onclick="toggleExportMenu()">üì§ Export ‚ñæ</button>
                                <div id="export-menu" style="display: none; position: absolute; right: 0; top: 100%; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 100; min-width: 220px; margin-top: 5px;">
                                    <div style="padding: 8px 0;">
                                        <button onclick="event.stopPropagation(); exportToVisualHTML()" style="display: block; width: 100%; text-align: left; padding: 10px 15px; border: none; background: none; cursor: pointer; font-size: 0.9em;" onmouseover="this.style.background='#e8f5e9'" onmouseout="this.style.background='none'">
                                            üñºÔ∏è <strong>Visual HTML</strong> (Print/Save)
                                        </button>
                                        <div style="padding: 0 15px 8px; font-size: 0.75em; color: #888;">Full details, save as PDF</div>
                                        <div style="border-top: 1px solid #eee; margin: 5px 0;"></div>
                                        <button onclick="event.stopPropagation(); exportToJSON()" style="display: block; width: 100%; text-align: left; padding: 10px 15px; border: none; background: none; cursor: pointer; font-size: 0.9em;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='none'">
                                            üìÑ JSON (Full Backup)
                                        </button>
                                        <button onclick="event.stopPropagation(); importFromJSON()" style="display: block; width: 100%; text-align: left; padding: 10px 15px; border: none; background: none; cursor: pointer; font-size: 0.9em;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='none'">
                                            üì• Import JSON
                                        </button>
                                        <div style="border-top: 1px solid #eee; margin: 5px 0;"></div>
                                        <button onclick="event.stopPropagation(); exportToMarkdown()" style="display: block; width: 100%; text-align: left; padding: 10px 15px; border: none; background: none; cursor: pointer; font-size: 0.9em;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='none'">
                                            üìù Markdown Summary
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="deleteCurrentStory()">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Practice Mode Instructions -->
                    <div id="practice-instructions" style="display: none; background: linear-gradient(135deg, #e8f5e8 0%, #f0f9f0 100%); padding: 15px 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid var(--color-success);">
                        <strong>üß† Practice Mode Active</strong>
                        <p style="margin: 8px 0 0; font-size: 0.9em; color: #555;">
                            Only anchors visible. <strong>Click a card</strong> ‚Üí try to recall the event ‚Üí <strong>click again</strong> to reveal ‚Üí rate yourself.
                            Follow the S‚ÜíT‚ÜíA‚ÜíR flow to practice your full story narrative.
                        </p>
                    </div>
                    
                    <!-- STAR Flow Legend -->
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <span style="padding: 6px 12px; background: var(--color-situation); border-radius: 6px; font-size: 0.85em; font-weight: 600;">üèîÔ∏è S</span>
                        <span style="color: #ccc;">‚Üí</span>
                        <span style="padding: 6px 12px; background: var(--color-task); border-radius: 6px; font-size: 0.85em; font-weight: 600;">üéØ T</span>
                        <span style="color: #ccc;">‚Üí</span>
                        <span style="padding: 6px 12px; background: var(--color-action); border-radius: 6px; font-size: 0.85em; font-weight: 600;">‚ö° A</span>
                        <span style="color: #ccc;">‚Üí</span>
                        <span style="padding: 6px 12px; background: var(--color-result); border-radius: 6px; font-size: 0.85em; font-weight: 600;">üíé R</span>
                        <div id="practice-score" style="margin-left: auto; display: none; background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <span style="color: var(--color-success);">‚úì <span id="practice-got-count">0</span></span>
                            <span style="margin: 0 8px; color: #ccc;">|</span>
                            <span style="color: var(--color-danger);">‚úó <span id="practice-missed-count">0</span></span>
                        </div>
                    </div>
                    
                    <!-- Story Canvas -->
                    <div id="web-canvas" class="web-canvas" style="min-height: 500px; background: #fafafa; border-radius: 15px; border: 2px solid #eee;"></div>
                    
                    <!-- Stats Footer -->
                    <div id="web-stats" style="margin-top: 15px; padding: 15px 20px; background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%); border-radius: 10px; display: flex; gap: 25px; justify-content: center; flex-wrap: wrap; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"></div>
                    
                    <!-- Raw Story Reference - Collapsed -->
                    <div id="raw-story-reference" style="display: none; margin-top: 20px;">
                        <div class="input-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3>üìñ Original Story Text</h3>
                                <button class="btn btn-sm btn-secondary" onclick="toggleRawStory()">Close</button>
                            </div>
                            <div id="raw-story-content" style="margin-top: 10px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd; max-height: 300px; overflow-y: auto; font-size: 0.95em; line-height: 1.7;"></div>
                        </div>
                    </div>
                    
                    <!-- Manual Node Editor - Collapsed by default -->
                    <div id="manual-node-editor" style="display: none; margin-top: 20px;">
                        <div class="input-section">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3>‚úèÔ∏è Add Event Node</h3>
                                <button class="btn btn-sm btn-secondary" onclick="toggleManualEditor()">Close</button>
                            </div>
                            <input type="text" id="event-title" placeholder="Event title (e.g., 'Built automated dashboard')">
                            <select id="event-star-component">
                                <option value="situation">üèîÔ∏è Situation</option>
                                <option value="task">üéØ Task</option>
                                <option value="action">‚ö° Action</option>
                                <option value="result">üíé Result</option>
                            </select>
                            
                            <h4 style="margin-top: 15px;">Event Dimensions</h4>
                            <input type="text" id="event-stakeholders" placeholder="Stakeholders (comma-separated)">
                            <textarea id="event-problem" placeholder="Problem" rows="2"></textarea>
                            <textarea id="event-solution" placeholder="Solution" rows="2"></textarea>
                            <textarea id="event-alternatives" placeholder="Alternatives considered" rows="2"></textarea>
                            <textarea id="event-metrics" placeholder="Metrics (e.g., '5 days to 1.5 days, 70% improvement')" rows="2"></textarea>
                            <textarea id="event-tradeoffs" placeholder="Tradeoffs" rows="2"></textarea>
                            
                            <h4 style="margin-top: 15px;">Visual Anchors</h4>
                            <input type="text" id="event-emoji" placeholder="Emoji (e.g., üìä)">
                            <input type="text" id="event-keyword" placeholder="Keyword (e.g., 'Dashboard')">
                            
                            <h4 style="margin-top: 15px;">Leadership Principles</h4>
                            <div class="checkbox-group" id="event-lps"></div>
                            
                            <button class="btn btn-primary" onclick="addEventNode()">Add Node</button>
                        </div>
                    </div>

                    <!-- Node Detail Modal -->
                    <div id="node-detail-modal" onclick="if(event.target === this) closeNodeDetail()" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto; padding: 20px;">
                        <div style="background: white; border-radius: 15px; padding: 25px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; margin: auto;">
                            <div id="node-detail-content"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: LP Coverage (EXISTING - KEEP) -->
            <div id="coverage" class="section">
                <div class="intro-box">
                    <h2>üìä Leadership Principle Coverage Map</h2>
                    <p>Visual heat map showing which LPs your stories cover. Identify gaps and ensure MECE coverage.</p>
                </div>

                <div class="input-section">
                    <h3>Paste All Your Stories</h3>
                    <p style="color: #666; margin-bottom: 10px;">Separate with "---" or blank lines</p>
                    <textarea id="stories-bulk-input" style="min-height: 250px;"></textarea>
                    <button class="btn btn-primary" onclick="analyzeCoverage()">üìä Generate Coverage Map</button>
                </div>

                <div class="loading" id="coverage-loading">
                    <div class="spinner"></div>
                    <p>Analyzing LP coverage...</p>
                </div>

                <div class="results-container" id="coverage-results"></div>
            </div>

            <!-- TAB 4: Question Drill (NEW - MAIN FEATURE) -->
            <div id="drill" class="section">
                <div class="intro-box">
                    <h2>üéØ Question Drill + Follow-ups</h2>
                    <p>Practice with real bar-raiser questions. Get timed, scored, and defend follow-ups. Build interview muscle memory.</p>
                </div>

                <div class="input-section">
                    <h3>Training Configuration</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label>Select Leadership Principles:</label>
                            <div class="checkbox-group" id="drill-lp-selection"></div>
                        </div>
                        <div>
                            <label>Timer Settings:</label>
                            <div class="checkbox-item">
                                <input type="checkbox" id="timer-visible" checked>
                                <label for="timer-visible">Show STAR Timer</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="enable-audio" checked>
                                <label for="enable-audio">Enable Audio Recording</label>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="startQuestionDrill()">üé¨ Start Practice Drill</button>
                    <button class="btn btn-warning" onclick="loadFromQueue()">üìö Practice Review Queue</button>
                    <button class="btn btn-primary" onclick="showAnalyticsDashboard()">üìä View Analytics</button>
                </div>

                <!-- Analytics Dashboard Modal -->
                <div id="analytics-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
                    <div style="max-width: 1200px; margin: 50px auto; background: white; border-radius: 20px; padding: 40px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                            <h2>üìä Practice Analytics Dashboard</h2>
                            <button class="btn btn-secondary" onclick="closeAnalyticsDashboard()">‚úï Close</button>
                        </div>
                        <div id="analytics-content"></div>
                    </div>
                </div>

                <div id="drill-session" style="display: none;">
                    <div class="question-card">
                        <div class="question-text" id="drill-question"></div>
                        <button class="btn btn-sm btn-warning" onclick="showQuestionHints()">üí° Show AI Tags (Hint)</button>
                        <div id="question-hints" style="display: none;"></div>
                    </div>

                    <div class="input-section">
                        <h3>Select Story & Key Events</h3>
                        <select id="drill-story-select">
                            <option value="">-- Select story --</option>
                        </select>
                        <div id="drill-events-list"></div>
                    </div>

                    <div class="input-section">
                        <h3>Deliver Your Response</h3>
                        <div class="timer-display" id="main-timer">
                            ‚è± <span id="timer-value">00:00</span> / 60s
                        </div>
                        <div class="star-timer-breakdown" id="star-breakdown" style="display: none;">
                            <div class="star-timer-segment situation">S: <span id="timer-s">0s</span></div>
                            <div class="star-timer-segment task">T: <span id="timer-t">0s</span></div>
                            <div class="star-timer-segment action">A: <span id="timer-a">0s</span></div>
                            <div class="star-timer-segment result">R: <span id="timer-r">0s</span></div>
                        </div>

                        <div class="audio-controls" id="audio-section">
                            <button class="btn btn-danger" id="record-btn" onclick="toggleRecording()">üé§ Start Recording</button>
                            <button class="btn btn-primary" id="playback-btn" onclick="playbackAudio()" style="display: none;">‚ñ∂Ô∏è Playback</button>
                            <div class="audio-wave" id="audio-wave">Audio will appear here</div>
                        </div>

                        <label>Type/Edit Response:</label>
                        <textarea id="drill-response" rows="8" placeholder="Type your response or edit transcription..."></textarea>

                        <button class="btn btn-primary" onclick="submitDrillResponse()">üì§ Submit for Evaluation</button>
                    </div>

                    <div class="results-container" id="drill-evaluation"></div>

                    <div id="followup-section" style="display: none;">
                        <div class="intro-box">
                            <h2>Follow-up Questions</h2>
                            <p>Bar-raiser mode: Answer follow-ups (10s each)</p>
                        </div>
                        <div id="followup-container"></div>
                        <button class="btn btn-warning" onclick="generateNextFollowUp()">‚ùì Generate Next Follow-up</button>
                        <button class="btn btn-success" onclick="endDrill()">‚úÖ End Drill - Save Session</button>
                    </div>
                </div>
            </div>

            <!-- TAB 5: Follow-up Simulator (ENHANCED with LP Selection) -->
            <div id="simulator" class="section">
                <div class="intro-box">
                    <h2>üí¨ Interview Simulator</h2>
                    <p>Practice with AI interviewer. Start from a story OR pick an LP to get targeted questions.</p>
                </div>

                <div class="input-section" id="simulator-setup">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
                        <div style="flex: 1; min-width: 250px;">
                            <h3>Option A: Start with Story</h3>
                            <textarea id="simulator-story-input" placeholder="Paste your story here..." rows="5"></textarea>
                            <button class="btn btn-success" onclick="startSimulation()" style="margin-top: 10px;">üé¨ Start with Story</button>
                        </div>
                        <div style="display: flex; align-items: center; font-size: 1.5em; color: #999; padding: 20px;">OR</div>
                        <div style="flex: 1; min-width: 250px;">
                            <h3>Option B: Pick LP for Questions</h3>
                            <select id="simulator-lp-select" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                                <option value="">-- Select Leadership Principle --</option>
                                <option value="Dive Deep">üîç Dive Deep</option>
                                <option value="Ownership">üëë Ownership</option>
                                <option value="Invent and Simplify">üí° Invent & Simplify</option>
                                <option value="Learn and Be Curious">üìö Learn & Be Curious</option>
                                <option value="Deliver Results">üéØ Deliver Results</option>
                                <option value="Earn Trust">ü§ù Earn Trust</option>
                                <option value="Have Backbone">üí™ Have Backbone</option>
                                <option value="Bias for Action">‚ö° Bias for Action</option>
                                <option value="Customer Obsession">‚ù§Ô∏è Customer Obsession</option>
                                <option value="Think Big">üöÄ Think Big</option>
                            </select>
                            <button class="btn btn-primary" onclick="startLPSimulation()" style="margin-top: 10px;">üéØ Start LP Practice</button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 10px;">
                        <strong>üí° Tip:</strong> Use "Story" mode when you want to practice a specific experience. Use "LP" mode when you want random questions targeting a principle.
                    </div>
                </div>

                <div id="simulator-area" style="display: none;">
                    <div id="simulator-context" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: none;">
                        <strong id="simulator-mode-label">Mode</strong>: <span id="simulator-mode-value"></span>
                    </div>
                    <div style="background: white; border-radius: 10px; padding: 20px; max-height: 400px; overflow-y: auto;" id="conversation-thread"></div>
                    <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
                        <button class="btn btn-primary" onclick="generateSimulatorFollowUp()">‚ùì Generate Follow-up</button>
                        <button class="btn btn-warning" onclick="suggestSimulatorResponse()">üí° Suggest Response</button>
                        <button class="btn btn-success" onclick="generateNodeFromSimulator()">ü§ñ Generate Node</button>
                        <button class="btn btn-secondary" onclick="resetSimulation()">üîÑ Reset</button>
                    </div>
                    <div class="input-section" style="margin-top: 20px;">
                        <h3>Your Response</h3>
                        <textarea id="candidate-response" placeholder="Type your response here..."></textarea>
                        <button class="btn btn-success" onclick="submitSimulatorResponse()">üì§ Submit</button>
                    </div>
                </div>
            </div>

            <!-- TAB 6: Q&A Analyzer (EXISTING - KEEP + ENHANCE) -->
            <div id="qa-analyzer" class="section">
                <div class="intro-box">
                    <h2>üìã Q&A Batch Analyzer</h2>
                    <p>Paste pre-written Q&A pairs for instant analysis and sample improved responses.</p>
                </div>

                <div class="input-section">
                    <h3>Questions & Answers</h3>
                    <p style="color: #666;">Format: Q: [question] / A: [answer]</p>
                    <textarea id="qa-input" style="min-height: 250px;"></textarea>
                    <button class="btn btn-primary" onclick="analyzeQA()">üí¨ Analyze Q&A</button>
                    <button class="btn btn-secondary" onclick="clearQA()">Clear</button>
                </div>

                <div class="loading" id="qa-loading">
                    <div class="spinner"></div>
                    <p>Analyzing Q&A...</p>
                </div>

                <div class="results-container" id="qa-results"></div>
            </div>

            <!-- TAB 7: Guide (EXISTING - ENHANCE) -->
            <div id="guide" class="section">
                <div class="intro-box">
                    <h2>üìö Quick Reference Guide</h2>
                    <p>Essential tips for your Amazon interview</p>
                    <button class="btn btn-sm btn-primary" onclick="refreshGuide()" style="margin-top: 10px;">üîÑ Refresh Guide</button>
                </div>
                
                <!-- Dynamic Job-Specific Section -->
                <div id="guide-job-section" style="display: none;">
                    <div class="guide-section" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #ff9800;">
                        <h3>üéØ Your Target Role: <span id="guide-job-title">Loading...</span></h3>
                        <div style="margin-top: 15px;">
                            <strong>Top LPs to Focus:</strong>
                            <div id="guide-top-lps" style="margin-top: 10px;"></div>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong>Key Skills to Demonstrate:</strong>
                            <div id="guide-key-skills" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong>Things to Emphasize:</strong>
                            <ul id="guide-emphasize" style="margin-top: 8px; line-height: 1.8;"></ul>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong>‚ö†Ô∏è Address/Avoid:</strong>
                            <ul id="guide-red-flags" style="margin-top: 8px; line-height: 1.8;"></ul>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong>‚ùì Likely Questions:</strong>
                            <ol id="guide-likely-questions" style="margin-top: 8px; line-height: 1.8;"></ol>
                        </div>
                    </div>
                </div>
                
                <!-- Default Section (shown when no job saved) -->
                <div id="guide-default-section">
                    <div class="guide-section">
                        <h3>üéØ Top 5 Leadership Principles for FP&A Roles</h3>
                        <div style="margin-top: 15px;">
                            <span class="lp-tag dive-deep">1. Dive Deep</span>
                            <span class="lp-tag ownership">2. Ownership</span>
                            <span class="lp-tag invent-and-simplify">3. Invent & Simplify</span>
                            <span class="lp-tag learn-and-be-curious">4. Learn & Be Curious</span>
                            <span class="lp-tag deliver-results">5. Deliver Results</span>
                        </div>
                        <p style="margin-top: 15px; line-height: 1.8;">
                            <strong>What interviewers want:</strong> Variance analysis, CapEx/OpEx automation, 
                            cross-functional influence, data-driven decisions, process improvements with metrics.
                        </p>
                        <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                            üí° <strong>Tip:</strong> Save your target job posting in the Analyze tab to get personalized guidance here!
                        </p>
                    </div>
                </div>

                <div class="guide-section">
                    <h3>‚≠ê STAR Structure Timing</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px;">
                        <div style="text-align: center; padding: 15px; background: var(--color-situation); border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: 700;">15%</div>
                            <div>Situation</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: var(--color-task); border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: 700;">15%</div>
                            <div>Task</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: var(--color-action); border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: 700;">50%</div>
                            <div>Action</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: var(--color-result); border-radius: 10px;">
                            <div style="font-size: 2em; font-weight: 700;">20%</div>
                            <div>Result</div>
                        </div>
                    </div>
                </div>

                <div class="highlight-box">
                    <strong>üí° What Makes a Story "Meaty"?</strong>
                    <ul style="margin-top: 15px; line-height: 2;">
                        <li>Can sustain 5-7 follow-up questions</li>
                        <li>Has specific metrics at multiple levels</li>
                        <li>Includes cross-functional complexity</li>
                        <li>Shows both technical and leadership dimensions</li>
                        <li>Clear "what I'd do differently" elements</li>
                    </ul>
                </div>

                <div class="guide-section">
                    <h3>üé® Event-Centric Story Structure</h3>
                    <p>Each event in your story has 6 dimensions:</p>
                    <ul>
                        <li><strong>Stakeholders:</strong> Who was involved? (CFO, teams, etc.)</li>
                        <li><strong>Problem:</strong> What was wrong?</li>
                        <li><strong>Solution:</strong> What did you do?</li>
                        <li><strong>Alternatives:</strong> What else did you consider?</li>
                        <li><strong>Metrics:</strong> What were the numbers?</li>
                        <li><strong>Tradeoffs:</strong> What did you sacrifice?</li>
                    </ul>
                </div>
            </div>

            <!-- TAB: Timeline View (NEW) -->
            <div id="timeline" class="section">
                <div class="intro-box">
                    <h2>üìÖ Story Timeline</h2>
                    <p>Visualize your stories as interactive Gantt timelines. See the chronological flow of events, stakeholders, and outcomes.</p>
                </div>

                <div class="input-section">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Select Story</label>
                            <select id="timeline-story-select" onchange="loadTimeline()" style="width: 100%; font-size: 1em; padding: 12px; border-radius: 8px; border: 2px solid #ddd;">
                                <option value="">-- Select a story --</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">&nbsp;</label>
                            <button class="btn btn-primary" onclick="regenerateTimeline()">üîÑ Regenerate</button>
                        </div>
                    </div>
                </div>

                <div id="timeline-container" style="display: none;">
                    <!-- Color Legend -->
                    <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 20px 0; display: flex; flex-wrap: wrap; gap: 20px; align-items: center;">
                        <span style="font-weight: bold; color: #333;">Color Legend:</span>
                        <div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 14px; border-radius: 3px; background: #8a8aef;"></div><span>Action</span></div>
                        <div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 14px; border-radius: 3px; background: #ff6b6b;"></div><span>Challenge/Risk</span></div>
                        <div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 14px; border-radius: 3px; background: #7bc97b;"></div><span>Result</span></div>
                        <div style="display: flex; align-items: center; gap: 8px;"><div style="width: 20px; height: 14px; border-radius: 3px; background: #d4d4d4;"></div><span>Milestone</span></div>
                    </div>

                    <!-- Mermaid Timeline -->
                    <div id="timeline-mermaid" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow-x: auto;"></div>

                    <!-- Timeline Details Table -->
                    <div id="timeline-details" style="margin-top: 20px;"></div>
                </div>

                <div id="timeline-empty" style="text-align: center; padding: 60px 20px; color: #666;">
                    <div style="font-size: 4em; margin-bottom: 20px;">üìÖ</div>
                    <p>Select a story above to generate its timeline visualization.</p>
                    <p style="font-size: 0.9em; margin-top: 10px;">Timelines are auto-generated from your Story Web nodes.</p>
                </div>
            </div>

            <!-- TAB: Company Research (NEW) -->
            <div id="research" class="section">
                <div class="intro-box" style="background: linear-gradient(135deg, #11998e15 0%, #38ef7d15 100%); border: 2px solid #11998e;">
                    <h2>üîç Company Research</h2>
                    <p>Research your target company using AI-powered web search. Get real interview insights, competencies, and preparation tips.</p>
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">Requires API key. Costs ~$0.05-0.10 per research.</p>
                </div>

                <div class="input-section">
                    <h3>üè¢ Research Target</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Company Name *</label>
                            <input type="text" id="research-company" placeholder="e.g., Amazon, Google, Stripe" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Role / Position *</label>
                            <input type="text" id="research-role" placeholder="e.g., Senior Product Manager, Software Engineer" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Additional Context (optional)</label>
                        <textarea id="research-context" rows="2" placeholder="e.g., L6 level, Seattle location, AWS team" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;"></textarea>
                    </div>
                    <button class="btn btn-success" onclick="startCompanyResearch()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                        üîç Research Company
                    </button>
                </div>

                <!-- Research Results -->
                <div id="research-loading" style="display: none; text-align: center; padding: 40px;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 15px; color: #666;">Researching... This may take 30-60 seconds.</p>
                    <p style="font-size: 0.85em; color: #999;">Searching Glassdoor, Levels.fyi, company sites, and more...</p>
                </div>

                <div id="research-results" style="display: none;">
                    <!-- Interview Process -->
                    <div class="input-section" style="border-left: 4px solid #11998e;">
                        <h3>üìã Interview Process</h3>
                        <div id="research-process" style="line-height: 1.8;"></div>
                    </div>

                    <!-- Competencies -->
                    <div class="input-section" style="border-left: 4px solid #667eea;">
                        <h3>üéØ Key Competencies</h3>
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 10px;">These are the competencies this company evaluates. Click "Use These" to set them as your target competencies.</p>
                        <div id="research-competencies" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;"></div>
                        <button class="btn btn-primary btn-sm" onclick="useResearchedCompetencies()">Use These Competencies</button>
                    </div>

                    <!-- Common Questions -->
                    <div class="input-section" style="border-left: 4px solid #ff6b6b;">
                        <h3>‚ùì Common Interview Questions</h3>
                        <div id="research-questions"></div>
                    </div>

                    <!-- Insider Tips -->
                    <div class="input-section" style="border-left: 4px solid #ffd93d;">
                        <h3>üí° Insider Tips</h3>
                        <div id="research-tips"></div>
                    </div>

                    <!-- Mental Model -->
                    <div class="input-section" style="border-left: 4px solid #6c5ce7;">
                        <h3>üß† Mental Model</h3>
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 10px;">How to think about this company and what they're looking for.</p>
                        <div id="research-mental-model"></div>
                    </div>

                    <!-- Actions -->
                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="saveResearchResults()">üíæ Save to Notes</button>
                        <button class="btn btn-secondary" onclick="exportResearchResults()">üì§ Export as PDF</button>
                        <button class="btn btn-secondary" onclick="clearResearchResults()">üóëÔ∏è Clear Results</button>
                    </div>
                </div>

                <!-- Saved Research -->
                <div id="saved-research-section" style="margin-top: 30px;">
                    <h3>üìÅ Saved Research</h3>
                    <div id="saved-research-list" style="margin-top: 10px;"></div>
                </div>
            </div>

            <!-- TAB: Settings (NEW) -->
            <div id="settings" class="section">
                <div class="intro-box">
                    <h2>‚öôÔ∏è Settings</h2>
                    <p>Configure your interview coach, manage API keys, and customize competencies for your target company.</p>
                </div>

                <!-- API Key Section -->
                <div class="input-section">
                    <h3>üîë API Configuration</h3>
                    <p style="color: #666; margin-bottom: 15px;">Your API key is stored locally in your browser.</p>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <input type="password" id="settings-api-key" placeholder="sk-ant-api03-..." style="flex: 1; min-width: 300px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: monospace;">
                        <button class="btn btn-primary" onclick="updateApiKey()">Save Key</button>
                        <button class="btn btn-danger" onclick="clearApiKey()">Clear Key</button>
                    </div>
                    <div id="settings-api-status" style="margin-top: 10px;"></div>
                </div>

                <!-- Company/Competencies Section -->
                <div class="input-section">
                    <h3>üè¢ Target Company & Competencies</h3>
                    <p style="color: #666; margin-bottom: 15px;">Customize competencies for your target company. These will be used throughout the app instead of default Leadership Principles.</p>

                    <div style="margin-bottom: 15px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Company Preset</label>
                        <select id="company-preset" onchange="loadCompanyPreset()" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                            <option value="amazon">Amazon (Leadership Principles)</option>
                            <option value="google">Google (Googleyness)</option>
                            <option value="meta">Meta (Core Values)</option>
                            <option value="microsoft">Microsoft (Growth Mindset)</option>
                            <option value="custom">Custom Company</option>
                        </select>
                    </div>

                    <div id="custom-company-section" style="display: none; margin-top: 15px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Company Name</label>
                        <input type="text" id="custom-company-name" placeholder="e.g., Stripe, Airbnb" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px;">

                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Competencies (one per line)</label>
                        <textarea id="custom-competencies" rows="8" placeholder="e.g.,
Customer Focus
Ownership
Analytical Thinking
Communication
Collaboration" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;"></textarea>
                    </div>

                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="saveCompanySettings()">üíæ Save Company Settings</button>
                        <button class="btn btn-secondary" onclick="resetCompanySettings()">Reset to Default</button>
                    </div>

                    <div id="current-competencies" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <strong>Current Competencies:</strong>
                        <div id="competencies-list" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    </div>
                </div>

                <!-- Data Management Section -->
                <div class="input-section">
                    <h3>üì¶ Data Management</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="exportAllData()">üì§ Export All Data</button>
                        <button class="btn btn-secondary" onclick="importAllData()">üì• Import Data</button>
                        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                    </div>
                    <input type="file" id="import-data-file" accept=".json" style="display: none;" onchange="handleDataImport(event)">
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        const APP_VERSION = '3.0';

        // Company presets for competencies
        const COMPANY_PRESETS = {
            amazon: {
                name: 'Amazon',
                competencies: ['Customer Obsession', 'Ownership', 'Invent and Simplify', 'Are Right, A Lot',
                    'Learn and Be Curious', 'Hire and Develop the Best', 'Insist on the Highest Standards',
                    'Think Big', 'Bias for Action', 'Frugality', 'Earn Trust', 'Dive Deep',
                    'Have Backbone; Disagree and Commit', 'Deliver Results']
            },
            google: {
                name: 'Google',
                competencies: ['Googleyness', 'General Cognitive Ability', 'Role-Related Knowledge',
                    'Leadership', 'Problem Solving', 'Communication', 'Collaboration']
            },
            meta: {
                name: 'Meta',
                competencies: ['Move Fast', 'Be Bold', 'Focus on Impact', 'Be Open', 'Build Social Value']
            },
            microsoft: {
                name: 'Microsoft',
                competencies: ['Growth Mindset', 'Customer Obsession', 'Diversity and Inclusion',
                    'One Microsoft', 'Making a Difference']
            }
        };

        // Dynamic competencies - loaded from storage or default to Amazon LPs
        let CURRENT_COMPETENCIES = COMPANY_PRESETS.amazon.competencies;
        let CURRENT_COMPANY = 'Amazon';

        // For backward compatibility, also keep this
        const LEADERSHIP_PRINCIPLES = [
            'Dive Deep', 'Ownership', 'Invent & Simplify', 'Learn & Be Curious',
            'Deliver Results', 'Earn Trust', 'Have Backbone', 'Bias for Action',
            'Customer Obsession', 'Think Big', 'Frugality', 'Hire & Develop'
        ];

        // ==================== BYOK API KEY MANAGEMENT ====================
        let API_KEY = null;

        function getApiKey() {
            if (API_KEY) return API_KEY;
            API_KEY = localStorage.getItem('anthropic_api_key');
            return API_KEY;
        }

        function setApiKey(key) {
            API_KEY = key;
            localStorage.setItem('anthropic_api_key', key);
        }

        function hasApiKey() {
            return !!getApiKey();
        }

        function showApiKeyModal() {
            const modal = document.getElementById('byok-modal');
            const input = document.getElementById('byok-api-key-input');
            modal.style.display = 'flex';
            if (getApiKey()) {
                input.value = getApiKey();
            }
        }

        function saveApiKey() {
            const key = document.getElementById('byok-api-key-input').value.trim();
            if (!key) {
                alert('Please enter an API key');
                return;
            }
            if (!key.startsWith('sk-ant-')) {
                alert('Invalid API key format. Anthropic API keys start with "sk-ant-"');
                return;
            }
            setApiKey(key);
            document.getElementById('byok-modal').style.display = 'none';
            updateApiStatus();
            // Also update settings page if visible
            const settingsInput = document.getElementById('settings-api-key');
            if (settingsInput) settingsInput.value = key;
        }

        function skipApiKey() {
            document.getElementById('byok-modal').style.display = 'none';
            updateApiStatus();
        }

        function updateApiKey() {
            const key = document.getElementById('settings-api-key').value.trim();
            if (!key) {
                alert('Please enter an API key');
                return;
            }
            if (!key.startsWith('sk-ant-')) {
                alert('Invalid API key format. Anthropic API keys start with "sk-ant-"');
                return;
            }
            setApiKey(key);
            updateApiStatus();
            const statusEl = document.getElementById('settings-api-status');
            statusEl.innerHTML = '<span style="color: green;">API key saved successfully.</span>';
            setTimeout(() => { statusEl.innerHTML = ''; }, 3000);
        }

        function clearApiKey() {
            if (!confirm('Clear your API key? AI features will be disabled.')) return;
            localStorage.removeItem('anthropic_api_key');
            API_KEY = null;
            document.getElementById('settings-api-key').value = '';
            updateApiStatus();
        }

        function updateApiStatus() {
            const statusDiv = document.getElementById('api-status');
            const statusText = document.getElementById('api-status-text');

            if (hasApiKey()) {
                statusDiv.style.display = 'block';
                const maskedKey = getApiKey().substring(0, 12) + '...' + getApiKey().slice(-4);
                statusText.textContent = 'API: ' + maskedKey;
                statusText.style.background = 'rgba(76, 175, 80, 0.3)';
            } else {
                statusDiv.style.display = 'block';
                statusText.textContent = 'No API Key (Limited Mode)';
                statusText.style.background = 'rgba(255, 152, 0, 0.3)';
            }
        }

        // Wrapper for all Claude API calls - adds authentication
        async function callClaudeAPI(messages, maxTokens = 4000, model = 'claude-sonnet-4-5-20250929') {
            const apiKey = getApiKey();
            if (!apiKey) {
                throw new Error('No API key configured. Go to Settings to add your Anthropic API key.');
            }

            const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": apiKey,
                    "anthropic-version": "2023-06-01",
                    "anthropic-dangerous-direct-browser-access": "true"
                },
                body: JSON.stringify({
                    model: model,
                    max_tokens: maxTokens,
                    messages: messages
                })
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                if (response.status === 401) {
                    throw new Error('Invalid API key. Please check your key in Settings.');
                }
                throw new Error(error.error?.message || `API error: ${response.status}`);
            }

            return await response.json();
        }

        // ==================== COMPANY/COMPETENCY SETTINGS ====================
        async function loadCompanySettings() {
            const settings = await storage.load('company_settings');
            if (settings) {
                CURRENT_COMPANY = settings.company || 'Amazon';
                CURRENT_COMPETENCIES = settings.competencies || COMPANY_PRESETS.amazon.competencies;

                // Update subtitle
                const subtitle = document.getElementById('header-subtitle');
                if (subtitle && settings.company !== 'Amazon') {
                    subtitle.textContent = `Interview Preparation for ${settings.company}`;
                }
            }
            renderCompetenciesList();
        }

        function loadCompanyPreset() {
            const preset = document.getElementById('company-preset').value;
            const customSection = document.getElementById('custom-company-section');

            if (preset === 'custom') {
                customSection.style.display = 'block';
            } else {
                customSection.style.display = 'none';
                const companyData = COMPANY_PRESETS[preset];
                if (companyData) {
                    CURRENT_COMPANY = companyData.name;
                    CURRENT_COMPETENCIES = companyData.competencies;
                    renderCompetenciesList();
                }
            }
        }

        async function saveCompanySettings() {
            const preset = document.getElementById('company-preset').value;

            if (preset === 'custom') {
                const customName = document.getElementById('custom-company-name').value.trim();
                const customCompetencies = document.getElementById('custom-competencies').value
                    .split('\n')
                    .map(c => c.trim())
                    .filter(c => c);

                if (!customName) {
                    alert('Please enter a company name');
                    return;
                }
                if (customCompetencies.length < 3) {
                    alert('Please enter at least 3 competencies');
                    return;
                }

                CURRENT_COMPANY = customName;
                CURRENT_COMPETENCIES = customCompetencies;
            } else {
                const companyData = COMPANY_PRESETS[preset];
                CURRENT_COMPANY = companyData.name;
                CURRENT_COMPETENCIES = companyData.competencies;
            }

            await storage.save('company_settings', {
                company: CURRENT_COMPANY,
                competencies: CURRENT_COMPETENCIES,
                preset: preset
            });

            // Update subtitle
            const subtitle = document.getElementById('header-subtitle');
            if (subtitle) {
                subtitle.textContent = `Interview Preparation for ${CURRENT_COMPANY}`;
            }

            renderCompetenciesList();
            alert(`Settings saved for ${CURRENT_COMPANY}`);
        }

        async function resetCompanySettings() {
            if (!confirm('Reset to Amazon Leadership Principles?')) return;

            CURRENT_COMPANY = 'Amazon';
            CURRENT_COMPETENCIES = COMPANY_PRESETS.amazon.competencies;

            await storage.save('company_settings', {
                company: 'Amazon',
                competencies: COMPANY_PRESETS.amazon.competencies,
                preset: 'amazon'
            });

            document.getElementById('company-preset').value = 'amazon';
            document.getElementById('custom-company-section').style.display = 'none';

            const subtitle = document.getElementById('header-subtitle');
            if (subtitle) {
                subtitle.textContent = 'Complete Interview Preparation System';
            }

            renderCompetenciesList();
        }

        function renderCompetenciesList() {
            const container = document.getElementById('competencies-list');
            if (!container) return;

            container.innerHTML = CURRENT_COMPETENCIES.map(c =>
                `<span style="background: var(--color-primary); color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.85em;">${c}</span>`
            ).join('');
        }

        // ==================== TIMELINE FUNCTIONS ====================
        async function loadTimelineStorySelector() {
            const stories = await storage.load('stories') || {};
            const select = document.getElementById('timeline-story-select');
            if (!select) return;

            select.innerHTML = '<option value="">-- Select a story --</option>';
            Object.keys(stories).forEach(storyId => {
                const option = document.createElement('option');
                option.value = storyId;
                option.textContent = stories[storyId].title || storyId;
                select.appendChild(option);
            });
        }

        async function loadTimeline() {
            const storyId = document.getElementById('timeline-story-select').value;
            const container = document.getElementById('timeline-container');
            const empty = document.getElementById('timeline-empty');

            if (!storyId) {
                container.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            container.style.display = 'block';
            empty.style.display = 'none';

            const stories = await storage.load('stories') || {};
            const story = stories[storyId];

            if (!story || !story.nodes || story.nodes.length === 0) {
                document.getElementById('timeline-mermaid').innerHTML = '<p style="color: #666; text-align: center;">No nodes found. Add events in the Story Web tab first.</p>';
                return;
            }

            generateMermaidTimeline(story);
            generateTimelineDetails(story);
        }

        function regenerateTimeline() {
            loadTimeline();
        }

        function generateMermaidTimeline(story) {
            const nodes = story.nodes || [];
            const starOrder = ['situation', 'task', 'action', 'result'];

            // Sort nodes by STAR component
            const sortedNodes = [...nodes].sort((a, b) =>
                starOrder.indexOf(a.starComponent) - starOrder.indexOf(b.starComponent)
            );

            // Generate Mermaid Gantt syntax
            let mermaidCode = `gantt
    title ${story.title || 'Story Timeline'}
    dateFormat YYYY-MM-DD
    axisFormat Day %e
`;

            // Group by STAR component
            const byComponent = {situation: [], task: [], action: [], result: []};
            sortedNodes.forEach(node => {
                if (byComponent[node.starComponent]) {
                    byComponent[node.starComponent].push(node);
                }
            });

            let dayCounter = 1;
            const sectionNames = {
                situation: 'SITUATION',
                task: 'TASK',
                action: 'ACTION',
                result: 'RESULT'
            };

            Object.keys(byComponent).forEach(component => {
                const componentNodes = byComponent[component];
                if (componentNodes.length === 0) return;

                mermaidCode += `\n    section ${sectionNames[component]}\n`;

                componentNodes.forEach((node, idx) => {
                    const title = (node.eventTitle || 'Event').replace(/:/g, ' ').substring(0, 40);
                    const duration = component === 'action' ? 2 : 1;
                    const style = component === 'result' ? 'done, ' : (component === 'situation' ? 'crit, ' : '');

                    mermaidCode += `    ${title} :${style}node${dayCounter}, 2000-01-${String(dayCounter).padStart(2, '0')}, ${duration}d\n`;
                    dayCounter += duration;
                });
            });

            // Render Mermaid
            const container = document.getElementById('timeline-mermaid');
            container.innerHTML = `<pre class="mermaid">${mermaidCode}</pre>`;

            // Initialize Mermaid
            if (window.mermaid) {
                mermaid.initialize({
                    startOnLoad: true,
                    theme: 'default',
                    gantt: {
                        titleTopMargin: 25,
                        barHeight: 30,
                        barGap: 8,
                        fontSize: 14
                    }
                });
                mermaid.contentLoaded();
            }
        }

        function generateTimelineDetails(story) {
            const nodes = story.nodes || [];
            const container = document.getElementById('timeline-details');

            if (nodes.length === 0) {
                container.innerHTML = '';
                return;
            }

            const starEmojis = {
                situation: 'üèîÔ∏è',
                task: 'üéØ',
                action: '‚ö°',
                result: 'üíé'
            };

            container.innerHTML = `
                <h3 style="margin-bottom: 15px;">üìã Event Details</h3>
                <table style="width: 100%; border-collapse: collapse; font-size: 15px;">
                    <tr style="background: #232f3e; color: white;">
                        <th style="padding: 12px; text-align: left;">Phase</th>
                        <th style="padding: 12px; text-align: left;">Event</th>
                        <th style="padding: 12px; text-align: left;">Key Details</th>
                    </tr>
                    ${nodes.map(node => `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px;">
                                <span style="background: var(--color-${node.starComponent}); padding: 4px 10px; border-radius: 15px; font-size: 0.85em;">
                                    ${starEmojis[node.starComponent] || ''} ${node.starComponent?.charAt(0).toUpperCase() + node.starComponent?.slice(1)}
                                </span>
                            </td>
                            <td style="padding: 12px;">
                                <strong>${node.visual?.anchor?.emoji || ''} ${node.eventTitle || 'Event'}</strong>
                                <br><span style="color: #666; font-size: 0.9em;">${node.visual?.anchor?.keyword || ''}</span>
                            </td>
                            <td style="padding: 12px; font-size: 0.9em;">
                                ${node.dimensions?.problem ? `<div><strong>Problem:</strong> ${node.dimensions.problem.substring(0, 100)}...</div>` : ''}
                                ${node.dimensions?.metrics ? `<div><strong>Metrics:</strong> ${node.dimensions.metrics}</div>` : ''}
                                ${(node.leadershipPrinciples || []).length > 0 ? `
                                    <div style="margin-top: 5px;">
                                        ${node.leadershipPrinciples.slice(0, 2).map(lp =>
                                            `<span style="background: #e0e0e0; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-right: 5px;">${lp}</span>`
                                        ).join('')}
                                    </div>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </table>
            `;
        }

        // ==================== DATA MANAGEMENT ====================
        async function exportAllData() {
            const data = {
                version: APP_VERSION,
                exportedAt: new Date().toISOString(),
                stories: await storage.load('stories') || {},
                practice_history: await storage.load('practice_history') || {},
                user_resume: await storage.load('user_resume') || null,
                target_job: await storage.load('target_job') || null,
                company_settings: await storage.load('company_settings') || null,
                preferences: await storage.load('preferences') || {}
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `interview-coach-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importAllData() {
            document.getElementById('import-data-file').click();
        }

        async function handleDataImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                if (!data.version) {
                    alert('Invalid backup file format');
                    return;
                }

                if (!confirm('This will replace all your current data. Continue?')) {
                    return;
                }

                if (data.stories) await storage.save('stories', data.stories);
                if (data.practice_history) await storage.save('practice_history', data.practice_history);
                if (data.user_resume) await storage.save('user_resume', data.user_resume);
                if (data.target_job) await storage.save('target_job', data.target_job);
                if (data.company_settings) await storage.save('company_settings', data.company_settings);
                if (data.preferences) await storage.save('preferences', data.preferences);

                alert('Data imported successfully! Reloading...');
                window.location.reload();
            } catch (err) {
                alert('Error importing data: ' + err.message);
            }
        }

        async function clearAllData() {
            if (!confirm('DELETE ALL DATA?\n\nThis will permanently remove all stories, practice history, and settings. This cannot be undone!')) {
                return;
            }

            const confirmation = prompt('Type "delete" to confirm:');
            if (confirmation !== 'delete') {
                alert('Deletion cancelled.');
                return;
            }

            localStorage.clear();
            alert('All data cleared. Reloading...');
            window.location.reload();
        }

        // ==================== COMPANY RESEARCH ====================
        let currentResearchData = null;

        async function startCompanyResearch() {
            const company = document.getElementById('research-company').value.trim();
            const role = document.getElementById('research-role').value.trim();
            const context = document.getElementById('research-context').value.trim();

            if (!company || !role) {
                alert('Please enter both company name and role.');
                return;
            }

            if (!hasApiKey()) {
                alert('API key required for research. Please add your key in Settings.');
                showSection('settings');
                return;
            }

            // Show loading
            document.getElementById('research-loading').style.display = 'block';
            document.getElementById('research-results').style.display = 'none';

            try {
                const researchPrompt = `You are an expert career coach helping someone prepare for a behavioral interview at ${company} for a ${role} position.${context ? ` Additional context: ${context}` : ''}

Please research and provide comprehensive, ACCURATE information about interviewing at this company. Use your knowledge of this company's interview process, culture, and what they look for in candidates.

Provide your response in the following JSON format:
{
    "company": "${company}",
    "role": "${role}",
    "interview_process": {
        "overview": "Brief description of the interview process",
        "stages": ["Stage 1: ...", "Stage 2: ...", ...],
        "duration": "Typical timeline",
        "format": "Remote/onsite/hybrid details"
    },
    "competencies": ["Competency 1", "Competency 2", ...],
    "common_questions": [
        {"question": "...", "category": "behavioral/technical/situational", "tips": "..."},
        ...
    ],
    "insider_tips": [
        "Tip 1...",
        "Tip 2...",
        ...
    ],
    "mental_model": {
        "what_they_value": "What this company fundamentally values in candidates",
        "how_to_stand_out": "Key differentiators that make candidates successful",
        "common_mistakes": "What to avoid in interviews",
        "success_profile": "Profile of a successful candidate"
    },
    "sources": ["Source 1", "Source 2", ...]
}

Be specific to ${company} and the ${role} role. Include real competencies/principles this company uses (like Amazon's Leadership Principles, Google's Googleyness, etc.). Make the tips actionable and specific.`;

                const data = await callClaudeAPI([{
                    role: "user",
                    content: researchPrompt
                }], 4000);

                const responseText = data.content[0].text;

                // Parse JSON from response
                const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('Could not parse research results');
                }

                currentResearchData = JSON.parse(jsonMatch[0]);
                displayResearchResults(currentResearchData);

            } catch (err) {
                console.error('Research error:', err);
                alert('Error researching company: ' + err.message);
            } finally {
                document.getElementById('research-loading').style.display = 'none';
            }
        }

        function displayResearchResults(data) {
            document.getElementById('research-results').style.display = 'block';

            // Interview Process
            const processDiv = document.getElementById('research-process');
            processDiv.innerHTML = `
                <p><strong>Overview:</strong> ${data.interview_process?.overview || 'Not available'}</p>
                <p><strong>Duration:</strong> ${data.interview_process?.duration || 'Varies'}</p>
                <p><strong>Format:</strong> ${data.interview_process?.format || 'Varies'}</p>
                ${data.interview_process?.stages ? `
                    <p><strong>Stages:</strong></p>
                    <ol style="margin-left: 20px;">
                        ${data.interview_process.stages.map(s => `<li>${s}</li>`).join('')}
                    </ol>
                ` : ''}
            `;

            // Competencies
            const compDiv = document.getElementById('research-competencies');
            compDiv.innerHTML = (data.competencies || []).map(c =>
                `<span style="background: var(--color-primary); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.9em;">${c}</span>`
            ).join('');

            // Questions
            const questionsDiv = document.getElementById('research-questions');
            questionsDiv.innerHTML = (data.common_questions || []).map((q, i) => `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <strong>${i + 1}. ${q.question}</strong>
                        <span style="background: ${q.category === 'behavioral' ? '#667eea' : q.category === 'technical' ? '#11998e' : '#ff6b6b'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75em;">${q.category}</span>
                    </div>
                    ${q.tips ? `<p style="color: #666; font-size: 0.9em; margin-top: 8px;">üí° ${q.tips}</p>` : ''}
                </div>
            `).join('');

            // Tips
            const tipsDiv = document.getElementById('research-tips');
            tipsDiv.innerHTML = `<ul style="line-height: 2;">
                ${(data.insider_tips || []).map(t => `<li>${t}</li>`).join('')}
            </ul>`;

            // Mental Model
            const mentalDiv = document.getElementById('research-mental-model');
            const mm = data.mental_model || {};
            mentalDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #2e7d32; margin-bottom: 8px;">‚úÖ What They Value</h4>
                        <p style="font-size: 0.9em;">${mm.what_they_value || 'Research needed'}</p>
                    </div>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #1565c0; margin-bottom: 8px;">‚≠ê How to Stand Out</h4>
                        <p style="font-size: 0.9em;">${mm.how_to_stand_out || 'Research needed'}</p>
                    </div>
                    <div style="background: #ffebee; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #c62828; margin-bottom: 8px;">‚ö†Ô∏è Common Mistakes</h4>
                        <p style="font-size: 0.9em;">${mm.common_mistakes || 'Research needed'}</p>
                    </div>
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                        <h4 style="color: #7b1fa2; margin-bottom: 8px;">üéØ Success Profile</h4>
                        <p style="font-size: 0.9em;">${mm.success_profile || 'Research needed'}</p>
                    </div>
                </div>
            `;
        }

        async function useResearchedCompetencies() {
            if (!currentResearchData || !currentResearchData.competencies) {
                alert('No competencies found in research results.');
                return;
            }

            CURRENT_COMPANY = currentResearchData.company;
            CURRENT_COMPETENCIES = currentResearchData.competencies;

            await storage.save('company_settings', {
                company: CURRENT_COMPANY,
                competencies: CURRENT_COMPETENCIES,
                preset: 'custom'
            });

            // Update subtitle
            const subtitle = document.getElementById('header-subtitle');
            if (subtitle) {
                subtitle.textContent = `Interview Preparation for ${CURRENT_COMPANY}`;
            }

            renderCompetenciesList();
            alert(`Competencies updated for ${CURRENT_COMPANY}!`);
        }

        async function saveResearchResults() {
            if (!currentResearchData) {
                alert('No research results to save.');
                return;
            }

            const savedResearch = await storage.load('saved_research') || [];
            savedResearch.push({
                ...currentResearchData,
                savedAt: new Date().toISOString()
            });
            await storage.save('saved_research', savedResearch);

            alert('Research saved!');
            loadSavedResearch();
        }

        async function loadSavedResearch() {
            const savedResearch = await storage.load('saved_research') || [];
            const container = document.getElementById('saved-research-list');

            if (savedResearch.length === 0) {
                container.innerHTML = '<p style="color: #666;">No saved research yet.</p>';
                return;
            }

            container.innerHTML = savedResearch.map((r, i) => `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${r.company}</strong> - ${r.role}
                        <br><span style="color: #666; font-size: 0.85em;">Saved: ${new Date(r.savedAt).toLocaleDateString()}</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm btn-secondary" onclick="loadSavedResearchItem(${i})">Load</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSavedResearch(${i})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadSavedResearchItem(index) {
            const savedResearch = await storage.load('saved_research') || [];
            if (savedResearch[index]) {
                currentResearchData = savedResearch[index];
                displayResearchResults(currentResearchData);
            }
        }

        async function deleteSavedResearch(index) {
            if (!confirm('Delete this saved research?')) return;

            const savedResearch = await storage.load('saved_research') || [];
            savedResearch.splice(index, 1);
            await storage.save('saved_research', savedResearch);
            loadSavedResearch();
        }

        function clearResearchResults() {
            currentResearchData = null;
            document.getElementById('research-results').style.display = 'none';
            document.getElementById('research-company').value = '';
            document.getElementById('research-role').value = '';
            document.getElementById('research-context').value = '';
        }

        function exportResearchResults() {
            if (!currentResearchData) {
                alert('No research results to export.');
                return;
            }

            // Create a simple text export
            const text = `
COMPANY RESEARCH: ${currentResearchData.company}
Role: ${currentResearchData.role}
Generated: ${new Date().toLocaleDateString()}
================================================================================

INTERVIEW PROCESS
-----------------
${currentResearchData.interview_process?.overview || 'N/A'}
Duration: ${currentResearchData.interview_process?.duration || 'N/A'}
Format: ${currentResearchData.interview_process?.format || 'N/A'}

Stages:
${(currentResearchData.interview_process?.stages || []).map((s, i) => `${i + 1}. ${s}`).join('\n')}

KEY COMPETENCIES
----------------
${(currentResearchData.competencies || []).join(', ')}

COMMON QUESTIONS
----------------
${(currentResearchData.common_questions || []).map((q, i) => `${i + 1}. [${q.category}] ${q.question}\n   Tip: ${q.tips || 'N/A'}`).join('\n\n')}

INSIDER TIPS
------------
${(currentResearchData.insider_tips || []).map((t, i) => `${i + 1}. ${t}`).join('\n')}

MENTAL MODEL
------------
What They Value: ${currentResearchData.mental_model?.what_they_value || 'N/A'}
How to Stand Out: ${currentResearchData.mental_model?.how_to_stand_out || 'N/A'}
Common Mistakes: ${currentResearchData.mental_model?.common_mistakes || 'N/A'}
Success Profile: ${currentResearchData.mental_model?.success_profile || 'N/A'}
            `.trim();

            const blob = new Blob([text], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentResearchData.company}-${currentResearchData.role}-research.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Comprehensive question bank
        const QUESTION_BANK = {
            'Dive Deep': [
                "Tell me about a time you had to analyze complex data to identify the root cause of a problem.",
                "Describe a situation where you needed to dive deep into details that others had overlooked.",
                "Give me an example of when you had to investigate a recurring issue in your financial reporting.",
                "Tell me about a time you had to validate data accuracy when the numbers didn't make sense.",
                "Describe when you used data analysis to uncover insights that changed a business decision.",
                "Give me an example of how you've used variance analysis to drive action.",
                "Tell me about a time you had to trace a financial discrepancy to its source.",
                "Describe a situation where you questioned assumptions in a financial model."
            ],
            'Ownership': [
                "Tell me about a time you took ownership of a problem that wasn't assigned to you.",
                "Describe a situation where you had to own the outcome even when things went wrong.",
                "Give me an example of when you owned an end-to-end process improvement.",
                "Tell me about a time you took responsibility for a financial reporting failure.",
                "Describe when you proactively identified and fixed a process gap.",
                "Tell me about a time you owned a project that required influence without authority.",
                "Give me an example of when you took ownership of stakeholder relationships.",
                "Describe a situation where you had to own both the strategy and execution of a financial initiative."
            ],
            'Invent & Simplify': [
                "Tell me about a time you automated a manual process.",
                "Describe when you simplified a complex reporting structure.",
                "Give me an example of an innovative solution you created for a financial challenge.",
                "Tell me about a time you eliminated unnecessary steps in a workflow.",
                "Describe how you've used technology to improve financial operations.",
                "Tell me about a time you replaced a complex process with a simpler approach.",
                "Give me an example of when you standardized inconsistent reporting.",
                "Describe an invention or tool you created that others now use."
            ],
            'Learn & Be Curious': [
                "Tell me about a time you had to learn a new tool or technology quickly.",
                "Describe when you sought out knowledge outside your core expertise.",
                "Give me an example of how continuous learning helped you solve a problem.",
                "Tell me about a time you learned from a failure.",
                "Describe when curiosity led you to discover an important insight.",
                "Tell me about a new skill you developed to improve your performance.",
                "Give me an example of when you shared knowledge to help your team learn.",
                "Describe how you stay current with FP&A best practices."
            ],
            'Deliver Results': [
                "Tell me about a time you delivered results under tight constraints.",
                "Describe when you had to deliver a critical project despite obstacles.",
                "Give me an example of how you prioritized to meet a critical deadline.",
                "Tell me about a time you exceeded expectations on a deliverable.",
                "Describe a situation where you had to deliver results with limited resources.",
                "Tell me about the most significant result you've delivered in your career.",
                "Give me an example of when you delivered results while managing competing priorities.",
                "Describe how you've measured and communicated the impact of your work."
            ],
            'Earn Trust': [
                "Tell me about a time you had to deliver difficult news to senior leadership.",
                "Describe when you built trust with a skeptical stakeholder.",
                "Give me an example of how you've maintained transparency in challenging situations.",
                "Tell me about a time you admitted a mistake and how you handled it.",
                "Describe when you had to rebuild trust after a setback.",
                "Tell me about how you've built credibility with cross-functional partners.",
                "Give me an example of when you gave candid feedback to leadership.",
                "Describe a situation where integrity was tested and how you responded."
            ],
            'Have Backbone': [
                "Tell me about a time you disagreed with a decision and how you handled it.",
                "Describe when you pushed back on a senior leader's direction.",
                "Give me an example of when you challenged the status quo.",
                "Tell me about a time you had to make an unpopular decision.",
                "Describe when you stood firm on a position despite pressure to change.",
                "Tell me about a time you escalated a concern that others were ignoring.",
                "Give me an example of when you disagreed and committed.",
                "Describe a situation where you advocated for what was right, not what was easy."
            ],
            'Bias for Action': [
                "Tell me about a time you made a decision with incomplete information.",
                "Describe when you had to act quickly in a crisis situation.",
                "Give me an example of when calculated risk-taking led to success.",
                "Tell me about a time you moved forward despite uncertainty.",
                "Describe when you took action while others were still debating.",
                "Tell me about a time you experimented to test a hypothesis.",
                "Give me an example of when speed of execution was critical.",
                "Describe a situation where you had to balance speed with accuracy."
            ]
        };

        let currentStory = '';
        let conversationHistory = [];
        let currentDrill = null;
        let audioRecorder = null;
        let audioBlob = null;
        let timerInterval = null;
        let currentTimerSeconds = 0;
        let starTimings = {situation: 0, task: 0, action: 0, result: 0};
        let currentComponent = 'situation';

        // ==================== STORAGE MANAGER ====================
        class StorageManager {
            async save(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (err) {
                    console.error('Storage save error:', err);
                    return false;
                }
            }

            async load(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (err) {
                    console.error('Storage load error:', err);
                    return null;
                }
            }

            async delete(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (err) {
                    console.error('Storage delete error:', err);
                    return false;
                }
            }

            async cleanupOldSessions() {
                const history = await this.load('practice_history') || {sessions: [], stats: {}};
                if (history.sessions.length > 100) {
                    const recent = history.sessions.slice(-100);
                    const older = history.sessions.slice(0, -100);
                    
                    // Aggregate older sessions to stats
                    older.forEach(session => {
                        if (!history.stats.byLP) history.stats.byLP = {};
                        if (!history.stats.byLP[session.lp]) {
                            history.stats.byLP[session.lp] = {practiced: 0, totalScore: 0, avgScore: 0};
                        }
                        history.stats.byLP[session.lp].practiced++;
                        history.stats.byLP[session.lp].totalScore += session.score;
                    });

                    // Recalculate averages
                    Object.keys(history.stats.byLP).forEach(lp => {
                        history.stats.byLP[lp].avgScore = 
                            history.stats.byLP[lp].totalScore / history.stats.byLP[lp].practiced;
                    });

                    history.sessions = recent;
                    await this.save('practice_history', history);
                }
            }
        }

        const storage = new StorageManager();
        
        // Custom confirm dialog (because native confirm() may be blocked in iframes)
        function customConfirm(message) {
            return new Promise((resolve) => {
                const modalHtml = `
                    <div id="custom-confirm-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px;">
                        <div style="background: white; border-radius: 12px; padding: 25px; max-width: 400px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                            <div style="font-size: 2em; margin-bottom: 15px;">‚ö†Ô∏è</div>
                            <p style="margin: 0 0 20px; font-size: 1.1em; color: #333;">${message}</p>
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button id="confirm-cancel-btn" style="padding: 10px 25px; border: 2px solid #ccc; background: white; border-radius: 8px; cursor: pointer; font-size: 1em;">Cancel</button>
                                <button id="confirm-ok-btn" style="padding: 10px 25px; border: none; background: #dc3545; color: white; border-radius: 8px; cursor: pointer; font-size: 1em;">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                const modal = document.getElementById('custom-confirm-modal');
                const okBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                
                okBtn.onclick = () => {
                    modal.remove();
                    resolve(true);
                };
                
                cancelBtn.onclick = () => {
                    modal.remove();
                    resolve(false);
                };
                
                // Also close on backdrop click
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(false);
                    }
                };
            });
        }

        // ==================== INITIALIZATION ====================
        async function initializeApp() {
            await migrateData();
            await populateLPSelectors();
            await loadStoriesIntoSelectors();
            await loadTimelineStorySelector();
            await loadResumeStatus();
            await loadJobStatus();
            await loadCompanySettings();
            await loadSavedResearch();
            await refreshGuide();

            // Check for API key on first load
            updateApiStatus();
            if (!hasApiKey()) {
                // Show BYOK modal after a short delay
                setTimeout(() => {
                    showApiKeyModal();
                }, 500);
            }

            // Populate settings page if API key exists
            const settingsInput = document.getElementById('settings-api-key');
            if (settingsInput && hasApiKey()) {
                settingsInput.value = getApiKey();
            }

            // Initialize Mermaid
            if (window.mermaid) {
                mermaid.initialize({ startOnLoad: false, theme: 'default' });
            }
        }

        async function migrateData() {
            const version = await storage.load('app_version');
            if (!version || version !== APP_VERSION) {
                console.log('Migrating to v' + APP_VERSION + '...');
                await storage.save('app_version', APP_VERSION);
                
                // Initialize new storage structures
                const history = await storage.load('practice_history');
                if (!history) {
                    await storage.save('practice_history', {sessions: [], stats: {byLP: {}, byStory: {}}});
                }
                
                const queue = await storage.load('review_queue');
                if (!queue) {
                    await storage.save('review_queue', []);
                }
                
                const prefs = await storage.load('preferences');
                if (!prefs) {
                    await storage.save('preferences', {
                        timerVisible: true,
                        recordAudio: true,
                        selectedLPs: ['Dive Deep', 'Ownership', 'Deliver Results']
                    });
                }
            }
        }
        
        // ==================== RESUME FUNCTIONS ====================
        async function loadResumeStatus() {
            const resume = await storage.load('user_resume');
            const statusEl = document.getElementById('resume-status');
            const inputEl = document.getElementById('resume-input');
            
            if (resume && resume.text) {
                statusEl.textContent = `‚úì Saved (${resume.text.length} chars)`;
                statusEl.style.background = 'rgba(255,255,255,0.2)';
                statusEl.style.padding = '3px 8px';
                statusEl.style.borderRadius = '10px';
                if (inputEl) inputEl.value = resume.text;
            } else {
                statusEl.textContent = 'Not saved';
            }
        }
        
        function toggleResumeSection() {
            const section = document.getElementById('resume-section');
            const icon = document.getElementById('resume-toggle-icon');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                section.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        async function saveResume() {
            const text = document.getElementById('resume-input').value.trim();
            const statusEl = document.getElementById('resume-save-status');
            const headerStatusEl = document.getElementById('resume-status');
            
            if (!text) {
                statusEl.style.display = 'inline-block';
                statusEl.style.background = '#ffebee';
                statusEl.style.color = '#c62828';
                statusEl.textContent = '‚ùå Please enter resume text';
                setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
                return;
            }
            
            await storage.save('user_resume', {
                text: text,
                savedAt: new Date().toISOString()
            });
            
            // Show success
            statusEl.style.display = 'inline-block';
            statusEl.style.background = '#e8f5e9';
            statusEl.style.color = '#2e7d32';
            statusEl.textContent = '‚úì Resume saved!';
            setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
            
            // Update header status
            headerStatusEl.textContent = `‚úì Saved (${text.length} chars)`;
            headerStatusEl.style.background = 'rgba(255,255,255,0.2)';
            headerStatusEl.style.padding = '3px 8px';
            headerStatusEl.style.borderRadius = '10px';
        }
        
        async function clearResume() {
            const confirmResult = await customConfirm('Clear your saved resume?');
            if (!confirmResult) return;
            
            document.getElementById('resume-input').value = '';
            await storage.save('user_resume', null);
            
            const statusEl = document.getElementById('resume-status');
            statusEl.textContent = 'Not saved';
            statusEl.style.background = '';
            statusEl.style.padding = '';
        }
        
        async function getResumeContext() {
            const resume = await storage.load('user_resume');
            if (resume && resume.text) {
                // Return truncated version for prompts (max 1500 chars)
                return resume.text.substring(0, 1500);
            }
            return null;
        }
        // ==================== END RESUME FUNCTIONS ====================
        
        // ==================== JOB POSTING FUNCTIONS ====================
        async function loadJobStatus() {
            const job = await storage.load('target_job');
            const statusEl = document.getElementById('job-status');
            const urlInput = document.getElementById('job-url-input');
            const titleInput = document.getElementById('job-title-input');
            const descInput = document.getElementById('job-description-input');
            
            if (job && job.description) {
                statusEl.textContent = `‚úì ${job.title || 'Saved'}`;
                statusEl.style.background = 'rgba(255,255,255,0.2)';
                statusEl.style.padding = '3px 8px';
                statusEl.style.borderRadius = '10px';
                if (urlInput) urlInput.value = job.url || '';
                if (titleInput) titleInput.value = job.title || '';
                if (descInput) descInput.value = job.description || '';
                
                // Show analysis if exists
                if (job.analysis) {
                    showJobAnalysis(job.analysis);
                }
            } else {
                statusEl.textContent = 'Not saved';
            }
        }
        
        function toggleJobSection() {
            const section = document.getElementById('job-section');
            const icon = document.getElementById('job-toggle-icon');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                section.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        async function saveJobPosting() {
            const url = document.getElementById('job-url-input').value.trim();
            const title = document.getElementById('job-title-input').value.trim();
            const description = document.getElementById('job-description-input').value.trim();
            const statusEl = document.getElementById('job-save-status');
            const headerStatusEl = document.getElementById('job-status');
            
            if (!description) {
                statusEl.style.display = 'inline-block';
                statusEl.style.background = '#ffebee';
                statusEl.style.color = '#c62828';
                statusEl.textContent = '‚ùå Please enter job description';
                setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
                return;
            }
            
            // Show analyzing status
            statusEl.style.display = 'inline-block';
            statusEl.style.background = '#e3f2fd';
            statusEl.style.color = '#1565c0';
            statusEl.textContent = 'üîÑ Analyzing job...';
            
            try {
                // Analyze job posting with AI
                const analysis = await analyzeJobPosting(title, description);
                
                await storage.save('target_job', {
                    url: url,
                    title: title,
                    description: description,
                    analysis: analysis,
                    savedAt: new Date().toISOString()
                });
                
                // Show success
                statusEl.style.background = '#e8f5e9';
                statusEl.style.color = '#2e7d32';
                statusEl.textContent = '‚úì Job saved & analyzed!';
                setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
                
                // Update header status
                headerStatusEl.textContent = `‚úì ${title || 'Saved'}`;
                headerStatusEl.style.background = 'rgba(255,255,255,0.2)';
                headerStatusEl.style.padding = '3px 8px';
                headerStatusEl.style.borderRadius = '10px';
                
                // Show analysis
                showJobAnalysis(analysis);
                
                // Update Guide tab
                await refreshGuide();
                
            } catch (err) {
                console.error('Job analysis error:', err);
                
                // Save without analysis
                await storage.save('target_job', {
                    url: url,
                    title: title,
                    description: description,
                    savedAt: new Date().toISOString()
                });
                
                statusEl.style.background = '#fff3e0';
                statusEl.style.color = '#e65100';
                statusEl.textContent = '‚ö†Ô∏è Saved (analysis failed)';
                setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
            }
        }
        
        async function analyzeJobPosting(title, description) {
            const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                body: JSON.stringify({
                    model: "claude-sonnet-4-5-20250929",
                    max_tokens: 1500,
                    messages: [{
                        role: "user",
                        content: `Analyze this Amazon job posting and extract key insights for interview preparation.

JOB TITLE: ${title || 'Not specified'}

JOB DESCRIPTION:
${description.substring(0, 2000)}

Respond ONLY with valid JSON:
{
  "level": "L4/L5/L6/L7 (infer from title and responsibilities)",
  "team_focus": "Brief description of what this team does",
  "key_skills": ["Skill 1", "Skill 2", "Skill 3", "Skill 4", "Skill 5"],
  "top_lps": ["Most relevant LP 1", "LP 2", "LP 3", "LP 4"],
  "likely_questions": [
    "Specific behavioral question they might ask based on this JD",
    "Another likely question",
    "Third question"
  ],
  "things_to_emphasize": [
    "What candidate should emphasize in their stories",
    "Another thing to highlight"
  ],
  "red_flags_to_avoid": [
    "What might be a concern for this role",
    "Another potential red flag"
  ]
}`
                    }]
                })
            });
            
            const data = await response.json();
            const text = data.content[0].text.replace(/```json|```/g, "").trim();
            return JSON.parse(text);
        }
        
        function showJobAnalysis(analysis) {
            const container = document.getElementById('job-analysis-container');
            const content = document.getElementById('job-analysis-content');
            
            if (!analysis) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            content.innerHTML = `
                <div style="margin-bottom: 12px;">
                    <strong>üìä Level:</strong> ${analysis.level || 'Unknown'}
                    <span style="margin-left: 15px;"><strong>üè¢ Team Focus:</strong> ${analysis.team_focus || 'Unknown'}</span>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <strong>üîß Key Skills:</strong><br>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                        ${(analysis.key_skills || []).map(s => `<span style="background: #e3f2fd; padding: 3px 10px; border-radius: 12px; font-size: 0.85em;">${s}</span>`).join('')}
                    </div>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <strong>üéØ Top LPs to Focus:</strong><br>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                        ${(analysis.top_lps || []).map(lp => {
                            const lpClass = lp.toLowerCase().replace(/ /g, '-').replace(/&/g, '');
                            return `<span class="lp-tag ${lpClass}" style="font-size: 0.8em;">${lp}</span>`;
                        }).join('')}
                    </div>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <strong>‚ùì Likely Questions:</strong>
                    <ul style="margin: 5px 0 0 20px; padding: 0;">
                        ${(analysis.likely_questions || []).map(q => `<li style="margin-bottom: 5px;">${q}</li>`).join('')}
                    </ul>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <strong>‚úÖ Emphasize in Stories:</strong>
                    <ul style="margin: 5px 0 0 20px; padding: 0;">
                        ${(analysis.things_to_emphasize || []).map(t => `<li style="margin-bottom: 5px;">${t}</li>`).join('')}
                    </ul>
                </div>
                
                <div>
                    <strong>‚ö†Ô∏è Avoid/Address:</strong>
                    <ul style="margin: 5px 0 0 20px; padding: 0;">
                        ${(analysis.red_flags_to_avoid || []).map(r => `<li style="margin-bottom: 5px;">${r}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        async function clearJobPosting() {
            const confirmResult = await customConfirm('Clear saved job posting?');
            if (!confirmResult) return;
            
            document.getElementById('job-url-input').value = '';
            document.getElementById('job-title-input').value = '';
            document.getElementById('job-description-input').value = '';
            await storage.save('target_job', null);
            
            const statusEl = document.getElementById('job-status');
            statusEl.textContent = 'Not saved';
            statusEl.style.background = '';
            statusEl.style.padding = '';
            
            document.getElementById('job-analysis-container').style.display = 'none';
        }
        
        async function getJobContext() {
            const job = await storage.load('target_job');
            if (job && job.description) {
                return {
                    title: job.title,
                    description: job.description.substring(0, 1000),
                    analysis: job.analysis
                };
            }
            return null;
        }
        // ==================== END JOB POSTING FUNCTIONS ====================
        
        // ==================== GUIDE FUNCTIONS ====================
        async function refreshGuide() {
            const jobContext = await getJobContext();
            
            const jobSection = document.getElementById('guide-job-section');
            const defaultSection = document.getElementById('guide-default-section');
            
            if (jobContext && jobContext.analysis) {
                const analysis = jobContext.analysis;
                
                // Show job-specific section, hide default
                jobSection.style.display = 'block';
                defaultSection.style.display = 'none';
                
                // Populate job title
                document.getElementById('guide-job-title').textContent = jobContext.title || 'Amazon Role';
                
                // Populate top LPs
                const lpsContainer = document.getElementById('guide-top-lps');
                lpsContainer.innerHTML = (analysis.top_lps || []).map((lp, i) => {
                    const lpClass = lp.toLowerCase().replace(/ /g, '-').replace(/&/g, '');
                    return `<span class="lp-tag ${lpClass}" style="margin-right: 8px;">${i + 1}. ${lp}</span>`;
                }).join('');
                
                // Populate key skills
                const skillsContainer = document.getElementById('guide-key-skills');
                skillsContainer.innerHTML = (analysis.key_skills || []).map(skill => 
                    `<span style="background: #e3f2fd; padding: 5px 12px; border-radius: 15px; font-size: 0.9em;">${skill}</span>`
                ).join('');
                
                // Populate things to emphasize
                const emphasizeList = document.getElementById('guide-emphasize');
                emphasizeList.innerHTML = (analysis.things_to_emphasize || []).map(item => 
                    `<li>${item}</li>`
                ).join('');
                
                // Populate red flags
                const redFlagsList = document.getElementById('guide-red-flags');
                redFlagsList.innerHTML = (analysis.red_flags_to_avoid || []).map(item => 
                    `<li>${item}</li>`
                ).join('');
                
                // Populate likely questions
                const questionsList = document.getElementById('guide-likely-questions');
                questionsList.innerHTML = (analysis.likely_questions || []).map(q => 
                    `<li>${q}</li>`
                ).join('');
                
            } else {
                // Show default section, hide job-specific
                jobSection.style.display = 'none';
                defaultSection.style.display = 'block';
            }
        }
        // ==================== END GUIDE FUNCTIONS ====================

        function populateLPSelectors() {
            const drillLPs = document.getElementById('drill-lp-selection');
            const eventLPs = document.getElementById('event-lps');
            
            LEADERSHIP_PRINCIPLES.forEach(lp => {
                const lpClass = lp.toLowerCase().replace(/ /g, '-').replace(/&/g, '').replace(/,/g, '');
                
                // Drill selector
                const drillItem = document.createElement('div');
                drillItem.className = 'checkbox-item';
                drillItem.innerHTML = `
                    <input type="checkbox" id="drill-lp-${lpClass}" value="${lp}">
                    <label for="drill-lp-${lpClass}">${lp}</label>
                `;
                drillLPs.appendChild(drillItem);
                
                // Event selector
                const eventItem = document.createElement('div');
                eventItem.className = 'checkbox-item';
                eventItem.innerHTML = `
                    <input type="checkbox" id="event-lp-${lpClass}" value="${lp}">
                    <label for="event-lp-${lpClass}">${lp}</label>
                `;
                eventLPs.appendChild(eventItem);
            });
        }

        async function loadStoriesIntoSelectors() {
            const stories = await storage.load('stories') || {};
            const selectors = [
                document.getElementById('web-story-select'),
                document.getElementById('drill-story-select'),
                document.getElementById('timeline-story-select')
            ];

            selectors.forEach(select => {
                if (select) {
                    select.innerHTML = '<option value="">-- Select story --</option>';
                    Object.keys(stories).forEach(storyId => {
                        const option = document.createElement('option');
                        option.value = storyId;
                        option.textContent = stories[storyId].title || storyId;
                        select.appendChild(option);
                    });
                }
            });
        }

        // ==================== TAB NAVIGATION ====================
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        // ==================== TAB 1: STORY ANALYZER ====================
        async function analyzeStory() {
            const story = document.getElementById('story-input').value.trim();
            if (!story) {
                alert('Please paste your story first!');
                return;
            }

            currentStory = story;
            const loading = document.getElementById('story-loading');
            const results = document.getElementById('story-results');

            loading.classList.add('show');
            results.classList.remove('show');

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 8000,
                        messages: [{
                            role: "user",
                            content: `Analyze this ${CURRENT_COMPANY} interview story and generate a complete story web structure.

STORY: ${story}

Respond ONLY with valid JSON (no markdown, no backticks):
{
  "title": "Short 4-7 word title (e.g., 'S3 Cost Optimization for Finance Team')",
  "meatiness_score": 8,
  "overall_feedback": "2-3 sentence assessment...",
  "depth_indicators": {
    "metrics_count": 5,
    "technical_depth": "high/medium/low",
    "cross_functional": true,
    "executive_visibility": true
  },
  "leadership_principles": ["Dive Deep", "Ownership"],
  "follow_up_potential": ["Specific follow-up Q1?", "Specific follow-up Q2?", "Specific follow-up Q3?"],
  "story_web": {
    "nodes": [
      {
        "id": "node_1",
        "eventTitle": "Short event title (3-6 words)",
        "starComponent": "situation|task|action|result",
        "dimensions": {
          "stakeholders": ["Person/Team 1", "Person/Team 2"],
          "problem": "The specific challenge, pain point, or context - be concrete with numbers if possible",
          "solution": "REQUIRED: What was done or decided - every node should have this filled",
          "alternatives": "REQUIRED: 2-3 other options that could have been considered (infer reasonable alternatives even if not explicitly stated)",
          "metrics": "Specific numbers, percentages, dollar amounts, time saved - extract or estimate realistic ones",
          "tradeoffs": "REQUIRED: What was sacrificed or risked by this choice (e.g., speed vs quality, cost vs features, short-term vs long-term)"
        },
        "visual": {
          "anchor": {
            "emoji": "üìä",
            "keyword": "One memorable word"
          }
        },
        "leadershipPrinciples": ["Relevant LP 1", "Relevant LP 2"]
      }
    ],
    "connections": [
      {"from": "node_1", "to": "node_2", "label": "led to"}
    ]
  }
}

CRITICAL INSTRUCTIONS:
1. Extract 4-8 distinct events from the story (one per major beat)
2. Assign each to the correct STAR component (usually 1 Situation, 1 Task, 2-4 Actions, 1-2 Results)
3. Pick memorable emojis that create visual anchors for recall
4. Keywords should be unique, concrete nouns (not generic words)
5. Connect nodes to show causal flow
6. Only include LPs that are genuinely demonstrated in that specific event
7. NEVER leave solution, alternatives, or tradeoffs empty - these are critical for interview depth
8. For alternatives: think "what else could they have done?" (e.g., outsource, buy vs build, do nothing, different approach)
9. For tradeoffs: think "what did they give up?" (e.g., took longer but higher quality, cost more but more scalable)
10. If the story doesn't explicitly mention something, INFER reasonable values based on context`
                        }]
                    })
                });

                const data = await response.json();
                const text = data.content[0].text.replace(/```json|```/g, "").trim();
                const analysis = JSON.parse(text);
                
                // Auto-save the analyzed story with generated web to storage
                const storyId = 'story_' + Date.now();
                const stories = await storage.load('stories') || {};
                
                // Add unique IDs with timestamps to nodes
                const nodes = (analysis.story_web?.nodes || []).map((node, idx) => ({
                    ...node,
                    id: 'node_' + Date.now() + '_' + idx
                }));
                
                stories[storyId] = {
                    id: storyId,
                    title: analysis.title || 'Untitled Story',
                    rawText: story,
                    analysis: analysis,
                    nodes: nodes,
                    connections: analysis.story_web?.connections || [],
                    createdAt: new Date().toISOString()
                };
                await storage.save('stories', stories);
                await loadStoriesIntoSelectors();
                
                // Store the new story ID for the "Build Story Web" button
                window.lastAnalyzedStoryId = storyId;
                
                displayStoryAnalysis(analysis, storyId, nodes.length);
            } catch (error) {
                console.error('Error:', error);
                alert('Error analyzing story. Check console for details.');
            } finally {
                loading.classList.remove('show');
            }
        }

        function displayStoryAnalysis(analysis, storyId, nodeCount) {
            const results = document.getElementById('story-results');
            results.innerHTML = `
                <div class="evaluation-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Story Depth Analysis</h3>
                        <span style="background: var(--color-success); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85em;">
                            ‚úÖ Saved: "${analysis.title}"
                        </span>
                    </div>
                    <div class="score-display">${analysis.meatiness_score}/10</div>
                    <p>${analysis.overall_feedback}</p>
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-value">${analysis.depth_indicators.metrics_count}</div>
                            <div class="stat-label">Specific Metrics</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${analysis.depth_indicators.technical_depth}</div>
                            <div class="stat-label">Technical Depth</div>
                        </div>
                    </div>
                    <h4>Leadership Principles Demonstrated:</h4>
                    <div style="margin: 15px 0;">
                        ${analysis.leadership_principles.map(lp => {
                            const lpClass = lp.toLowerCase().replace(/ /g, '-').replace(/&/g, '');
                            return `<span class="lp-tag ${lpClass}">${lp}</span>`;
                        }).join('')}
                    </div>
                    <div class="highlight-box">
                        <strong>üéØ Prepare for these follow-ups:</strong>
                        <ul style="margin-top: 10px;">
                            ${analysis.follow_up_potential.map(q => `<li>${q}</li>`).join('')}
                        </ul>
                    </div>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee; background: linear-gradient(135deg, #f0f9f0 0%, #e8f5e8 100%); padding: 20px; border-radius: 10px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 2em;">üï∏Ô∏è</div>
                            <div style="flex: 1;">
                                <strong style="font-size: 1.1em;">Story Web Auto-Generated!</strong>
                                <p style="margin: 5px 0 0; color: #666;">
                                    ${nodeCount || 0} event nodes created with visual anchors, dimensions, and LP mappings
                                </p>
                            </div>
                            <button class="btn btn-primary" onclick="goToStoryWebBuilder('${storyId}')" style="white-space: nowrap;">
                                View Story Web ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            `;
            results.classList.add('show');
        }

        function clearStoryAnalyzer() {
            document.getElementById('story-input').value = '';
            document.getElementById('story-results').classList.remove('show');
        }
        
        async function showStoryManager() {
            console.log('showStoryManager called');
            const stories = await storage.load('stories') || {};
            const storyKeys = Object.keys(stories);
            console.log('Found', storyKeys.length, 'stories:', storyKeys);
            
            let storyListHtml = '';
            if (storyKeys.length === 0) {
                storyListHtml = `<div style="text-align: center; padding: 30px; color: #666;">
                    <p>No saved stories yet.</p>
                    <p style="font-size: 0.9em;">Analyze a story in Tab 1 to save it.</p>
                </div>`;
            } else {
                storyListHtml = storyKeys.map(key => {
                    const story = stories[key];
                    const nodeCount = story.nodes?.length || 0;
                    const chipCount = story.nodes?.reduce((sum, n) => sum + (n.detailChips?.length || 0), 0) || 0;
                    const createdDate = story.createdAt ? new Date(story.createdAt).toLocaleDateString() : 'Unknown';
                    
                    return `
                        <div style="background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 12px;" id="story-item-${key}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <h4 style="margin: 0 0 8px;">${story.title || 'Untitled Story'}</h4>
                                    <div style="display: flex; gap: 15px; font-size: 0.85em; color: #666;">
                                        <span>üìÖ ${createdDate}</span>
                                        <span>üîò ${nodeCount} nodes</span>
                                        <span>üè∑Ô∏è ${chipCount} chips</span>
                                        ${story.meatiness_score ? `<span>üìä ${story.meatiness_score}/10 meatiness</span>` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="event.stopPropagation(); viewStoryInWeb('${key}')" class="btn btn-sm btn-primary">View</button>
                                    <button onclick="event.stopPropagation(); deleteStoryFromManager('${key}')" class="btn btn-sm btn-danger">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            const modalHtml = `
                <div id="story-manager-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px;" onclick="if(event.target === this) this.remove()">
                    <div style="background: #f8f9fa; border-radius: 15px; padding: 25px; width: 100%; max-width: 600px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0;">üìö Manage Saved Stories</h3>
                            <button onclick="document.getElementById('story-manager-modal').remove()" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">√ó</button>
                        </div>
                        
                        <div style="margin-bottom: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; font-size: 0.9em;">
                            ‚ö†Ô∏è Deleting a story removes all its nodes and detail chips permanently.
                        </div>
                        
                        <div id="story-list">
                            ${storyListHtml}
                        </div>
                        
                        ${storyKeys.length > 0 ? `
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #ddd;">
                            <button onclick="exportAllStories()" class="btn btn-sm btn-secondary">üì§ Export All Stories</button>
                            <button onclick="confirmDeleteAllStories()" class="btn btn-sm btn-danger" style="margin-left: 10px;">üóëÔ∏è Delete All</button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        async function deleteStory(storyId) {
            console.log('deleteStory called with:', storyId);
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            
            const confirmResult = await customConfirm(`Delete "${story?.title || storyId}"?\n\nThis will remove all nodes and detail chips.`);
            if (!confirmResult) {
                console.log('Delete cancelled by user');
                return;
            }
            
            delete stories[storyId];
            await storage.save('stories', stories);
            console.log('Story deleted from storage');
            
            // Remove from UI
            document.getElementById(`story-item-${storyId}`)?.remove();
            
            // Refresh selectors
            await loadStoriesIntoSelectors();
            
            // If viewing this story in web builder, clear it
            if (window.currentWebStoryId === storyId) {
                document.getElementById('web-editor').style.display = 'none';
                document.getElementById('web-story-select').value = '';
                window.currentWebStoryId = null;
            }
            console.log('deleteStory completed');
        }
        
        async function deleteStoryFromManager(storyId) {
            try {
                console.log('deleteStoryFromManager called with:', storyId);
                const stories = await storage.load('stories') || {};
                const story = stories[storyId];
                console.log('Story found:', story?.title);
                
                const confirmResult = await customConfirm(`Delete "${story?.title || storyId}"?\n\nThis will remove all nodes and detail chips.`);
                if (!confirmResult) {
                    console.log('Delete cancelled by user');
                    return;
                }
                
                delete stories[storyId];
                await storage.save('stories', stories);
                console.log('Story deleted from storage');
                
                // Remove from modal UI
                const storyItem = document.getElementById(`story-item-${storyId}`);
                console.log('Story item element:', storyItem);
                if (storyItem) {
                    storyItem.remove();
                    console.log('Story item removed from DOM');
                }
                
                // Refresh selectors
                await loadStoriesIntoSelectors();
                
                // If viewing this story in web builder, clear it
                if (window.currentWebStoryId === storyId) {
                    document.getElementById('web-editor').style.display = 'none';
                    document.getElementById('web-story-select').value = '';
                    window.currentWebStoryId = null;
                }
                
                // If no stories left, show empty message
                const storyList = document.getElementById('story-list');
                if (storyList && Object.keys(stories).length === 0) {
                    storyList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No stories saved yet. Analyze a story to get started!</p>';
                }
                console.log('deleteStoryFromManager completed');
            } catch (err) {
                console.error('deleteStoryFromManager error:', err);
                alert('Error deleting story: ' + err.message);
            }
        }
        
        async function deleteCurrentStory() {
            console.log('deleteCurrentStory called');
            console.log('window.currentWebStoryId:', window.currentWebStoryId);
            const storyId = window.currentWebStoryId;
            if (!storyId) {
                alert('No story selected.');
                return;
            }
            await deleteStory(storyId);
        }
        
        async function viewStoryInWeb(storyId) {
            document.getElementById('story-manager-modal')?.remove();
            await goToStoryWebBuilder(storyId);
        }
        
        async function exportAllStories() {
            const stories = await storage.load('stories') || {};
            const exportData = {
                version: '2.0',
                exportedAt: new Date().toISOString(),
                stories: stories
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `all-stories-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        async function confirmDeleteAllStories() {
            if (!confirm('DELETE ALL STORIES?\n\nThis will permanently remove all your saved stories, nodes, and chips. This cannot be undone!\n\nConsider exporting first.')) {
                return;
            }
            
            if (!confirm('Are you absolutely sure? Type "delete" in the next prompt to confirm.')) {
                return;
            }
            
            const confirmation = prompt('Type "delete" to confirm:');
            if (confirmation !== 'delete') {
                alert('Deletion cancelled.');
                return;
            }
            
            await storage.save('stories', {});
            await loadStoriesIntoSelectors();
            document.getElementById('story-manager-modal')?.remove();
            alert('All stories deleted.');
        }

        async function goToStoryWebBuilder(storyId) {
            // Switch to Tab 2 (Story Web Builder)
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById('web-builder').classList.add('active');
            document.querySelectorAll('.nav-tab')[1].classList.add('active');
            
            // Select the story in the dropdown
            const select = document.getElementById('web-story-select');
            select.value = storyId;
            
            // Load and display the story
            await loadStoryWeb();
            
            // Show the raw text in a helpful way
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (story && story.rawText) {
                // Scroll to the editor
                document.getElementById('web-editor').scrollIntoView({behavior: 'smooth'});
            }
        }

        // ==================== TAB 2: STORY WEB BUILDER ====================
        function createNewStory() {
            const title = prompt('Story title:');
            if (!title) return;
            
            const storyId = 'story_' + Date.now();
            document.getElementById('web-story-select').value = storyId;
            document.getElementById('web-editor').style.display = 'block';
        }

        async function loadStoryWeb() {
            const storyId = document.getElementById('web-story-select').value;
            const rawStoryRef = document.getElementById('raw-story-reference');
            const rawStoryContent = document.getElementById('raw-story-content');
            const modeToggle = document.getElementById('mode-toggle-container');
            
            if (!storyId) {
                document.getElementById('web-editor').style.display = 'none';
                modeToggle.style.display = 'none';
                return;
            }
            document.getElementById('web-editor').style.display = 'block';
            modeToggle.style.display = 'block';
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId] || {id: storyId, nodes: [], connections: []};
            
            // Update story title
            document.getElementById('web-story-title').textContent = story.title || 'Story Web';
            
            // Store current story for other functions
            window.currentWebStory = story;
            window.currentWebStoryId = storyId;
            
            // Reset practice state when loading new story
            window.practiceState = {};
            window.practiceScore = {got: 0, missed: 0};
            if (typeof updatePracticeScore === 'function') updatePracticeScore();
            
            // Setup raw story text (hidden by default)
            if (story.rawText) {
                rawStoryContent.textContent = story.rawText;
            }
            rawStoryRef.style.display = 'none';
            document.getElementById('manual-node-editor').style.display = 'none';
            
            // Ensure practice UI reflects current mode
            const isPractice = window.webMode === 'practice';
            document.getElementById('practice-instructions').style.display = isPractice ? 'block' : 'none';
            document.getElementById('practice-score').style.display = isPractice ? 'block' : 'none';
            
            renderWebCanvas(story);
        }
        
        function toggleRawStory() {
            const ref = document.getElementById('raw-story-reference');
            ref.style.display = ref.style.display === 'none' ? 'block' : 'none';
        }
        
        function toggleManualEditor() {
            const editor = document.getElementById('manual-node-editor');
            const isHidden = editor.style.display === 'none';
            editor.style.display = isHidden ? 'block' : 'none';
            
            // Scroll to editor if opening
            if (isHidden) {
                setTimeout(() => {
                    editor.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }
        
        function showNodeDetail(node) {
            const modal = document.getElementById('node-detail-modal');
            const content = document.getElementById('node-detail-content');
            
            // Store current node for editing
            window.currentEditingNode = node;
            
            const starColors = {
                situation: 'var(--color-situation)',
                task: 'var(--color-task)',
                action: 'var(--color-action)',
                result: 'var(--color-result)'
            };
            
            const starEmojis = {
                situation: 'üèîÔ∏è',
                task: 'üéØ',
                action: '‚ö°',
                result: 'üíé'
            };
            
            const allLPs = ['Dive Deep', 'Ownership', 'Invent and Simplify', 'Learn and Be Curious', 
                           'Deliver Results', 'Earn Trust', 'Have Backbone', 'Bias for Action'];
            
            const chips = node.detailChips || [];
            
            content.innerHTML = `
                <div id="node-view-mode">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <span style="font-size: 2.5em;">${node.visual?.anchor?.emoji || 'üìå'}</span>
                        <div style="flex: 1;">
                            <h2 style="margin: 0;">${node.eventTitle}</h2>
                            <span style="background: ${starColors[node.starComponent]}; padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                                ${starEmojis[node.starComponent]} ${node.starComponent.charAt(0).toUpperCase() + node.starComponent.slice(1)}
                            </span>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="toggleNodeEditMode(true)">‚úèÔ∏è Edit</button>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <strong>üîë Memory Anchor:</strong> "${node.visual?.anchor?.keyword || 'N/A'}"
                    </div>
                    
                    ${node.dimensions ? `
                    <h4 style="margin-top: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">üìã Event Dimensions</h4>
                    <table style="width: 100%; border-collapse: collapse;">
                        ${node.dimensions.stakeholders?.length ? `<tr><td style="padding: 8px; border-bottom: 1px solid #eee; width: 120px; color: #666;"><strong>Stakeholders</strong></td><td style="padding: 8px; border-bottom: 1px solid #eee;">${Array.isArray(node.dimensions.stakeholders) ? node.dimensions.stakeholders.join(', ') : node.dimensions.stakeholders}</td></tr>` : ''}
                        ${node.dimensions.problem ? `<tr><td style="padding: 8px; border-bottom: 1px solid #eee; color: #666;"><strong>Problem</strong></td><td style="padding: 8px; border-bottom: 1px solid #eee;">${node.dimensions.problem}</td></tr>` : ''}
                        ${node.dimensions.solution ? `<tr><td style="padding: 8px; border-bottom: 1px solid #eee; color: #666;"><strong>Solution</strong></td><td style="padding: 8px; border-bottom: 1px solid #eee;">${node.dimensions.solution}</td></tr>` : ''}
                        ${node.dimensions.alternatives ? `<tr><td style="padding: 8px; border-bottom: 1px solid #eee; color: #666;"><strong>Alternatives</strong></td><td style="padding: 8px; border-bottom: 1px solid #eee;">${node.dimensions.alternatives}</td></tr>` : ''}
                        ${node.dimensions.metrics ? `<tr><td style="padding: 8px; border-bottom: 1px solid #eee; color: #666;"><strong>Metrics</strong></td><td style="padding: 8px; border-bottom: 1px solid #eee;">${node.dimensions.metrics}</td></tr>` : ''}
                        ${node.dimensions.tradeoffs ? `<tr><td style="padding: 8px; border-bottom: 1px solid #eee; color: #666;"><strong>Tradeoffs</strong></td><td style="padding: 8px; border-bottom: 1px solid #eee;">${node.dimensions.tradeoffs}</td></tr>` : ''}
                    </table>
                    ` : ''}
                    
                    ${node.leadershipPrinciples?.length ? `
                    <h4 style="margin-top: 20px;">üéØ Leadership Principles</h4>
                    <div style="margin-top: 10px;">
                        ${node.leadershipPrinciples.map(lp => {
                            const lpClass = lp.toLowerCase().replace(/ /g, '-').replace(/&/g, '');
                            return `<span class="lp-tag ${lpClass}">${lp}</span>`;
                        }).join('')}
                    </div>
                    ` : ''}
                    
                    <!-- DETAIL CHIPS SECTION -->
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #eee;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0;">üè∑Ô∏è Detail Chips</h4>
                            <button class="btn btn-sm btn-success" onclick="showAddChipForm('${node.id}')">+ Add Chip</button>
                        </div>
                        
                        <div id="add-chip-form" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="display: grid; gap: 10px;">
                                <div>
                                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">Type</label>
                                    <select id="new-chip-type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                        <option value="difficulty">üò§ Difficulty / Challenge</option>
                                        <option value="stakeholder">üë• Stakeholder Detail</option>
                                        <option value="detail">üìù Additional Detail</option>
                                        <option value="insight">üí° Insight / Learning</option>
                                        <option value="metric">üìä Specific Metric</option>
                                        <option value="followup">üí¨ Follow-up Answer</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">Title (short)</label>
                                    <input type="text" id="new-chip-title" placeholder="e.g., 'VP pushback', 'Cost savings'" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">Content</label>
                                    <textarea id="new-chip-content" rows="3" placeholder="Full details you want to remember..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;"></textarea>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-sm btn-success" onclick="saveNewChip('${node.id}')">Save Chip</button>
                                    <button class="btn btn-sm btn-secondary" onclick="hideAddChipForm()">Cancel</button>
                                </div>
                            </div>
                        </div>
                        
                        ${chips.length === 0 ? `
                            <div style="text-align: center; padding: 20px; color: #999; background: #f8f9fa; border-radius: 10px;">
                                <p style="margin: 0;">No detail chips yet.</p>
                                <p style="margin: 5px 0 0; font-size: 0.85em;">Add chips for difficulties, stakeholder nuances, follow-up answer summaries, etc.</p>
                            </div>
                        ` : `
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                ${chips.map((chip, chipIdx) => {
                                    const chipType = CHIP_TYPES[chip.type] || CHIP_TYPES.detail;
                                    return `
                                        <div style="background: ${chipType.color}; padding: 12px 15px; border-radius: 10px; position: relative;" id="chip-${chip.id}">
                                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                                <span style="font-size: 1.5em;">${chipType.emoji}</span>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: bold; margin-bottom: 4px;">${chip.title}</div>
                                                    <div style="font-size: 0.9em; color: #555;">${chip.content}</div>
                                                    ${chip.createdFrom ? `<div style="font-size: 0.75em; color: #888; margin-top: 5px;">From: ${chip.createdFrom}</div>` : ''}
                                                </div>
                                                <div style="display: flex; gap: 5px;">
                                                    <button onclick="event.stopPropagation(); editChip('${node.id}', '${chip.id}')" style="background: white; border: none; padding: 5px 8px; border-radius: 5px; cursor: pointer; font-size: 0.8em;">‚úèÔ∏è</button>
                                                    <button onclick="event.stopPropagation(); moveChipPrompt('${node.id}', '${chip.id}')" style="background: white; border: none; padding: 5px 8px; border-radius: 5px; cursor: pointer; font-size: 0.8em;">‚ÜóÔ∏è</button>
                                                    <button onclick="event.stopPropagation(); deleteChip('${node.id}', '${chip.id}')" style="background: white; border: none; padding: 5px 8px; border-radius: 5px; cursor: pointer; font-size: 0.8em;">üóëÔ∏è</button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                    
                    <!-- LINKED CHILD NODES SECTION -->
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #eee;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0;">üîó Linked Child Nodes</h4>
                            <button class="btn btn-sm btn-primary" onclick="showAddChildNodeForm('${node.id}')">+ Add Child Node</button>
                        </div>
                        
                        <div id="add-child-node-form" style="display: none; background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <span style="font-weight: bold; font-size: 1.05em;">‚ûï Add Child Node</span>
                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="aiSuggestChildNodeFields()">‚ú® AI Brainstorm</button>
                            </div>
                            <div style="display: grid; gap: 10px;">
                                <div>
                                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">Title *</label>
                                    <input type="text" id="new-child-title" placeholder="e.g., 'VP Pushback Details'" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <div style="flex: 1;">
                                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Emoji</label>
                                        <input type="text" id="new-child-emoji" value="üìå" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                    <div style="flex: 2;">
                                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Keyword</label>
                                        <input type="text" id="new-child-keyword" placeholder="Memory anchor" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                </div>
                                <div>
                                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">üë• Stakeholders</label>
                                    <input type="text" id="new-child-stakeholders" placeholder="e.g., 'VP of Ops, Data Team'" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    <div id="suggest-stakeholders" style="display: none; margin-top: 5px;"></div>
                                </div>
                                <div>
                                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">‚ùó Problem / Challenge</label>
                                    <textarea id="new-child-problem" rows="2" placeholder="What was the issue or challenge?" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;"></textarea>
                                    <div id="suggest-problem" style="display: none; margin-top: 5px;"></div>
                                </div>
                                <div>
                                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">‚úÖ Solution / What You Did</label>
                                    <textarea id="new-child-solution" rows="2" placeholder="What happened, what you did..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;"></textarea>
                                    <div id="suggest-solution" style="display: none; margin-top: 5px;"></div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <div style="flex: 1;">
                                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">üîÑ Alternatives</label>
                                        <input type="text" id="new-child-alternatives" placeholder="Other options considered" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                        <div id="suggest-alternatives" style="display: none; margin-top: 5px;"></div>
                                    </div>
                                    <div style="flex: 1;">
                                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">‚öñÔ∏è Tradeoffs</label>
                                        <input type="text" id="new-child-tradeoffs" placeholder="Tradeoffs made" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                        <div id="suggest-tradeoffs" style="display: none; margin-top: 5px;"></div>
                                    </div>
                                </div>
                                <div>
                                    <label style="font-weight: bold; display: block; margin-bottom: 5px;">üìä Metrics</label>
                                    <input type="text" id="new-child-metrics" placeholder="e.g., '40% cost reduction, 2 weeks saved'" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    <div id="suggest-metrics" style="display: none; margin-top: 5px;"></div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-sm btn-primary" onclick="saveNewChildNode('${node.id}')">Save Child Node</button>
                                    <button class="btn btn-sm btn-secondary" onclick="hideAddChildNodeForm()">Cancel</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="child-nodes-list-${node.id}">
                            <!-- Child nodes will be loaded here -->
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; padding-top: 15px; border-top: 2px solid #eee; display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="closeNodeDetail()">Close</button>
                        <button class="btn btn-danger" onclick="deleteNode('${node.id}')" style="margin-left: auto;">üóëÔ∏è Delete Node</button>
                    </div>
                </div>
                
                <div id="node-edit-mode" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">‚úèÔ∏è Edit Event Node</h3>
                        <button class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="aiSuggestNodeFields()">‚ú® AI Brainstorm</button>
                    </div>
                    
                    <div style="display: grid; gap: 12px;">
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Event Title</label>
                            <input type="text" id="edit-event-title" value="${node.eventTitle || ''}" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="font-weight: bold; display: block; margin-bottom: 5px;">STAR Component</label>
                                <select id="edit-star-component" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                                    <option value="situation" ${node.starComponent === 'situation' ? 'selected' : ''}>üèîÔ∏è Situation</option>
                                    <option value="task" ${node.starComponent === 'task' ? 'selected' : ''}>üéØ Task</option>
                                    <option value="action" ${node.starComponent === 'action' ? 'selected' : ''}>‚ö° Action</option>
                                    <option value="result" ${node.starComponent === 'result' ? 'selected' : ''}>üíé Result</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight: bold; display: block; margin-bottom: 5px;">Emoji Anchor</label>
                                <input type="text" id="edit-emoji" value="${node.visual?.anchor?.emoji || ''}" placeholder="üìä" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                            </div>
                        </div>
                        
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Keyword Anchor</label>
                            <input type="text" id="edit-keyword" value="${node.visual?.anchor?.keyword || ''}" placeholder="One memorable word" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        
                        <h4 style="margin-top: 10px; margin-bottom: 5px;">üìã Dimensions</h4>
                        
                        <div>
                            <label style="color: #666; display: block; margin-bottom: 3px;">üë• Stakeholders (comma-separated)</label>
                            <input type="text" id="edit-stakeholders" value="${Array.isArray(node.dimensions?.stakeholders) ? node.dimensions.stakeholders.join(', ') : (node.dimensions?.stakeholders || '')}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            <div id="edit-suggest-stakeholders" style="display: none; margin-top: 5px;"></div>
                        </div>
                        
                        <div>
                            <label style="color: #666; display: block; margin-bottom: 3px;">‚ùó Problem</label>
                            <textarea id="edit-problem" rows="2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">${node.dimensions?.problem || ''}</textarea>
                            <div id="edit-suggest-problem" style="display: none; margin-top: 5px;"></div>
                        </div>
                        
                        <div>
                            <label style="color: #666; display: block; margin-bottom: 3px;">‚úÖ Solution</label>
                            <textarea id="edit-solution" rows="2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">${node.dimensions?.solution || ''}</textarea>
                            <div id="edit-suggest-solution" style="display: none; margin-top: 5px;"></div>
                        </div>
                        
                        <div>
                            <label style="color: #666; display: block; margin-bottom: 3px;">üîÑ Alternatives Considered</label>
                            <textarea id="edit-alternatives" rows="2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">${node.dimensions?.alternatives || ''}</textarea>
                            <div id="edit-suggest-alternatives" style="display: none; margin-top: 5px;"></div>
                        </div>
                        
                        <div>
                            <label style="color: #666; display: block; margin-bottom: 3px;">üìä Metrics</label>
                            <textarea id="edit-metrics" rows="2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">${node.dimensions?.metrics || ''}</textarea>
                            <div id="edit-suggest-metrics" style="display: none; margin-top: 5px;"></div>
                        </div>
                        
                        <div>
                            <label style="color: #666; display: block; margin-bottom: 3px;">‚öñÔ∏è Tradeoffs</label>
                            <textarea id="edit-tradeoffs" rows="2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">${node.dimensions?.tradeoffs || ''}</textarea>
                            <div id="edit-suggest-tradeoffs" style="display: none; margin-top: 5px;"></div>
                        </div>
                        
                        <div>
                            <label style="font-weight: bold; display: block; margin-bottom: 8px;">üéØ Leadership Principles</label>
                            <div id="edit-suggest-lps" style="display: none; margin-bottom: 8px;"></div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${allLPs.map(lp => `
                                    <label style="display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: #f0f0f0; border-radius: 15px; cursor: pointer;">
                                        <input type="checkbox" value="${lp}" class="edit-lp-checkbox" ${(node.leadershipPrinciples || []).includes(lp) ? 'checked' : ''}>
                                        ${lp}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="saveNodeEdits('${node.id}')">üíæ Save Changes</button>
                        <button class="btn btn-secondary" onclick="toggleNodeEditMode(false)">Cancel</button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
            
            // Load child nodes after modal is rendered
            setTimeout(() => loadChildNodesForDetail(node.id), 50);
        }
        
        function toggleNodeEditMode(editMode) {
            document.getElementById('node-view-mode').style.display = editMode ? 'none' : 'block';
            document.getElementById('node-edit-mode').style.display = editMode ? 'block' : 'none';
        }
        
        // Track expanded child nodes state
        window.expandedChildNodes = window.expandedChildNodes || {};
        
        function toggleChildNodes(nodeId, event) {
            event.stopPropagation(); // Don't trigger parent card click
            
            const accordion = document.getElementById(`child-nodes-accordion-${nodeId}`);
            const icon = document.getElementById(`child-toggle-icon-${nodeId}`);
            
            if (!accordion || !icon) return;
            
            const isExpanded = accordion.style.display !== 'none';
            
            if (isExpanded) {
                // Collapse with animation
                accordion.style.maxHeight = accordion.scrollHeight + 'px';
                accordion.style.overflow = 'hidden';
                accordion.style.transition = 'max-height 0.3s ease-out, opacity 0.2s';
                requestAnimationFrame(() => {
                    accordion.style.maxHeight = '0';
                    accordion.style.opacity = '0';
                });
                setTimeout(() => {
                    accordion.style.display = 'none';
                    accordion.style.maxHeight = '';
                    accordion.style.opacity = '';
                    accordion.style.overflow = '';
                }, 300);
                icon.style.transform = 'rotate(0deg)';
                window.expandedChildNodes[nodeId] = false;
            } else {
                // Expand with animation
                accordion.style.display = 'block';
                accordion.style.maxHeight = '0';
                accordion.style.opacity = '0';
                accordion.style.overflow = 'hidden';
                accordion.style.transition = 'max-height 0.3s ease-out, opacity 0.2s';
                requestAnimationFrame(() => {
                    accordion.style.maxHeight = accordion.scrollHeight + 'px';
                    accordion.style.opacity = '1';
                });
                setTimeout(() => {
                    accordion.style.maxHeight = '';
                    accordion.style.overflow = '';
                }, 300);
                icon.style.transform = 'rotate(180deg)';
                window.expandedChildNodes[nodeId] = true;
            }
        }
        
        async function saveNodeEdits(nodeId) {
            const storyId = window.currentWebStoryId;
            if (!storyId) return;
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) return;
            
            const nodeIndex = story.nodes.findIndex(n => n.id === nodeId);
            if (nodeIndex === -1) return;
            
            // Update node with form values
            story.nodes[nodeIndex] = {
                ...story.nodes[nodeIndex],
                eventTitle: document.getElementById('edit-event-title').value,
                starComponent: document.getElementById('edit-star-component').value,
                visual: {
                    anchor: {
                        emoji: document.getElementById('edit-emoji').value,
                        keyword: document.getElementById('edit-keyword').value
                    }
                },
                dimensions: {
                    stakeholders: document.getElementById('edit-stakeholders').value.split(',').map(s => s.trim()).filter(s => s),
                    problem: document.getElementById('edit-problem').value,
                    solution: document.getElementById('edit-solution').value,
                    alternatives: document.getElementById('edit-alternatives').value,
                    metrics: document.getElementById('edit-metrics').value,
                    tradeoffs: document.getElementById('edit-tradeoffs').value
                },
                leadershipPrinciples: Array.from(document.querySelectorAll('.edit-lp-checkbox:checked')).map(cb => cb.value)
            };
            
            await storage.save('stories', stories);
            closeNodeDetail();
            await loadStoryWeb();
        }
        
        async function deleteNode(nodeId) {
            const confirmResult = await customConfirm('Delete this event node? This cannot be undone.');
            if (!confirmResult) return;
            
            const storyId = window.currentWebStoryId;
            if (!storyId) return;
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) return;
            
            // Remove node
            story.nodes = story.nodes.filter(n => n.id !== nodeId);
            
            // Remove any connections involving this node
            story.connections = (story.connections || []).filter(c => c.from !== nodeId && c.to !== nodeId);
            
            await storage.save('stories', stories);
            closeNodeDetail();
            await loadStoryWeb();
        }
        
        function closeNodeDetail() {
            document.getElementById('node-detail-modal').style.display = 'none';
        }
        
        // ==================== CHIP CRUD FUNCTIONS ====================
        function showAddChipForm(nodeId) {
            document.getElementById('add-chip-form').style.display = 'block';
            document.getElementById('new-chip-title').value = '';
            document.getElementById('new-chip-content').value = '';
            document.getElementById('new-chip-type').value = 'detail';
        }
        
        function hideAddChipForm() {
            document.getElementById('add-chip-form').style.display = 'none';
        }
        
        async function saveNewChip(nodeId) {
            const title = document.getElementById('new-chip-title').value.trim();
            const content = document.getElementById('new-chip-content').value.trim();
            const type = document.getElementById('new-chip-type').value;
            
            if (!title || !content) {
                alert('Please fill in both title and content.');
                return;
            }
            
            const storyId = window.currentWebStoryId;
            if (!storyId) return;
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) return;
            
            const nodeIndex = story.nodes.findIndex(n => n.id === nodeId);
            if (nodeIndex === -1) return;
            
            // Initialize chips array if needed
            if (!story.nodes[nodeIndex].detailChips) {
                story.nodes[nodeIndex].detailChips = [];
            }
            
            // Add new chip
            const chip = {
                id: 'chip_' + Date.now(),
                type: type,
                title: title,
                content: content,
                createdAt: new Date().toISOString(),
                createdFrom: null
            };
            
            story.nodes[nodeIndex].detailChips.push(chip);
            await storage.save('stories', stories);
            
            // Refresh modal
            closeNodeDetail();
            showNodeDetail(story.nodes[nodeIndex]);
            await loadStoryWeb();
        }
        
        // ==================== CHILD NODE FUNCTIONS ====================
        function showAddChildNodeForm(parentId) {
            document.getElementById('add-child-node-form').style.display = 'block';
            document.getElementById('new-child-title').value = '';
            document.getElementById('new-child-emoji').value = 'üìå';
            document.getElementById('new-child-keyword').value = '';
            document.getElementById('new-child-stakeholders').value = '';
            document.getElementById('new-child-problem').value = '';
            document.getElementById('new-child-solution').value = '';
            document.getElementById('new-child-alternatives').value = '';
            document.getElementById('new-child-tradeoffs').value = '';
            document.getElementById('new-child-metrics').value = '';
            window.addingChildToParentId = parentId;
        }
        
        function hideAddChildNodeForm() {
            document.getElementById('add-child-node-form').style.display = 'none';
        }
        
        async function saveNewChildNode(parentId) {
            const title = document.getElementById('new-child-title').value.trim();
            const emoji = document.getElementById('new-child-emoji').value.trim() || 'üìå';
            const keyword = document.getElementById('new-child-keyword').value.trim();
            const stakeholders = document.getElementById('new-child-stakeholders').value.trim();
            const problem = document.getElementById('new-child-problem').value.trim();
            const solution = document.getElementById('new-child-solution').value.trim();
            const alternatives = document.getElementById('new-child-alternatives').value.trim();
            const tradeoffs = document.getElementById('new-child-tradeoffs').value.trim();
            const metrics = document.getElementById('new-child-metrics').value.trim();
            
            if (!title) {
                alert('Please enter a title for the child node.');
                return;
            }
            
            const storyId = window.currentWebStoryId;
            if (!storyId) return;
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) return;
            
            // Find parent node to inherit STAR component
            const parentNode = story.nodes.find(n => n.id === parentId);
            if (!parentNode) {
                alert('Parent node not found.');
                return;
            }
            
            // Create child node linked to parent
            const childNode = {
                id: 'node_' + Date.now(),
                parentId: parentId,
                eventTitle: title,
                starComponent: parentNode.starComponent, // Inherit from parent
                dimensions: {
                    stakeholders: stakeholders ? stakeholders.split(',').map(s => s.trim()) : [],
                    problem: problem,
                    solution: solution,
                    metrics: metrics,
                    alternatives: alternatives,
                    tradeoffs: tradeoffs
                },
                visual: {
                    anchor: {
                        emoji: emoji,
                        keyword: keyword || title.split(' ').slice(0, 2).join(' ')
                    }
                },
                leadershipPrinciples: [],
                detailChips: [],
                createdAt: new Date().toISOString(),
                createdFrom: 'Manual child node'
            };
            
            story.nodes.push(childNode);
            await storage.save('stories', stories);
            
            // Refresh
            hideAddChildNodeForm();
            closeNodeDetail();
            showNodeDetail(parentNode);
            await loadStoryWeb();
            
            alert(`‚úÖ Created child node "${title}" linked to "${parentNode.eventTitle}"!`);
        }
        
        async function loadChildNodesForDetail(parentId) {
            const storyId = window.currentWebStoryId;
            if (!storyId) return;
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) return;
            
            // Find all child nodes for this parent
            const childNodes = story.nodes.filter(n => n.parentId === parentId);
            const container = document.getElementById(`child-nodes-list-${parentId}`);
            if (!container) return;
            
            if (childNodes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #999; background: #f8f9fa; border-radius: 10px;">
                        <p style="margin: 0;">No linked child nodes yet.</p>
                        <p style="margin: 5px 0 0; font-size: 0.85em;">Add child nodes for elaborations, sub-events, or detailed breakdowns.</p>
                    </div>
                `;
                return;
            }
            
            const starColors = {
                situation: 'var(--color-situation)',
                task: 'var(--color-task)',
                action: 'var(--color-action)',
                result: 'var(--color-result)'
            };
            
            container.innerHTML = childNodes.map(child => `
                <div style="background: #e3f2fd; padding: 12px 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid ${starColors[child.starComponent] || '#2196F3'};">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <span style="font-size: 1.5em;">${child.visual?.anchor?.emoji || 'üìå'}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 4px;">${child.eventTitle}</div>
                            <div style="font-size: 0.85em; color: #666;">üîë ${child.visual?.anchor?.keyword || '‚Äî'}</div>
                            ${child.dimensions?.metrics ? `<div style="font-size: 0.85em; color: #2e7d32; margin-top: 4px;">üìä <strong>${child.dimensions.metrics}</strong></div>` : ''}
                            ${child.dimensions?.solution ? `<div style="font-size: 0.85em; color: #555; margin-top: 4px;">${child.dimensions.solution.substring(0, 100)}${child.dimensions.solution.length > 100 ? '...' : ''}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="event.stopPropagation(); viewChildNode('${child.id}')" style="background: white; border: none; padding: 5px 8px; border-radius: 5px; cursor: pointer; font-size: 0.8em;" title="View/Edit">‚úèÔ∏è</button>
                            <button onclick="event.stopPropagation(); deleteChildNode('${child.id}', '${parentId}')" style="background: white; border: none; padding: 5px 8px; border-radius: 5px; cursor: pointer; font-size: 0.8em;" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function viewChildNode(childId) {
            const storyId = window.currentWebStoryId;
            if (!storyId) return;
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) return;
            
            const childNode = story.nodes.find(n => n.id === childId);
            if (childNode) {
                closeNodeDetail();
                // Small delay to allow modal to close
                setTimeout(() => showNodeDetail(childNode), 100);
            }
        }
        
        async function deleteChildNode(childId, parentId) {
            try {
                console.log('=== deleteChildNode START ===');
                console.log('childId:', childId);
                console.log('parentId:', parentId);
                
                console.log('Showing custom confirm dialog...');
                const confirmResult = await customConfirm('Delete this child node? This cannot be undone.');
                console.log('confirm result:', confirmResult);
                
                if (!confirmResult) {
                    console.log('User cancelled');
                    return;
                }
                
                console.log('User confirmed, proceeding...');
                
                const storyId = window.currentWebStoryId;
                console.log('storyId:', storyId);
                if (!storyId) {
                    alert('No story selected');
                    return;
                }
                
                console.log('Loading stories from storage...');
                const stories = await storage.load('stories');
                console.log('stories loaded:', stories ? Object.keys(stories).length : 'null');
                if (!stories) {
                    alert('No stories in storage');
                    return;
                }
                
                const story = stories[storyId];
                console.log('story found:', story ? story.title : 'null');
                if (!story) {
                    alert('Story not found');
                    return;
                }
                
                // Remove child node
                const originalLength = story.nodes.length;
                console.log('nodes before:', originalLength);
                story.nodes = story.nodes.filter(n => n.id !== childId);
                console.log('nodes after:', story.nodes.length);
                
                console.log('Saving to storage...');
                await storage.save('stories', stories);
                console.log('Storage saved');
                
                // Refresh
                console.log('Refreshing UI...');
                const parentNode = story.nodes.find(n => n.id === parentId);
                if (parentNode) {
                    closeNodeDetail();
                    showNodeDetail(parentNode);
                }
                await loadStoryWeb();
                console.log('=== deleteChildNode COMPLETE ===');
            } catch (err) {
                console.error('deleteChildNode error:', err);
                console.error('Error stack:', err.stack);
                alert('Error deleting child node: ' + err.message);
            }
        }
        
        async function aiSuggestChildNodeFields() {
            const parentNode = window.currentEditingNode;
            if (!parentNode) {
                alert('No parent node context found.');
                return;
            }
            
            const storyId = window.currentWebStoryId;
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) return;
            
            // Get title if user entered one
            const childTitle = document.getElementById('new-child-title').value.trim();
            
            // Get resume and job context
            const resumeContext = await getResumeContext();
            const jobContext = await getJobContext();
            
            // Show loading state
            const suggestFields = ['stakeholders', 'problem', 'solution', 'alternatives', 'tradeoffs', 'metrics'];
            suggestFields.forEach(field => {
                const el = document.getElementById(`suggest-${field}`);
                if (el) {
                    el.style.display = 'block';
                    el.innerHTML = '<span style="color: #666; font-size: 0.85em;">‚ú® Generating ideas...</span>';
                }
            });
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 2000,
                        messages: [{
                            role: "user",
                            content: `You are helping a candidate brainstorm details for an Amazon behavioral interview story.

CONTEXT:
- Story Title: ${story.title || 'Untitled'}
- Story Summary: ${story.rawText?.substring(0, 500) || 'No raw text'}
- Parent Node: "${parentNode.eventTitle}" (${parentNode.starComponent})
- Parent Problem: ${parentNode.dimensions?.problem || 'Not specified'}
- Parent Solution: ${parentNode.dimensions?.solution || 'Not specified'}
${childTitle ? `- Child Node Title: "${childTitle}"` : ''}
${jobContext ? `
TARGET JOB: ${jobContext.title || 'Amazon Role'}
Key skills needed: ${jobContext.analysis?.key_skills?.join(', ') || 'Not analyzed'}
Top LPs for this role: ${jobContext.analysis?.top_lps?.join(', ') || 'Not analyzed'}
` : ''}
${resumeContext ? `
CANDIDATE'S RESUME (use this to make suggestions realistic and grounded in their actual experience):
${resumeContext}
` : ''}

Generate 2-3 REALISTIC options for each field that the candidate might actually elaborate on. ${jobContext ? 'Tailor suggestions to highlight skills relevant to their target role.' : ''} ${resumeContext ? 'Use their resume to suggest specific stakeholders, metrics, and approaches that align with their actual experience.' : ''} These should be plausible extensions of the story, not hallucinations.

Respond ONLY with valid JSON:
{
  "stakeholders": ["Option 1 (role/team)", "Option 2", "Option 3"],
  "problem": ["Specific challenge 1", "Specific challenge 2", "Specific challenge 3"],
  "solution": ["What they could have done 1", "What they could have done 2"],
  "alternatives": ["Alternative approach 1 they might have considered", "Alternative 2"],
  "tradeoffs": ["Tradeoff 1 (e.g., speed vs quality)", "Tradeoff 2 (e.g., cost vs scope)"],
  "metrics": ["Specific metric 1 (e.g., 30% reduction)", "Metric 2 (e.g., 2 weeks saved)"]
}

Keep suggestions SHORT (under 15 words each). Be specific and grounded in the story context.`
                        }]
                    })
                });

                const data = await response.json();
                const text = data.content[0].text.replace(/\`\`\`json|\`\`\`/g, "").trim();
                const suggestions = JSON.parse(text);
                
                // Render clickable suggestion chips for each field
                suggestFields.forEach(field => {
                    const el = document.getElementById(`suggest-${field}`);
                    if (!el || !suggestions[field]) return;
                    
                    el.innerHTML = suggestions[field].map(opt => `
                        <span onclick="applySuggestion('new-child-${field}', this.innerText)" 
                              style="display: inline-block; background: #fff; border: 1px solid #667eea; color: #667eea; padding: 4px 10px; border-radius: 15px; font-size: 0.8em; margin: 2px; cursor: pointer; transition: all 0.2s;"
                              onmouseover="this.style.background='#667eea'; this.style.color='white';"
                              onmouseout="this.style.background='#fff'; this.style.color='#667eea';">
                            ${opt}
                        </span>
                    `).join('');
                });
                
            } catch (err) {
                console.error('AI Suggest error:', err);
                suggestFields.forEach(field => {
                    const el = document.getElementById(`suggest-${field}`);
                    if (el) el.innerHTML = '<span style="color: #c00; font-size: 0.8em;">Error generating suggestions</span>';
                });
            }
        }
        
        async function aiSuggestNodeFields() {
            const node = window.currentEditingNode;
            if (!node) {
                alert('No node context found.');
                return;
            }
            
            const storyId = window.currentWebStoryId;
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) return;
            
            // Get current values from form
            const currentTitle = document.getElementById('edit-event-title').value.trim();
            const currentProblem = document.getElementById('edit-problem').value.trim();
            const currentSolution = document.getElementById('edit-solution').value.trim();
            
            // Get resume and job context
            const resumeContext = await getResumeContext();
            const jobContext = await getJobContext();
            
            // Show loading state
            const suggestFields = ['stakeholders', 'problem', 'solution', 'alternatives', 'tradeoffs', 'metrics', 'lps'];
            suggestFields.forEach(field => {
                const el = document.getElementById(`edit-suggest-${field}`);
                if (el) {
                    el.style.display = 'block';
                    el.innerHTML = '<span style="color: #666; font-size: 0.85em;">‚ú® Generating ideas...</span>';
                }
            });
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 2500,
                        messages: [{
                            role: "user",
                            content: `You are helping a candidate enrich their Amazon behavioral interview story node.

CONTEXT:
- Story Title: ${story.title || 'Untitled'}
- Full Story: ${story.rawText?.substring(0, 800) || 'No raw text'}
- Node Title: "${currentTitle || node.eventTitle}"
- STAR Component: ${node.starComponent}
- Current Problem: ${currentProblem || node.dimensions?.problem || 'Not specified'}
- Current Solution: ${currentSolution || node.dimensions?.solution || 'Not specified'}
${jobContext ? `
TARGET JOB: ${jobContext.title || 'Amazon Role'}
Key skills needed: ${jobContext.analysis?.key_skills?.join(', ') || 'Not analyzed'}
Top LPs for this role: ${jobContext.analysis?.top_lps?.join(', ') || 'Not analyzed'}
Things to emphasize: ${jobContext.analysis?.things_to_emphasize?.join('; ') || 'Not analyzed'}
` : ''}
${resumeContext ? `
CANDIDATE'S RESUME (use this to make suggestions grounded in their actual experience, skills, and achievements):
${resumeContext}
` : ''}

Generate 2-3 REALISTIC, SPECIFIC options for each field. ${jobContext ? 'Tailor suggestions to highlight skills and experiences relevant to their target role.' : ''} ${resumeContext ? 'Reference their actual roles, metrics patterns, and stakeholder types from their resume.' : ''} These MUST be grounded in the story context - suggest things the candidate likely actually did or could plausibly have done based on the story.

Respond ONLY with valid JSON:
{
  "stakeholders": ["Specific role 1", "Specific role 2", "Team name"],
  "problem": ["Specific challenge with numbers if possible", "Another angle on the problem"],
  "solution": ["Concrete action taken", "Another approach used"],
  "alternatives": ["Option A they could have considered (e.g., outsource, build vs buy)", "Option B"],
  "tradeoffs": ["Speed vs thoroughness", "Cost vs quality", "Short-term vs long-term"],
  "metrics": ["X% improvement in Y", "Reduced Z from A to B", "$X saved annually"],
  "lps": ${jobContext?.analysis?.top_lps ? JSON.stringify(jobContext.analysis.top_lps.slice(0, 3)) : '["Dive Deep", "Ownership", "Deliver Results"]'}
}

IMPORTANT:
- Keep each suggestion under 20 words
- Be SPECIFIC (not generic like "improved efficiency" - say "reduced processing time from 5 days to 2 days")
- For metrics, suggest realistic numbers based on typical outcomes${resumeContext ? ' and patterns from their resume' : ''}
- For LPs, ${jobContext ? 'prioritize the top LPs for their target role' : 'only suggest 2-3 that genuinely fit this node\'s content'}`
                        }]
                    })
                });

                const data = await response.json();
                const text = data.content[0].text.replace(/\`\`\`json|\`\`\`/g, "").trim();
                const suggestions = JSON.parse(text);
                
                // Render clickable suggestion chips for each field
                ['stakeholders', 'problem', 'solution', 'alternatives', 'tradeoffs', 'metrics'].forEach(field => {
                    const el = document.getElementById(`edit-suggest-${field}`);
                    if (!el || !suggestions[field]) return;
                    
                    el.innerHTML = suggestions[field].map(opt => `
                        <span onclick="applySuggestion('edit-${field}', this.innerText)" 
                              style="display: inline-block; background: #fff; border: 1px solid #667eea; color: #667eea; padding: 4px 10px; border-radius: 15px; font-size: 0.8em; margin: 2px; cursor: pointer; transition: all 0.2s;"
                              onmouseover="this.style.background='#667eea'; this.style.color='white';"
                              onmouseout="this.style.background='#fff'; this.style.color='#667eea';">
                            ${opt}
                        </span>
                    `).join('');
                });
                
                // Handle LP suggestions specially - check the checkboxes
                const lpsEl = document.getElementById('edit-suggest-lps');
                if (lpsEl && suggestions.lps) {
                    lpsEl.innerHTML = `<span style="font-size: 0.85em; color: #666; margin-right: 8px;">Suggested:</span>` + 
                        suggestions.lps.map(lp => `
                            <span onclick="selectSuggestedLP('${lp}')" 
                                  style="display: inline-block; background: #fff; border: 1px solid #667eea; color: #667eea; padding: 4px 10px; border-radius: 15px; font-size: 0.8em; margin: 2px; cursor: pointer; transition: all 0.2s;"
                                  onmouseover="this.style.background='#667eea'; this.style.color='white';"
                                  onmouseout="this.style.background='#fff'; this.style.color='#667eea';">
                                ${lp}
                            </span>
                        `).join('');
                }
                
            } catch (err) {
                console.error('AI Suggest error:', err);
                suggestFields.forEach(field => {
                    const el = document.getElementById(`edit-suggest-${field}`);
                    if (el) el.innerHTML = '<span style="color: #c00; font-size: 0.8em;">Error generating suggestions</span>';
                });
            }
        }
        
        function selectSuggestedLP(lpName) {
            const checkboxes = document.querySelectorAll('.edit-lp-checkbox');
            checkboxes.forEach(cb => {
                if (cb.value === lpName) {
                    cb.checked = true;
                    // Highlight the parent label briefly
                    const label = cb.closest('label');
                    if (label) {
                        label.style.transition = 'background 0.3s';
                        label.style.background = '#c8e6c9';
                        setTimeout(() => { label.style.background = '#f0f0f0'; }, 500);
                    }
                }
            });
        }
        
        function applySuggestion(inputId, value) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            // For text inputs, append with comma if existing value
            if (input.tagName === 'INPUT') {
                if (input.value.trim()) {
                    input.value = input.value.trim() + ', ' + value;
                } else {
                    input.value = value;
                }
            } else if (input.tagName === 'TEXTAREA') {
                // For textareas, append on new line or replace if empty
                if (input.value.trim()) {
                    input.value = input.value.trim() + '\n' + value;
                } else {
                    input.value = value;
                }
            }
            
            // Highlight the input briefly
            input.style.transition = 'background 0.3s';
            input.style.background = '#e8f5e9';
            setTimeout(() => { input.style.background = ''; }, 500);
        }
        // ==================== END CHILD NODE FUNCTIONS ====================
        
        async function deleteChip(nodeId, chipId) {
            try {
                console.log('=== deleteChip START ===');
                console.log('nodeId:', nodeId);
                console.log('chipId:', chipId);
                
                console.log('Showing custom confirm dialog...');
                const confirmResult = await customConfirm('Delete this chip?');
                console.log('confirm result:', confirmResult);
                
                if (!confirmResult) {
                    console.log('User cancelled');
                    return;
                }
                
                console.log('User confirmed, proceeding...');
                
                const storyId = window.currentWebStoryId;
                console.log('storyId:', storyId);
                if (!storyId) {
                    console.log('ERROR: No storyId');
                    alert('No story selected');
                    return;
                }
                
                console.log('Loading stories from storage...');
                const stories = await storage.load('stories');
                console.log('stories loaded:', stories ? Object.keys(stories).length : 'null');
                if (!stories) {
                    alert('No stories in storage');
                    return;
                }
                
                const story = stories[storyId];
                console.log('story found:', story ? story.title : 'null');
                if (!story) {
                    alert('Story not found');
                    return;
                }
                
                console.log('story.nodes count:', story.nodes?.length);
                const nodeIndex = story.nodes.findIndex(n => n.id === nodeId);
                console.log('nodeIndex:', nodeIndex);
                if (nodeIndex === -1) {
                    alert('Node not found. Looking for: ' + nodeId);
                    console.log('Available node IDs:', story.nodes.map(n => n.id));
                    return;
                }
                
                const chipsBeforeCount = story.nodes[nodeIndex].detailChips?.length || 0;
                console.log('chips before:', chipsBeforeCount);
                
                story.nodes[nodeIndex].detailChips = (story.nodes[nodeIndex].detailChips || []).filter(c => c.id !== chipId);
                
                const chipsAfterCount = story.nodes[nodeIndex].detailChips?.length || 0;
                console.log('chips after:', chipsAfterCount);
                
                console.log('Saving to storage...');
                await storage.save('stories', stories);
                console.log('Storage saved');
                
                // Refresh
                console.log('Refreshing UI...');
                closeNodeDetail();
                showNodeDetail(story.nodes[nodeIndex]);
                await loadStoryWeb();
                console.log('=== deleteChip COMPLETE ===');
            } catch (err) {
                console.error('deleteChip error:', err);
                console.error('Error stack:', err.stack);
                alert('Error deleting chip: ' + err.message);
            }
        }
        
        async function editChip(nodeId, chipId) {
            const storyId = window.currentWebStoryId;
            if (!storyId) {
                console.error('No storyId');
                return;
            }
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) {
                console.error('No story found');
                return;
            }
            
            const node = story.nodes.find(n => n.id === nodeId);
            if (!node) {
                console.error('No node found');
                return;
            }
            
            const chip = (node.detailChips || []).find(c => c.id === chipId);
            if (!chip) {
                console.error('No chip found');
                return;
            }
            
            // Store for saving
            window.editingChipNodeId = nodeId;
            window.editingChipId = chipId;
            
            // Find and replace chip element with edit form
            const chipEl = document.getElementById('chip-' + chipId);
            if (!chipEl) {
                // Fallback to prompt if element not found
                const newTitle = prompt('Edit title:', chip.title);
                if (newTitle === null) return;
                const newContent = prompt('Edit content:', chip.content);
                if (newContent === null) return;
                chip.title = newTitle || chip.title;
                chip.content = newContent || chip.content;
                await storage.save('stories', stories);
                closeNodeDetail();
                showNodeDetail(node);
                await loadStoryWeb();
                return;
            }
            
            const chipType = CHIP_TYPES[chip.type] || CHIP_TYPES.detail;
            const escapedTitle = (chip.title || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            const escapedContent = (chip.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            chipEl.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid ${chipType.border};">
                    <div style="font-weight: bold; margin-bottom: 10px;">‚úèÔ∏è Edit Chip</div>
                    <div style="margin-bottom: 10px;">
                        <label style="font-size: 0.85em; color: #666;">Type</label>
                        <select id="edit-chip-type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-top: 4px;">
                            <option value="difficulty" ${chip.type === 'difficulty' ? 'selected' : ''}>üò§ Difficulty</option>
                            <option value="stakeholder" ${chip.type === 'stakeholder' ? 'selected' : ''}>üë• Stakeholder</option>
                            <option value="detail" ${chip.type === 'detail' ? 'selected' : ''}>üìù Detail</option>
                            <option value="insight" ${chip.type === 'insight' ? 'selected' : ''}>üí° Insight</option>
                            <option value="metric" ${chip.type === 'metric' ? 'selected' : ''}>üìä Metric</option>
                            <option value="followup" ${chip.type === 'followup' ? 'selected' : ''}>üí¨ Follow-up</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label style="font-size: 0.85em; color: #666;">Title</label>
                        <input type="text" id="edit-chip-title" value="${escapedTitle}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-top: 4px;">
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 0.85em; color: #666;">Content</label>
                        <textarea id="edit-chip-content" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-top: 4px;">${escapedContent}</textarea>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm btn-success" onclick="saveChipEdit()">üíæ Save</button>
                        <button class="btn btn-sm btn-secondary" onclick="cancelChipEdit()">Cancel</button>
                    </div>
                </div>
            `;
        }
        
        async function saveChipEdit() {
            const nodeId = window.editingChipNodeId;
            const chipId = window.editingChipId;
            if (!nodeId || !chipId) return;
            
            const storyId = window.currentWebStoryId;
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) return;
            
            const node = story.nodes.find(n => n.id === nodeId);
            if (!node) return;
            
            const chip = (node.detailChips || []).find(c => c.id === chipId);
            if (!chip) return;
            
            // Get values
            const newType = document.getElementById('edit-chip-type')?.value;
            const newTitle = document.getElementById('edit-chip-title')?.value?.trim();
            const newContent = document.getElementById('edit-chip-content')?.value?.trim();
            
            if (!newTitle) {
                alert('Title is required.');
                return;
            }
            
            chip.type = newType || chip.type;
            chip.title = newTitle;
            chip.content = newContent || '';
            
            await storage.save('stories', stories);
            
            // Refresh
            closeNodeDetail();
            showNodeDetail(node);
            await loadStoryWeb();
        }
        
        async function cancelChipEdit() {
            const nodeId = window.editingChipNodeId;
            const storyId = window.currentWebStoryId;
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            const node = story?.nodes?.find(n => n.id === nodeId);
            if (node) {
                closeNodeDetail();
                showNodeDetail(node);
            }
        }
        
        async function moveChipPrompt(fromNodeId, chipId) {
            const storyId = window.currentWebStoryId;
            if (!storyId) return;
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) return;
            
            // Build list of other nodes
            const otherNodes = story.nodes.filter(n => n.id !== fromNodeId);
            if (otherNodes.length === 0) {
                alert('No other nodes to move to.');
                return;
            }
            
            const nodeList = otherNodes.map((n, i) => `${i + 1}. ${n.eventTitle}`).join('\n');
            const choice = prompt(`Move chip to which node?\n\n${nodeList}\n\nEnter number:`);
            
            if (!choice) return;
            const choiceIdx = parseInt(choice) - 1;
            if (isNaN(choiceIdx) || choiceIdx < 0 || choiceIdx >= otherNodes.length) {
                alert('Invalid selection.');
                return;
            }
            
            const targetNode = otherNodes[choiceIdx];
            await moveChip(fromNodeId, targetNode.id, chipId);
        }
        
        async function moveChip(fromNodeId, toNodeId, chipId) {
            const storyId = window.currentWebStoryId;
            if (!storyId) return;
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) return;
            
            const fromNode = story.nodes.find(n => n.id === fromNodeId);
            const toNode = story.nodes.find(n => n.id === toNodeId);
            if (!fromNode || !toNode) return;
            
            // Find and remove chip from source
            const chipIndex = (fromNode.detailChips || []).findIndex(c => c.id === chipId);
            if (chipIndex === -1) return;
            
            const [chip] = fromNode.detailChips.splice(chipIndex, 1);
            
            // Add to target
            if (!toNode.detailChips) toNode.detailChips = [];
            toNode.detailChips.push(chip);
            
            await storage.save('stories', stories);
            
            // Refresh
            closeNodeDetail();
            showNodeDetail(fromNode);
            await loadStoryWeb();
            
            alert(`Chip moved to "${toNode.eventTitle}"`);
        }
        
        // Function to save follow-up answer as chip (called from simulator)
        async function saveAnswerAsChip(storyId, nodeId, title, content, source) {
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) return false;
            
            const nodeIndex = story.nodes.findIndex(n => n.id === nodeId);
            if (nodeIndex === -1) return false;
            
            if (!story.nodes[nodeIndex].detailChips) {
                story.nodes[nodeIndex].detailChips = [];
            }
            
            const chip = {
                id: 'chip_' + Date.now(),
                type: 'followup',
                title: title,
                content: content,
                createdAt: new Date().toISOString(),
                createdFrom: source || 'Follow-up Practice'
            };
            
            story.nodes[nodeIndex].detailChips.push(chip);
            await storage.save('stories', stories);
            return true;
        }
        
        // ==================== AI SUGGEST NODES ====================
        function showAISuggestModal() {
            const storyId = window.currentWebStoryId;
            if (!storyId) {
                alert('Please select a story first.');
                return;
            }
            
            const modalHtml = `
                <div id="ai-suggest-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px;" onclick="if(event.target === this) this.remove()">
                    <div style="background: white; border-radius: 15px; padding: 25px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                        <h3 style="margin: 0 0 15px;">ü§ñ AI Node Suggestions</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            AI will analyze your story and existing nodes to suggest additions. You can review, edit, or reject each suggestion.
                        </p>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 8px;">What should AI focus on?</label>
                            <select id="ai-suggest-focus" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                                <option value="gaps">üîç Find gaps in STAR coverage</option>
                                <option value="depth">üìä Add more depth/metrics to existing events</option>
                                <option value="challenges">üò§ Extract challenges & difficulties faced</option>
                                <option value="stakeholders">üë• Identify stakeholder interactions</option>
                                <option value="lp">üéØ Find events demonstrating specific LPs</option>
                                <option value="custom">‚úèÔ∏è Custom request...</option>
                            </select>
                        </div>
                        
                        <div id="custom-prompt-section" style="display: none; margin-bottom: 20px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 8px;">Your custom request:</label>
                            <textarea id="ai-custom-prompt" rows="3" placeholder="e.g., 'Find moments where I had to convince skeptical stakeholders' or 'Extract specific metrics and numbers'" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;"></textarea>
                        </div>
                        
                        <div id="ai-suggest-loading" style="display: none; text-align: center; padding: 30px;">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 15px; color: #666;">Analyzing story and generating suggestions...</p>
                        </div>
                        
                        <div id="ai-suggest-results" style="display: none;"></div>
                        
                        <div id="ai-suggest-buttons" style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="generateAISuggestions()">ü§ñ Generate Suggestions</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('ai-suggest-modal').remove()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show/hide custom prompt
            document.getElementById('ai-suggest-focus').addEventListener('change', (e) => {
                document.getElementById('custom-prompt-section').style.display = 
                    e.target.value === 'custom' ? 'block' : 'none';
            });
        }
        
        async function generateAISuggestions() {
            const storyId = window.currentWebStoryId;
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            
            if (!story?.rawText) {
                alert('No story text found.');
                return;
            }
            
            const focus = document.getElementById('ai-suggest-focus').value;
            const customPrompt = document.getElementById('ai-custom-prompt')?.value || '';
            
            // Build context about existing nodes
            const existingNodes = story.nodes || [];
            const existingContext = existingNodes.map(n => 
                `- ${n.starComponent.toUpperCase()}: "${n.eventTitle}" (${n.visual?.anchor?.keyword || 'no anchor'})`
            ).join('\n');
            
            const focusPrompts = {
                gaps: 'Find events in the story that are NOT yet captured as nodes. Focus on filling STAR gaps - if there are few Situation nodes, suggest those. If Actions are sparse, find more action events.',
                depth: 'For events already captured, suggest additional detail nodes that add metrics, specific numbers, or deeper context that would impress an interviewer.',
                challenges: 'Extract specific challenges, difficulties, pushback, or obstacles faced. These make great "Dive Deep" and "Have Backbone" examples.',
                stakeholders: 'Identify key stakeholder interactions - convincing skeptics, managing up, cross-team collaboration, difficult conversations.',
                lp: 'Find events that strongly demonstrate Leadership Principles not well covered by existing nodes. Focus on Customer Obsession, Ownership, Bias for Action, Deliver Results.',
                custom: customPrompt
            };
            
            const focusInstruction = focusPrompts[focus] || focusPrompts.gaps;
            
            // Show loading
            document.getElementById('ai-suggest-loading').style.display = 'block';
            document.getElementById('ai-suggest-buttons').style.display = 'none';
            document.getElementById('ai-suggest-results').style.display = 'none';
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 4000,
                        messages: [{
                            role: "user",
                            content: `You are an expert Amazon interview coach. Analyze this story and suggest NEW nodes to add to the story web.

ORIGINAL STORY:
${story.rawText}

EXISTING NODES:
${existingContext || '(No nodes yet)'}

FOCUS AREA:
${focusInstruction}

Suggest 2-4 NEW nodes that would complement the existing ones. Each node should capture a distinct event or detail from the story.

Respond ONLY with valid JSON (no markdown):
{
  "suggestions": [
    {
      "eventTitle": "3-6 word title",
      "starComponent": "situation|task|action|result",
      "rationale": "Why this node adds value (1 sentence)",
      "dimensions": {
        "stakeholders": ["who was involved"],
        "problem": "what challenge or context",
        "solution": "what was done",
        "metrics": "specific numbers/impact if available",
        "alternatives": "other options considered if mentioned",
        "tradeoffs": "any tradeoffs mentioned"
      },
      "visual": {
        "anchor": {
          "emoji": "single relevant emoji",
          "keyword": "one memorable word"
        }
      },
      "leadershipPrinciples": ["LP1", "LP2"]
    }
  ]
}`
                        }]
                    })
                });

                const data = await response.json();
                let suggestions;
                
                try {
                    const text = data.content[0].text;
                    const cleaned = text.replace(/```json\n?|\n?```/g, '').trim();
                    suggestions = JSON.parse(cleaned).suggestions;
                } catch (e) {
                    throw new Error('Failed to parse AI response');
                }
                
                // Store suggestions for later use
                window.pendingSuggestions = suggestions;
                
                // Display suggestions for review
                displayAISuggestions(suggestions);
                
            } catch (error) {
                console.error('AI Suggest error:', error);
                alert('Error generating suggestions. Please try again.');
                document.getElementById('ai-suggest-loading').style.display = 'none';
                document.getElementById('ai-suggest-buttons').style.display = 'flex';
            }
        }
        
        function displayAISuggestions(suggestions) {
            const container = document.getElementById('ai-suggest-results');
            const starColors = {
                situation: '#e3f2fd',
                task: '#fff8e1', 
                action: '#e8f5e9',
                result: '#fce4ec'
            };
            const starEmojis = {
                situation: 'üèîÔ∏è',
                task: 'üéØ',
                action: '‚ö°',
                result: 'üíé'
            };
            
            let html = `<div style="margin-bottom: 15px;">
                <strong>${suggestions.length} suggestions found.</strong> Review and select which to add:
            </div>`;
            
            suggestions.forEach((suggestion, idx) => {
                html += `
                    <div id="suggestion-${idx}" class="suggestion-card" style="background: ${starColors[suggestion.starComponent] || '#f5f5f5'}; border: 2px solid #ddd; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 2em;">${suggestion.visual?.anchor?.emoji || 'üìå'}</span>
                                <div>
                                    <div style="font-weight: bold; font-size: 1.1em;">${suggestion.eventTitle}</div>
                                    <div style="font-size: 0.85em; color: #666;">
                                        ${starEmojis[suggestion.starComponent]} ${suggestion.starComponent.charAt(0).toUpperCase() + suggestion.starComponent.slice(1)}
                                        ‚Ä¢ üîë ${suggestion.visual?.anchor?.keyword || '‚Äî'}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="editSuggestion(${idx})" style="padding: 5px 10px; background: white; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">‚úèÔ∏è</button>
                                <button onclick="removeSuggestion(${idx})" style="padding: 5px 10px; background: white; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">‚úï</button>
                            </div>
                        </div>
                        
                        <div style="font-size: 0.85em; color: #555; margin-bottom: 10px; font-style: italic;">
                            üí° ${suggestion.rationale || 'Adds depth to your story'}
                        </div>
                        
                        ${suggestion.dimensions?.problem ? `<div style="font-size: 0.85em; margin-bottom: 5px;"><strong>Problem:</strong> ${suggestion.dimensions.problem}</div>` : ''}
                        ${suggestion.dimensions?.solution ? `<div style="font-size: 0.85em; margin-bottom: 5px;"><strong>Solution:</strong> ${suggestion.dimensions.solution}</div>` : ''}
                        ${suggestion.dimensions?.metrics ? `<div style="font-size: 0.85em; margin-bottom: 5px;"><strong>üìä Metrics:</strong> ${suggestion.dimensions.metrics}</div>` : ''}
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;">
                            ${(suggestion.leadershipPrinciples || []).map(lp => {
                                const lpClass = lp.toLowerCase().replace(/ /g, '-').replace(/&/g, '');
                                return `<span class="lp-tag ${lpClass}" style="font-size: 0.75em; padding: 3px 8px;">${lp}</span>`;
                            }).join('')}
                        </div>
                        
                        <label style="display: flex; align-items: center; gap: 8px; margin-top: 12px; cursor: pointer;">
                            <input type="checkbox" class="suggestion-checkbox" data-idx="${idx}" checked style="width: 18px; height: 18px;">
                            <span style="font-size: 0.9em;">Add this node</span>
                        </label>
                    </div>
                `;
            });
            
            html += `
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="addSelectedSuggestions()">‚úÖ Add Selected Nodes</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('ai-suggest-modal').remove()">Cancel</button>
                    <button class="btn btn-primary" onclick="generateAISuggestions()" style="margin-left: auto;">üîÑ Regenerate</button>
                </div>
            `;
            
            container.innerHTML = html;
            container.style.display = 'block';
            document.getElementById('ai-suggest-loading').style.display = 'none';
            document.getElementById('ai-suggest-buttons').style.display = 'none';
        }
        
        function removeSuggestion(idx) {
            document.getElementById(`suggestion-${idx}`).style.display = 'none';
            document.querySelector(`.suggestion-checkbox[data-idx="${idx}"]`).checked = false;
        }
        
        function editSuggestion(idx) {
            const suggestion = window.pendingSuggestions[idx];
            if (!suggestion) return;
            
            const newTitle = prompt('Edit title:', suggestion.eventTitle);
            if (newTitle === null) return;
            suggestion.eventTitle = newTitle || suggestion.eventTitle;
            
            const newKeyword = prompt('Edit keyword anchor:', suggestion.visual?.anchor?.keyword);
            if (newKeyword !== null) {
                suggestion.visual = suggestion.visual || {anchor: {}};
                suggestion.visual.anchor = suggestion.visual.anchor || {};
                suggestion.visual.anchor.keyword = newKeyword || suggestion.visual.anchor.keyword;
            }
            
            // Refresh display
            displayAISuggestions(window.pendingSuggestions);
        }
        
        async function addSelectedSuggestions() {
            const storyId = window.currentWebStoryId;
            if (!storyId) return;
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) return;
            
            const checkboxes = document.querySelectorAll('.suggestion-checkbox:checked');
            let addedCount = 0;
            
            checkboxes.forEach(cb => {
                const idx = parseInt(cb.dataset.idx);
                const suggestion = window.pendingSuggestions[idx];
                if (!suggestion) return;
                
                // Convert suggestion to node format
                const node = {
                    id: 'node_' + Date.now() + '_' + idx,
                    eventTitle: suggestion.eventTitle,
                    starComponent: suggestion.starComponent,
                    dimensions: suggestion.dimensions || {},
                    visual: suggestion.visual || {anchor: {emoji: 'üìå', keyword: suggestion.eventTitle.split(' ')[0]}},
                    leadershipPrinciples: suggestion.leadershipPrinciples || [],
                    detailChips: [],
                    addedBy: 'ai-suggest',
                    addedAt: new Date().toISOString()
                };
                
                story.nodes.push(node);
                addedCount++;
            });
            
            if (addedCount > 0) {
                await storage.save('stories', stories);
                document.getElementById('ai-suggest-modal').remove();
                await loadStoryWeb();
                alert(`‚úÖ Added ${addedCount} new node${addedCount > 1 ? 's' : ''} to your story web!`);
            } else {
                alert('No nodes selected. Please check at least one suggestion.');
            }
        }
        
        async function regenerateStoryWeb() {
            const storyId = window.currentWebStoryId;
            if (!storyId) return;
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story?.rawText) {
                alert('No original story text found to regenerate from.');
                return;
            }
            
            if (!confirm('This will regenerate the story web from scratch. Any manual edits will be lost. Continue?')) {
                return;
            }
            
            // Show loading state
            const canvas = document.getElementById('web-canvas');
            canvas.innerHTML = '<div style="padding: 40px; text-align: center;"><div class="spinner"></div><p>Regenerating story web...</p></div>';
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 6000,
                        messages: [{
                            role: "user",
                            content: `Regenerate a story web for this AWS FP&A interview story. Create a fresh interpretation.

STORY: ${story.rawText}

Respond ONLY with valid JSON:
{
  "nodes": [
    {
      "id": "node_1",
      "eventTitle": "Short event title",
      "starComponent": "situation|task|action|result",
      "dimensions": {
        "stakeholders": ["Person 1"],
        "problem": "...",
        "solution": "...",
        "alternatives": "...",
        "metrics": "...",
        "tradeoffs": "..."
      },
      "visual": {
        "anchor": {"emoji": "üìä", "keyword": "Dashboard"}
      },
      "leadershipPrinciples": ["LP1"]
    }
  ],
  "connections": [{"from": "node_1", "to": "node_2", "label": "led to"}]
}

Create 4-8 nodes covering Situation, Task, Actions, and Results.`
                        }]
                    })
                });
                
                const data = await response.json();
                const text = data.content[0].text.replace(/```json|```/g, "").trim();
                const result = JSON.parse(text);
                
                // Update nodes with unique IDs
                const nodes = (result.nodes || []).map((node, idx) => ({
                    ...node,
                    id: 'node_' + Date.now() + '_' + idx
                }));
                
                story.nodes = nodes;
                story.connections = result.connections || [];
                await storage.save('stories', stories);
                
                renderWebCanvas(story);
                
            } catch (error) {
                console.error('Error regenerating:', error);
                alert('Error regenerating story web.');
                renderWebCanvas(story);
            }
        }

        // Web mode state
        window.webMode = 'review'; // 'review' or 'practice'
        window.practiceState = {}; // tracks reveal state per node
        window.practiceScore = {got: 0, missed: 0};
        
        function setWebMode(mode) {
            window.webMode = mode;
            window.practiceState = {}; // reset reveal states
            window.practiceScore = {got: 0, missed: 0};
            
            // Update button styles
            const reviewBtn = document.getElementById('mode-review-btn');
            const practiceBtn = document.getElementById('mode-practice-btn');
            const practiceInstructions = document.getElementById('practice-instructions');
            const practiceScoreEl = document.getElementById('practice-score');
            
            if (mode === 'review') {
                reviewBtn.style.background = 'var(--color-primary)';
                reviewBtn.style.color = 'white';
                practiceBtn.style.background = 'white';
                practiceBtn.style.color = '#333';
                practiceInstructions.style.display = 'none';
                practiceScoreEl.style.display = 'none';
            } else {
                reviewBtn.style.background = 'white';
                reviewBtn.style.color = '#333';
                practiceBtn.style.background = 'var(--color-primary)';
                practiceBtn.style.color = 'white';
                practiceInstructions.style.display = 'block';
                practiceScoreEl.style.display = 'block';
                updatePracticeScore();
            }
            
            // Re-render canvas
            if (window.currentWebStory) {
                renderWebCanvas(window.currentWebStory);
            }
        }
        
        function updatePracticeScore() {
            document.getElementById('practice-got-count').textContent = window.practiceScore.got;
            document.getElementById('practice-missed-count').textContent = window.practiceScore.missed;
        }
        
        function handlePracticeClick(nodeIdx, event) {
            event.stopPropagation();
            const state = window.practiceState[nodeIdx] || 0;
            
            if (state === 0) {
                // First click: reveal title
                window.practiceState[nodeIdx] = 1;
            } else if (state === 1) {
                // Second click: reveal full details & show rating
                window.practiceState[nodeIdx] = 2;
            }
            
            renderWebCanvas(window.currentWebStory);
        }
        
        function ratePracticeNode(nodeIdx, gotIt, event) {
            event.stopPropagation();
            if (gotIt) {
                window.practiceScore.got++;
            } else {
                window.practiceScore.missed++;
            }
            window.practiceState[nodeIdx] = 3; // rated
            updatePracticeScore();
            renderWebCanvas(window.currentWebStory);
        }

        function renderWebCanvas(story) {
            const canvas = document.getElementById('web-canvas');
            const statsEl = document.getElementById('web-stats');
            canvas.innerHTML = '';
            
            // Store nodes for click handlers
            window.currentStoryNodes = story.nodes || [];
            
            if (!story.nodes || story.nodes.length === 0) {
                canvas.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üï∏Ô∏è</div>
                        <h3 style="color: #666; margin-bottom: 10px;">No Story Web Yet</h3>
                        <p style="color: #999;">Go to Tab 1 (Story Analyzer) to analyze a story.<br>The story web will be auto-generated!</p>
                    </div>
                `;
                statsEl.innerHTML = '';
                return;
            }

            const isPractice = window.webMode === 'practice';

            // Group by STAR component, separating parent and child nodes
            const layers = {situation: [], task: [], action: [], result: []};
            const childNodes = {}; // parentId -> [childNodes]
            
            story.nodes.forEach((node, idx) => {
                node._idx = idx;
                if (node.parentId) {
                    // This is a child node
                    if (!childNodes[node.parentId]) childNodes[node.parentId] = [];
                    childNodes[node.parentId].push(node);
                } else if (layers[node.starComponent]) {
                    layers[node.starComponent].push(node);
                }
            });

            const starMeta = {
                situation: {emoji: 'üèîÔ∏è', label: 'SITUATION', color: 'var(--color-situation)', bgGradient: 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)'},
                task: {emoji: 'üéØ', label: 'TASK', color: 'var(--color-task)', bgGradient: 'linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%)'},
                action: {emoji: '‚ö°', label: 'ACTIONS', color: 'var(--color-action)', bgGradient: 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)'},
                result: {emoji: 'üíé', label: 'RESULTS', color: 'var(--color-result)', bgGradient: 'linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%)'}
            };

            let html = '<div style="padding: 15px;">';
            
            ['situation', 'task', 'action', 'result'].forEach((component, compIdx) => {
                const nodes = layers[component];
                const meta = starMeta[component];
                const isActionLayer = component === 'action';
                
                // Section header
                html += `
                    <div style="background: ${meta.bgGradient}; border-radius: 12px; margin-bottom: 15px; overflow: hidden; border: 2px solid ${meta.color};">
                        <div style="padding: 10px 15px; background: ${meta.color}; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">${meta.emoji}</span>
                            <span style="font-weight: bold; font-size: 0.9em;">${meta.label}</span>
                            <span style="font-size: 0.8em; opacity: 0.8;">(${nodes.length})</span>
                            ${isActionLayer ? '<span style="margin-left: auto; font-size: 0.75em; background: rgba(255,255,255,0.3); padding: 3px 8px; border-radius: 10px;">‚Üì Sequential Flow</span>' : ''}
                        </div>
                        <div style="padding: 15px;">
                `;
                
                if (nodes.length === 0) {
                    html += `<div style="padding: 20px; color: #888; font-style: italic; text-align: center;">No ${component} events yet</div>`;
                } else {
                    // All components: Vertical stack
                    html += `<div style="display: flex; flex-direction: column; gap: ${isActionLayer ? '0' : '12px'};">`;
                    nodes.forEach((node, i) => {
                        const revealState = window.practiceState[node._idx] || 0;
                        const nodeChildren = childNodes[node.id] || [];
                        
                        // Render parent with children
                        html += renderExpandedCard(node, meta, isPractice, revealState, nodeChildren);
                        
                        // For actions, add sequence arrow between nodes
                        if (isActionLayer && i < nodes.length - 1) {
                            html += `
                                <div style="display: flex; align-items: center; padding: 8px 0 8px 30px;">
                                    <div style="width: 2px; height: 20px; background: ${meta.color};"></div>
                                    <span style="margin-left: -6px; font-size: 1.2em; color: ${meta.color};">‚ñº</span>
                                    <span style="margin-left: 10px; font-size: 0.75em; color: #888; font-style: italic;">then...</span>
                                </div>
                            `;
                        }
                    });
                    html += `</div>`;
                }
                
                html += '</div></div>';
                
                // Flow arrow between STAR sections
                if (component !== 'result') {
                    const nextComponent = ['situation', 'task', 'action', 'result'][compIdx + 1];
                    if (layers[nextComponent]?.length > 0) {
                        html += `<div style="text-align: center; color: #ccc; font-size: 1.5em; margin: 8px 0;">‚¨á</div>`;
                    }
                }
            });
            
            html += '</div>';
            canvas.innerHTML = html;
            
            // Render stats
            renderWebStats(story, statsEl);
        }
        
        // Chip type configurations
        const CHIP_TYPES = {
            difficulty: { emoji: 'üò§', color: '#ffebee', border: '#ef5350', label: 'Difficulty' },
            stakeholder: { emoji: 'üë•', color: '#e3f2fd', border: '#42a5f5', label: 'Stakeholder' },
            detail: { emoji: 'üìù', color: '#f5f5f5', border: '#9e9e9e', label: 'Detail' },
            insight: { emoji: 'üí°', color: '#fffde7', border: '#fdd835', label: 'Insight' },
            followup: { emoji: 'üí¨', color: '#e8f5e9', border: '#66bb6a', label: 'Follow-up' },
            metric: { emoji: 'üìä', color: '#f3e5f5', border: '#ab47bc', label: 'Metric' }
        };
        
        // Helper to highlight metrics (percentages, numbers with units)
        function highlightMetrics(text) {
            if (!text) return '';
            // Bold: percentages, dollar amounts, numbers with units (days, hours, etc), X improvement patterns
            return text
                .replace(/(\d+(?:\.\d+)?%)/g, '<strong style="color: #2e7d32;">$1</strong>')
                .replace(/(\$[\d,]+(?:\.\d+)?[KMB]?)/gi, '<strong style="color: #2e7d32;">$1</strong>')
                .replace(/(\d+(?:\.\d+)?[xX])/g, '<strong style="color: #2e7d32;">$1</strong>')
                .replace(/(\d+(?:\.\d+)?\s*(?:days?|hours?|weeks?|months?|minutes?|seconds?))/gi, '<strong style="color: #1565c0;">$1</strong>')
                .replace(/(\d+(?:,\d+)*(?:\.\d+)?)\s*(to|‚Üí|->)\s*(\d+(?:,\d+)*(?:\.\d+)?)/g, '<strong style="color: #2e7d32;">$1</strong> $2 <strong style="color: #2e7d32;">$3</strong>');
        }
        
        function renderExpandedCard(node, meta, isPractice, revealState, childNodes = []) {
            const idx = node._idx;
            const chips = node.detailChips || [];
            const chipCount = chips.length;
            const hasChildren = childNodes.length > 0;
            
            // Define starMeta locally for child node colors
            const starMeta = {
                situation: {emoji: 'üèîÔ∏è', label: 'SITUATION', color: 'var(--color-situation)'},
                task: {emoji: 'üéØ', label: 'TASK', color: 'var(--color-task)'},
                action: {emoji: '‚ö°', label: 'ACTIONS', color: 'var(--color-action)'},
                result: {emoji: 'üíé', label: 'RESULTS', color: 'var(--color-result)'}
            };
            
            if (!isPractice) {
                // REVIEW MODE: Expanded card with all details visible
                return `
                    <div style="display: flex; align-items: flex-start; gap: 12px; width: 100%;">
                        <!-- Main Parent Card -->
                        <div onclick="showNodeDetail(window.currentStoryNodes[${idx}])" 
                             style="background: white; border: 2px solid ${meta.color}; border-radius: 12px; padding: 15px; flex: 1; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.06);"
                             onmouseover="this.style.boxShadow='0 4px 15px rgba(0,0,0,0.12)';"
                             onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.06)';">
                            
                            <!-- Header: Emoji + Title + Keyword -->
                            <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                                <span style="font-size: 2.2em; line-height: 1;">${node.visual?.anchor?.emoji || 'üìå'}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 700; font-size: 1em; color: #333; margin-bottom: 4px;">${node.eventTitle}</div>
                                    <div style="background: ${meta.color}; padding: 3px 10px; border-radius: 12px; font-size: 0.75em; display: inline-block; font-weight: 600;">
                                        üîë ${node.visual?.anchor?.keyword || '‚Äî'}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Dimensions - All visible -->
                            ${node.dimensions ? `
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 10px; font-size: 0.9em; line-height: 1.6;">
                                ${node.dimensions.stakeholders?.length ? `<div style="margin-bottom: 6px;"><span style="color: #1976d2;">üë•</span> <strong>${Array.isArray(node.dimensions.stakeholders) ? node.dimensions.stakeholders.join(', ') : node.dimensions.stakeholders}</strong></div>` : ''}
                                ${node.dimensions.problem ? `<div style="margin-bottom: 6px;"><span style="color: #e53935;">‚ùó</span> ${highlightMetrics(node.dimensions.problem)}</div>` : ''}
                                ${node.dimensions.solution ? `<div style="margin-bottom: 6px;"><span style="color: #43a047;">‚úÖ</span> ${highlightMetrics(node.dimensions.solution)}</div>` : ''}
                                ${node.dimensions.alternatives ? `<div style="margin-bottom: 6px;"><span style="color: #ff9800;">üîÑ</span> <em>Alternatives:</em> ${highlightMetrics(node.dimensions.alternatives)}</div>` : ''}
                                ${node.dimensions.tradeoffs ? `<div style="margin-bottom: 6px;"><span style="color: #9c27b0;">‚öñÔ∏è</span> <em>Tradeoffs:</em> ${highlightMetrics(node.dimensions.tradeoffs)}</div>` : ''}
                                ${node.dimensions.metrics ? `<div style="background: #c8e6c9; padding: 10px 14px; border-radius: 8px; margin-top: 8px; font-weight: 600; font-size: 1.05em; border-left: 4px solid #2e7d32;"><span style="color: #2e7d32;">üìä</span> ${highlightMetrics(node.dimensions.metrics)}</div>` : ''}
                            </div>
                            ` : ''}
                            
                            <!-- LP Tags -->
                            ${node.leadershipPrinciples?.length ? `
                            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 10px;">
                                ${node.leadershipPrinciples.map(lp => {
                                    const lpClass = lp.toLowerCase().replace(/ /g, '-').replace(/&/g, '');
                                    return `<span class="lp-tag ${lpClass}" style="font-size: 0.75em; padding: 4px 10px;">${lp}</span>`;
                                }).join('')}
                            </div>
                            ` : ''}
                            
                            <!-- Detail Chips inline -->
                            ${chipCount > 0 ? `
                            <div style="border-top: 1px dashed #ddd; padding-top: 10px; display: flex; flex-wrap: wrap; gap: 6px;">
                                ${chips.map(chip => {
                                    const chipType = CHIP_TYPES[chip.type] || CHIP_TYPES.detail;
                                    return `
                                        <div style="background: ${chipType.color}; border: 1px solid ${chipType.border}; border-radius: 8px; padding: 6px 10px; font-size: 0.8em;">
                                            <strong>${chipType.emoji} ${chip.title}</strong>
                                            ${chip.content ? `<div style="font-size: 0.9em; color: #555; margin-top: 2px;">${chip.content.substring(0, 60)}${chip.content.length > 60 ? '...' : ''}</div>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ` : ''}
                            
                            <!-- Child Nodes Accordion -->
                            ${hasChildren ? `
                            <div style="margin-top: 12px; border-top: 2px solid ${meta.color}; padding-top: 12px;">
                                <div onclick="toggleChildNodes('${node.id}', event)" 
                                     style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px 12px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; transition: all 0.2s;"
                                     onmouseover="this.style.background='linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)'"
                                     onmouseout="this.style.background='linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)'">
                                    <span style="font-size: 1.2em;">üîó</span>
                                    <span style="font-weight: 600; flex: 1;">${childNodes.length} linked detail${childNodes.length > 1 ? 's' : ''}</span>
                                    <span id="child-toggle-icon-${node.id}" style="font-size: 1.2em; transition: transform 0.3s;">‚ñº</span>
                                </div>
                                
                                <div id="child-nodes-accordion-${node.id}" style="display: none; margin-top: 10px; padding-left: 12px; border-left: 3px solid ${meta.color};">
                                    ${childNodes.map(child => {
                                        const childMeta = starMeta[child.starComponent] || meta;
                                        const childChips = child.detailChips || [];
                                        return `
                                            <div onclick="showNodeDetail(window.currentStoryNodes[${child._idx}]); event.stopPropagation();"
                                                 style="background: white; border: 2px solid #ddd; border-left: 4px solid ${childMeta.color}; border-radius: 10px; padding: 15px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;"
                                                 onmouseover="this.style.borderColor='${childMeta.color}'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';"
                                                 onmouseout="this.style.borderColor='#ddd'; this.style.borderLeftColor='${childMeta.color}'; this.style.boxShadow='none';">
                                                
                                                <!-- Header -->
                                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                                    <span style="font-size: 1.8em;">${child.visual?.anchor?.emoji || 'üìå'}</span>
                                                    <div style="flex: 1;">
                                                        <div style="font-weight: 700; font-size: 1.05em;">${child.eventTitle}</div>
                                                        <div style="background: ${childMeta.color}; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; display: inline-block; margin-top: 4px; font-weight: 600;">üîë ${child.visual?.anchor?.keyword || '‚Äî'}</div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Dimensions -->
                                                ${child.dimensions ? `
                                                <div style="background: #f8f9fa; border-radius: 8px; padding: 10px; font-size: 0.9em; line-height: 1.5;">
                                                    ${child.dimensions.stakeholders?.length ? `<div style="margin-bottom: 5px;"><span style="color: #1976d2;">üë•</span> <strong>${Array.isArray(child.dimensions.stakeholders) ? child.dimensions.stakeholders.join(', ') : child.dimensions.stakeholders}</strong></div>` : ''}
                                                    ${child.dimensions.problem ? `<div style="margin-bottom: 5px;"><span style="color: #e53935;">‚ùó</span> ${highlightMetrics(child.dimensions.problem)}</div>` : ''}
                                                    ${child.dimensions.solution ? `<div style="margin-bottom: 5px;"><span style="color: #43a047;">‚úÖ</span> ${highlightMetrics(child.dimensions.solution)}</div>` : ''}
                                                    ${child.dimensions.alternatives ? `<div style="margin-bottom: 5px;"><span style="color: #ff9800;">üîÑ</span> <em>Alternatives:</em> ${highlightMetrics(child.dimensions.alternatives)}</div>` : ''}
                                                    ${child.dimensions.tradeoffs ? `<div style="margin-bottom: 5px;"><span style="color: #9c27b0;">‚öñÔ∏è</span> <em>Tradeoffs:</em> ${highlightMetrics(child.dimensions.tradeoffs)}</div>` : ''}
                                                    ${child.dimensions.metrics ? `<div style="background: #c8e6c9; padding: 8px 10px; border-radius: 6px; margin-top: 8px; font-weight: 600; border-left: 3px solid #2e7d32;"><span style="color: #2e7d32;">üìä</span> ${highlightMetrics(child.dimensions.metrics)}</div>` : ''}
                                                </div>
                                                ` : ''}
                                                
                                                <!-- LP Tags -->
                                                ${child.leadershipPrinciples?.length ? `
                                                <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 10px;">
                                                    ${child.leadershipPrinciples.map(lp => {
                                                        const lpClass = lp.toLowerCase().replace(/ /g, '-').replace(/&/g, '');
                                                        return '<span class="lp-tag ' + lpClass + '" style="font-size: 0.75em; padding: 3px 8px;">' + lp + '</span>';
                                                    }).join('')}
                                                </div>
                                                ` : ''}
                                                
                                                <!-- Chips -->
                                                ${childChips.length > 0 ? `
                                                <div style="border-top: 1px dashed #ddd; padding-top: 8px; margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;">
                                                    ${childChips.map(chip => {
                                                        const chipType = CHIP_TYPES[chip.type] || CHIP_TYPES.detail;
                                                        return '<span style="background: ' + chipType.color + '; border: 1px solid ' + chipType.border + '; padding: 3px 8px; border-radius: 6px; font-size: 0.8em;">' + chipType.emoji + ' ' + chip.title + '</span>';
                                                    }).join('')}
                                                </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // PRACTICE MODE: Progressive reveal
            if (revealState === 0) {
                // State 0: Only anchor visible
                return `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div onclick="handlePracticeClick(${idx}, event)" 
                             style="background: linear-gradient(135deg, ${meta.color} 0%, white 100%); border: 3px solid ${meta.color}; border-radius: 12px; padding: 20px; min-width: 160px; max-width: 220px; cursor: pointer; text-align: center; transition: all 0.2s; position: relative;"
                             onmouseover="this.style.transform='scale(1.02)';"
                             onmouseout="this.style.transform='';">
                            ${(chipCount + childNodes.length) > 0 ? `<div style="position: absolute; top: -8px; right: -8px; background: var(--color-primary); color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 0.8em; display: flex; align-items: center; justify-content: center; font-weight: bold;">${chipCount + childNodes.length}</div>` : ''}
                            <div style="font-size: 3em; margin-bottom: 8px;">${node.visual?.anchor?.emoji || 'üìå'}</div>
                            <div style="font-weight: bold; font-size: 1.1em; color: #333;">${node.visual?.anchor?.keyword || '???'}</div>
                            <div style="margin-top: 12px; font-size: 0.75em; color: #888;">tap to recall ‚Üí</div>
                        </div>
                    </div>
                `;
            } else if (revealState === 1) {
                // State 1: Title revealed
                return `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div onclick="handlePracticeClick(${idx}, event)" 
                             style="background: white; border: 3px solid ${meta.color}; border-radius: 12px; padding: 15px; min-width: 220px; max-width: 320px; cursor: pointer; transition: all 0.2s;"
                             onmouseover="this.style.transform='scale(1.01)';"
                             onmouseout="this.style.transform='';">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <span style="font-size: 2em;">${node.visual?.anchor?.emoji || 'üìå'}</span>
                                <div>
                                    <div style="font-weight: 600; font-size: 1em;">${node.eventTitle}</div>
                                    <div style="background: ${meta.color}; padding: 3px 10px; border-radius: 10px; font-size: 0.75em; display: inline-block; margin-top: 4px;">üîë ${node.visual?.anchor?.keyword || '‚Äî'}</div>
                                </div>
                            </div>
                            <div style="text-align: center; color: #666; font-size: 0.85em; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                                üß† Can you recall the details?<br>
                                <span style="color: var(--color-primary); font-weight: 500;">tap to reveal ‚Üí</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (revealState === 2) {
                // State 2: Full reveal with rating buttons
                return `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="background: white; border: 3px solid ${meta.color}; border-radius: 12px; padding: 15px; min-width: 280px; max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <span style="font-size: 2em;">${node.visual?.anchor?.emoji || 'üìå'}</span>
                                <div>
                                    <div style="font-weight: 600;">${node.eventTitle}</div>
                                    <div style="background: ${meta.color}; padding: 3px 10px; border-radius: 10px; font-size: 0.75em; display: inline-block; margin-top: 4px;">üîë ${node.visual?.anchor?.keyword || '‚Äî'}</div>
                                </div>
                            </div>
                            
                            ${node.dimensions ? `
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin-bottom: 10px; font-size: 0.85em;">
                                ${node.dimensions.problem ? `<div style="margin-bottom: 5px;">‚ùó ${node.dimensions.problem}</div>` : ''}
                                ${node.dimensions.solution ? `<div style="margin-bottom: 5px;">‚úÖ ${node.dimensions.solution}</div>` : ''}
                                ${node.dimensions.metrics ? `<div style="background: #e8f5e9; padding: 6px 10px; border-radius: 6px; margin-top: 6px;">üìä <strong>${node.dimensions.metrics}</strong></div>` : ''}
                            </div>
                            ` : ''}
                            
                            ${chipCount > 0 ? `
                            <div style="margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 4px;">
                                ${chips.map(chip => {
                                    const chipType = CHIP_TYPES[chip.type] || CHIP_TYPES.detail;
                                    return `<span style="background: ${chipType.color}; border: 1px solid ${chipType.border}; padding: 4px 8px; border-radius: 8px; font-size: 0.75em;">${chipType.emoji} ${chip.title}</span>`;
                                }).join('')}
                            </div>
                            ` : ''}
                            
                            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 12px;">
                                ${(node.leadershipPrinciples || []).map(lp => {
                                    const lpClass = lp.toLowerCase().replace(/ /g, '-').replace(/&/g, '');
                                    return `<span class="lp-tag ${lpClass}" style="font-size: 0.7em; padding: 3px 8px;">${lp}</span>`;
                                }).join('')}
                            </div>
                            
                            <div style="display: flex; gap: 10px; border-top: 1px solid #eee; padding-top: 12px;">
                                <button onclick="ratePracticeNode(${idx}, true, event)" style="flex: 1; padding: 12px; background: var(--color-success); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.95em;">‚úì Got it</button>
                                <button onclick="ratePracticeNode(${idx}, false, event)" style="flex: 1; padding: 12px; background: var(--color-danger); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.95em;">‚úó Missed</button>
                            </div>
                        </div>
                        
                        <!-- Show children in practice reveal too -->
                        ${hasChildren ? `
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            ${childNodes.slice(0, 3).map(child => `
                                <div style="background: #f8f9fa; border-left: 3px solid ${meta.color}; border-radius: 6px; padding: 8px 12px; font-size: 0.8em;">
                                    ${child.visual?.anchor?.emoji || 'üìå'} ${child.eventTitle}
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // State 3: Rated - show compact
                return `
                    <div style="display: flex; align-items: flex-start;">
                        <div style="background: #f8f9fa; border: 2px solid #ddd; border-radius: 12px; padding: 12px; min-width: 160px; max-width: 200px; opacity: 0.7;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5em;">${node.visual?.anchor?.emoji || 'üìå'}</span>
                                <div>
                                    <div style="font-size: 0.9em; font-weight: 500; color: #666;">${node.eventTitle}</div>
                                    <div style="font-size: 0.75em; color: #888;">‚úì Reviewed</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function renderNodeCard(node, meta, isPractice, revealState) {
            // Legacy wrapper - calls new expanded card
            return renderExpandedCard(node, meta, isPractice, revealState, []);
        }
        
        function renderWebStats(story, statsEl) {
            const totalNodes = story.nodes.length;
            const allLPs = [...new Set(story.nodes.flatMap(n => n.leadershipPrinciples || []).filter(lp => lp))];
            const starCounts = {situation: 0, task: 0, action: 0, result: 0};
            story.nodes.forEach(n => {
                if (starCounts[n.starComponent] !== undefined) starCounts[n.starComponent]++;
            });
            
            statsEl.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--color-primary);">${totalNodes}</div>
                    <div style="font-size: 0.8em; color: #666;">Events</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5em; font-weight: bold; color: var(--color-success);">${allLPs.length}</div>
                    <div style="font-size: 0.8em; color: #666;">LPs Covered</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 0.9em;">
                        <span style="color: var(--color-situation);">S:${starCounts.situation}</span>
                        <span style="color: var(--color-task); margin-left: 8px;">T:${starCounts.task}</span>
                        <span style="color: var(--color-action); margin-left: 8px;">A:${starCounts.action}</span>
                        <span style="color: var(--color-result); margin-left: 8px;">R:${starCounts.result}</span>
                    </div>
                    <div style="font-size: 0.8em; color: #666;">STAR Balance</div>
                </div>
                ${allLPs.length > 0 ? `
                <div style="text-align: center; flex: 2;">
                    <div style="display: flex; flex-wrap: wrap; gap: 4px; justify-content: center;">
                        ${allLPs.slice(0, 5).map(lp => {
                            const lpClass = lp.toLowerCase().replace(/ /g, '-').replace(/&/g, '');
                            return `<span class="lp-tag ${lpClass}" style="font-size: 0.7em; padding: 2px 6px;">${lp}</span>`;
                        }).join('')}
                        ${allLPs.length > 5 ? `<span style="font-size: 0.7em; color: #999;">+${allLPs.length - 5} more</span>` : ''}
                    </div>
                </div>
                ` : ''}
            `;
        }
        
        // ==================== EXPORT/IMPORT FUNCTIONS ====================
        function toggleExportMenu() {
            const menu = document.getElementById('export-menu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            
            // Close menu when clicking outside
            if (menu.style.display === 'block') {
                setTimeout(() => {
                    document.addEventListener('click', closeExportMenuOnClickOutside);
                }, 10);
            }
        }
        
        function closeExportMenuOnClickOutside(e) {
            const menu = document.getElementById('export-menu');
            if (!e.target.closest('#export-menu') && !e.target.closest('[onclick="toggleExportMenu()"]')) {
                menu.style.display = 'none';
                document.removeEventListener('click', closeExportMenuOnClickOutside);
            }
        }
        
        async function exportToJSON() {
            const storyId = window.currentWebStoryId;
            if (!storyId) {
                alert('Please select a story first.');
                return;
            }
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) return;
            
            const exportData = {
                version: '2.0',
                exportedAt: new Date().toISOString(),
                story: story
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `story-web-${story.title?.replace(/[^a-z0-9]/gi, '-') || storyId}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            document.getElementById('export-menu').style.display = 'none';
        }
        
        async function importFromJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (!data.story || !data.story.id) {
                        alert('Invalid story web file.');
                        return;
                    }
                    
                    const stories = await storage.load('stories') || {};
                    
                    // Check if story exists
                    if (stories[data.story.id]) {
                        const overwrite = await customConfirm(`Story "${data.story.title}" already exists. Overwrite?`);
                        if (!overwrite) {
                            return;
                        }
                    }
                    
                    stories[data.story.id] = data.story;
                    await storage.save('stories', stories);
                    
                    // Refresh
                    await loadStoriesIntoSelectors();
                    document.getElementById('web-story-select').value = data.story.id;
                    await loadStoryWeb();
                    
                    alert(`Imported: ${data.story.title}`);
                } catch (err) {
                    console.error(err);
                    alert('Error reading file. Make sure it\'s a valid JSON export.');
                }
            };
            input.click();
            document.getElementById('export-menu').style.display = 'none';
        }
        
        async function exportToVisualHTML() {
            console.log('=== exportToVisualHTML ENTRY ===');
            try {
                console.log('exportToVisualHTML called');
                const storyId = window.currentWebStoryId;
                console.log('storyId:', storyId);
                if (!storyId) {
                    alert('Please select a story first.');
                    return;
                }
                
                const stories = await storage.load('stories') || {};
                const story = stories[storyId];
                console.log('story:', story?.title, 'nodes:', story?.nodes?.length);
                if (!story || !story.nodes?.length) {
                    alert('No nodes to export.');
                    return;
                }
            
            // Group by STAR
            const layers = {situation: [], task: [], action: [], result: []};
            story.nodes.forEach(node => {
                if (layers[node.starComponent]) {
                    layers[node.starComponent].push(node);
                }
            });
            
            const starConfig = {
                situation: { emoji: 'üèîÔ∏è', label: 'SITUATION', bg: '#e3f2fd', border: '#1976d2', text: '#0d47a1' },
                task: { emoji: 'üéØ', label: 'TASK', bg: '#fff8e1', border: '#f9a825', text: '#e65100' },
                action: { emoji: '‚ö°', label: 'ACTIONS', bg: '#e8f5e9', border: '#43a047', text: '#1b5e20' },
                result: { emoji: 'üíé', label: 'RESULTS', bg: '#fce4ec', border: '#e91e63', text: '#880e4f' }
            };
            
            const chipColors = {
                difficulty: { bg: '#ffebee', border: '#ef5350', emoji: 'üò§' },
                stakeholder: { bg: '#e3f2fd', border: '#42a5f5', emoji: 'üë•' },
                detail: { bg: '#f5f5f5', border: '#9e9e9e', emoji: 'üìù' },
                insight: { bg: '#fffde7', border: '#ffeb3b', emoji: 'üí°' },
                followup: { bg: '#e8f5e9', border: '#66bb6a', emoji: 'üí¨' },
                metric: { bg: '#f3e5f5', border: '#ab47bc', emoji: 'üìä' }
            };
            
            // Build HTML
            let html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${story.title || 'Story Web'} - Interview Prep</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f8f9fa; 
            padding: 30px;
            color: #333;
            line-height: 1.5;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #e0e0e0;
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; color: #1a1a1a; }
        .header .meta { color: #666; font-size: 0.9em; }
        .star-section {
            margin-bottom: 30px;
            page-break-inside: avoid;
        }
        .star-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            font-weight: bold;
            font-size: 1.2em;
        }
        .star-content {
            background: white;
            border-radius: 0 0 12px 12px;
            padding: 20px;
            border: 2px solid;
            border-top: none;
        }
        .node-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            page-break-inside: avoid;
        }
        .node-header {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
        }
        .node-emoji { font-size: 2.5em; }
        .node-title { font-size: 1.3em; font-weight: 600; margin-bottom: 5px; }
        .node-keyword {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .dimensions-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .dimensions-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
        .dimensions-table td:first-child {
            width: 120px;
            font-weight: 600;
            color: #555;
        }
        .lp-tags { display: flex; flex-wrap: wrap; gap: 6px; margin: 10px 0; }
        .lp-tag {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 500;
            background: #e8eaf6;
            color: #3949ab;
        }
        .chips-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #e0e0e0;
        }
        .chips-title { font-weight: 600; margin-bottom: 10px; color: #555; }
        .chip {
            display: inline-flex;
            align-items: flex-start;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 10px;
            margin: 5px 5px 5px 0;
            border: 2px solid;
            font-size: 0.9em;
        }
        .chip-content { flex: 1; }
        .chip-title { font-weight: 600; margin-bottom: 3px; }
        .chip-text { color: #555; font-size: 0.9em; }
        .summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
        }
        .summary h3 { margin-bottom: 15px; }
        .summary-stats { display: flex; justify-content: center; gap: 40px; flex-wrap: wrap; }
        .summary-stat { text-align: center; }
        .summary-stat .number { font-size: 2em; font-weight: bold; }
        .summary-stat .label { font-size: 0.85em; opacity: 0.9; }
        .flow-arrow {
            text-align: center;
            font-size: 2em;
            color: #bbb;
            margin: 10px 0;
        }
        @media print {
            body { padding: 15px; background: white; }
            .node-card { box-shadow: none; border: 1px solid #ddd; }
            .summary { background: #f0f0f0; color: #333; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>${story.title || 'Story Web'}</h1>
        <div class="meta">
            Interview Prep Story Map ‚Ä¢ Exported ${new Date().toLocaleDateString()} ‚Ä¢ ${story.nodes.length} Events
        </div>
    </div>
`;

            // Render each STAR section
            ['situation', 'task', 'action', 'result'].forEach((component, idx) => {
                const nodes = layers[component];
                const config = starConfig[component];
                
                if (nodes.length === 0) return;
                
                html += `
    <div class="star-section">
        <div class="star-header" style="background: ${config.bg}; color: ${config.text};">
            <span style="font-size: 1.5em;">${config.emoji}</span>
            <span>${config.label}</span>
        </div>
        <div class="star-content" style="border-color: ${config.border};">
`;
                
                nodes.forEach(node => {
                    const emoji = node.visual?.anchor?.emoji || 'üìå';
                    const keyword = node.visual?.anchor?.keyword || '‚Äî';
                    
                    html += `
            <div class="node-card">
                <div class="node-header">
                    <div class="node-emoji">${emoji}</div>
                    <div>
                        <div class="node-title">${node.eventTitle || 'Event'}</div>
                        <div class="node-keyword" style="background: ${config.bg}; color: ${config.text};">üîë ${keyword}</div>
                    </div>
                </div>
`;
                    
                    // Dimensions
                    if (node.dimensions) {
                        html += `<table class="dimensions-table">`;
                        if (node.dimensions.stakeholders?.length) {
                            const stakeholders = Array.isArray(node.dimensions.stakeholders) ? node.dimensions.stakeholders.join(', ') : node.dimensions.stakeholders;
                            html += `<tr><td>üë• Stakeholders</td><td>${stakeholders}</td></tr>`;
                        }
                        if (node.dimensions.problem) {
                            html += `<tr><td>‚ùó Problem</td><td>${node.dimensions.problem}</td></tr>`;
                        }
                        if (node.dimensions.solution) {
                            html += `<tr><td>‚úÖ Solution</td><td>${node.dimensions.solution}</td></tr>`;
                        }
                        if (node.dimensions.metrics) {
                            html += `<tr><td>üìä Metrics</td><td><strong>${node.dimensions.metrics}</strong></td></tr>`;
                        }
                        if (node.dimensions.alternatives) {
                            html += `<tr><td>üîÑ Alternatives</td><td>${node.dimensions.alternatives}</td></tr>`;
                        }
                        if (node.dimensions.tradeoffs) {
                            html += `<tr><td>‚öñÔ∏è Tradeoffs</td><td>${node.dimensions.tradeoffs}</td></tr>`;
                        }
                        html += `</table>`;
                    }
                    
                    // LPs
                    if (node.leadershipPrinciples?.length) {
                        html += `<div class="lp-tags">`;
                        node.leadershipPrinciples.forEach(lp => {
                            html += `<span class="lp-tag">üéØ ${lp}</span>`;
                        });
                        html += `</div>`;
                    }
                    
                    // Chips
                    const chips = node.detailChips || [];
                    if (chips.length > 0) {
                        html += `
                <div class="chips-section">
                    <div class="chips-title">üè∑Ô∏è Detail Chips</div>
                    <div>`;
                        chips.forEach(chip => {
                            const chipConfig = chipColors[chip.type] || chipColors.detail;
                            html += `
                        <div class="chip" style="background: ${chipConfig.bg}; border-color: ${chipConfig.border};">
                            <span>${chipConfig.emoji}</span>
                            <div class="chip-content">
                                <div class="chip-title">${chip.title}</div>
                                <div class="chip-text">${chip.content}</div>
                            </div>
                        </div>`;
                        });
                        html += `
                    </div>
                </div>`;
                    }
                    
                    html += `
            </div>`;
                });
                
                html += `
        </div>
    </div>`;
                
                // Add flow arrow between sections
                if (idx < 3 && layers[['situation', 'task', 'action', 'result'][idx + 1]]?.length > 0) {
                    html += `<div class="flow-arrow">‚¨á</div>`;
                }
            });
            
            // Summary
            const allLPs = [...new Set(story.nodes.flatMap(n => n.leadershipPrinciples || []).filter(lp => lp))];
            const totalChips = story.nodes.reduce((sum, n) => sum + (n.detailChips?.length || 0), 0);
            
            html += `
    <div class="summary">
        <h3>üìä Story Summary</h3>
        <div class="summary-stats">
            <div class="summary-stat">
                <div class="number">${story.nodes.length}</div>
                <div class="label">Events</div>
            </div>
            <div class="summary-stat">
                <div class="number">${allLPs.length}</div>
                <div class="label">LPs Covered</div>
            </div>
            <div class="summary-stat">
                <div class="number">${totalChips}</div>
                <div class="label">Detail Chips</div>
            </div>
        </div>
        <div style="margin-top: 15px; font-size: 0.9em; opacity: 0.9;">
            ${allLPs.join(' ‚Ä¢ ')}
        </div>
    </div>
</body>
</html>`;

            // Store for preview
            window.exportedHTML = html;
            window.exportedFileName = `${story.title?.replace(/[^a-z0-9]/gi, '-') || 'story-web'}.html`;
            
            // Show preview modal with iframe and download button
            showExportPreviewModal(html, story.title);
            
            document.getElementById('export-menu').style.display = 'none';
            } catch (err) {
                console.error('exportToVisualHTML error:', err);
                alert('Error exporting: ' + err.message);
            }
        }
        
        function showExportPreviewModal(html, title) {
            console.log('=== showExportPreviewModal START ===');
            console.log('title:', title);
            console.log('html length:', html?.length);
            
            const modalHtml = `
                <div id="export-preview-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px;" onclick="if(event.target === this) this.remove()">
                    <div style="background: white; border-radius: 15px; width: 95%; max-width: 1000px; height: 90vh; display: flex; flex-direction: column; overflow: hidden;">
                        <div style="padding: 15px 20px; border-bottom: 2px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">üñºÔ∏è Export Preview: ${title || 'Story Web'}</h3>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-success" onclick="event.stopPropagation(); downloadExportedHTML()">üíæ Download HTML</button>
                                <button class="btn btn-primary" onclick="event.stopPropagation(); printExportedHTML()">üñ®Ô∏è Print / Save PDF</button>
                                <button onclick="document.getElementById('export-preview-modal').remove()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; padding: 5px 10px;">√ó</button>
                            </div>
                        </div>
                        <div style="flex: 1; padding: 10px; background: #f0f0f0; overflow: hidden;">
                            <iframe id="export-preview-iframe" style="width: 100%; height: 100%; border: none; border-radius: 8px; background: white;"></iframe>
                        </div>
                        <div style="padding: 10px 20px; background: #f8f9fa; font-size: 0.85em; color: #666; text-align: center;">
                            üí° Tip: Click "Print / Save PDF" ‚Üí a new window opens ‚Üí choose "Save as PDF" as destination.<br>
                            <span style="font-size: 0.9em;">If popup is blocked, download HTML and open in browser to print.</span>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            console.log('Modal HTML inserted');
            
            // Write content to iframe
            const iframe = document.getElementById('export-preview-iframe');
            console.log('iframe found:', !!iframe);
            if (!iframe) {
                alert('ERROR: Could not find iframe');
                return;
            }
            
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            console.log('iframeDoc found:', !!iframeDoc);
            if (!iframeDoc) {
                alert('ERROR: Could not access iframe document');
                return;
            }
            
            iframeDoc.open();
            iframeDoc.write(window.exportedHTML);
            iframeDoc.close();
            console.log('=== showExportPreviewModal COMPLETE ===');
        }
        
        function downloadExportedHTML() {
            try {
                console.log('=== downloadExportedHTML START ===');
                console.log('window.exportedHTML exists:', !!window.exportedHTML);
                console.log('window.exportedHTML length:', window.exportedHTML?.length);
                console.log('window.exportedFileName:', window.exportedFileName);
                
                if (!window.exportedHTML) {
                    alert('No exported content available. Please click "Visual HTML" first.');
                    return;
                }
                
                const blob = new Blob([window.exportedHTML], {type: 'text/html'});
                console.log('Blob created, size:', blob.size);
                
                const url = URL.createObjectURL(blob);
                console.log('URL created:', url);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = window.exportedFileName || 'story-web.html';
                console.log('Download filename:', a.download);
                
                document.body.appendChild(a);
                a.click();
                console.log('Click triggered');
                
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log('=== downloadExportedHTML COMPLETE ===');
            } catch (err) {
                console.error('downloadExportedHTML error:', err);
                alert('Error downloading: ' + err.message);
            }
        }
        
        function printExportedHTML() {
            try {
                console.log('=== printExportedHTML START ===');
                
                if (!window.exportedHTML) {
                    alert('No content to print. Please click "Visual HTML" first.');
                    return;
                }
                
                // Open in new window for printing (iframe.print() is blocked in artifact environment)
                console.log('Opening new window for print...');
                const printWindow = window.open('', '_blank', 'width=900,height=700');
                
                if (!printWindow) {
                    alert('Popup blocked! Please allow popups for this site, or:\n\n1. Download the HTML file\n2. Open it in your browser\n3. Press Ctrl+P to print/save as PDF');
                    return;
                }
                
                printWindow.document.write(window.exportedHTML);
                printWindow.document.close();
                
                // Wait for content to load, then print
                printWindow.onload = function() {
                    console.log('Print window loaded, triggering print...');
                    printWindow.print();
                };
                
                // Fallback: trigger print after a short delay
                setTimeout(() => {
                    try {
                        printWindow.print();
                    } catch (e) {
                        console.log('Delayed print failed:', e);
                    }
                }, 500);
                
                console.log('=== printExportedHTML COMPLETE ===');
            } catch (err) {
                console.error('printExportedHTML error:', err);
                alert('Error printing: ' + err.message + '\n\nTry downloading the HTML file instead and opening it in your browser to print.');
            }
        }
        
        async function exportToMermaid() {
            const storyId = window.currentWebStoryId;
            if (!storyId) {
                alert('Please select a story first.');
                return;
            }
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story || !story.nodes?.length) {
                alert('No nodes to export.');
                return;
            }
            
            // Generate Mermaid flowchart
            let mermaid = `flowchart TD\n`;
            mermaid += `    %% ${story.title || 'Story Web'}\n`;
            mermaid += `    %% Exported: ${new Date().toLocaleDateString()}\n\n`;
            
            // Style definitions
            mermaid += `    classDef situation fill:#e8f4fd,stroke:#4a90d9,stroke-width:2px\n`;
            mermaid += `    classDef task fill:#fff3e0,stroke:#f5a623,stroke-width:2px\n`;
            mermaid += `    classDef action fill:#e8f5e9,stroke:#4caf50,stroke-width:2px\n`;
            mermaid += `    classDef result fill:#fce4ec,stroke:#e91e63,stroke-width:2px\n`;
            mermaid += `    classDef chip fill:#f5f5f5,stroke:#999,stroke-width:1px,font-size:10px\n\n`;
            
            // Group nodes by STAR
            const layers = {situation: [], task: [], action: [], result: []};
            story.nodes.forEach(node => {
                if (layers[node.starComponent]) {
                    layers[node.starComponent].push(node);
                }
            });
            
            // Create subgraphs for each STAR component
            const starLabels = {
                situation: 'SITUATION üèîÔ∏è',
                task: 'TASK üéØ',
                action: 'ACTIONS ‚ö°',
                result: 'RESULTS üíé'
            };
            
            let nodeIds = {};
            let nodeCounter = 0;
            
            ['situation', 'task', 'action', 'result'].forEach(component => {
                const nodes = layers[component];
                if (nodes.length === 0) return;
                
                mermaid += `    subgraph ${component.toUpperCase()}["${starLabels[component]}"]\n`;
                
                nodes.forEach(node => {
                    const nodeId = `N${nodeCounter++}`;
                    nodeIds[node.id] = nodeId;
                    
                    // Truncate title to reasonable length
                    const title = (node.eventTitle || 'Event').substring(0, 30);
                    const keyword = node.visual?.anchor?.keyword || '';
                    const emoji = node.visual?.anchor?.emoji || 'üìå';
                    
                    // Node with emoji and keyword
                    mermaid += `        ${nodeId}["${emoji} ${title}<br/><b>üîë ${keyword}</b>"]\n`;
                    
                    // Add chips as small connected nodes
                    const chips = node.detailChips || [];
                    chips.forEach((chip, chipIdx) => {
                        const chipId = `${nodeId}C${chipIdx}`;
                        const chipEmoji = CHIP_TYPES[chip.type]?.emoji || 'üìù';
                        const chipTitle = chip.title.substring(0, 20);
                        mermaid += `        ${chipId}(("${chipEmoji} ${chipTitle}"))\n`;
                        mermaid += `        ${nodeId} -.- ${chipId}\n`;
                    });
                });
                
                mermaid += `    end\n\n`;
            });
            
            // Apply styles
            ['situation', 'task', 'action', 'result'].forEach(component => {
                const nodes = layers[component];
                nodes.forEach(node => {
                    const nodeId = nodeIds[node.id];
                    if (nodeId) {
                        mermaid += `    class ${nodeId} ${component}\n`;
                    }
                });
            });
            
            // Add flow connections between STAR layers
            mermaid += `\n    %% STAR Flow\n`;
            const componentOrder = ['situation', 'task', 'action', 'result'];
            for (let i = 0; i < componentOrder.length - 1; i++) {
                const currentNodes = layers[componentOrder[i]];
                const nextNodes = layers[componentOrder[i + 1]];
                if (currentNodes.length > 0 && nextNodes.length > 0) {
                    // Connect last of current to first of next
                    const fromId = nodeIds[currentNodes[currentNodes.length - 1].id];
                    const toId = nodeIds[nextNodes[0].id];
                    if (fromId && toId) {
                        mermaid += `    ${fromId} --> ${toId}\n`;
                    }
                }
            }
            
            // Show in modal with copy option
            showMermaidExportModal(mermaid, story.title);
            document.getElementById('export-menu').style.display = 'none';
        }
        
        function showMermaidExportModal(mermaidCode, title) {
            const modalHtml = `
                <div id="mermaid-export-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px;" onclick="if(event.target === this) this.remove()">
                    <div style="background: white; border-radius: 15px; padding: 25px; width: 100%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">üßú Mermaid Diagram: ${title || 'Story Web'}</h3>
                            <button onclick="this.closest('#mermaid-export-modal').remove()" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">√ó</button>
                        </div>
                        
                        <p style="color: #666; margin-bottom: 15px;">
                            Copy this code and paste into <a href="https://mermaid.live" target="_blank" style="color: var(--color-primary);">Mermaid Live Editor</a> 
                            or any Markdown file that supports Mermaid diagrams.
                        </p>
                        
                        <div style="position: relative;">
                            <textarea id="mermaid-code" readonly style="width: 100%; height: 300px; font-family: monospace; font-size: 0.85em; padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: #f8f9fa;">${mermaidCode}</textarea>
                            <button onclick="copyMermaidCode()" style="position: absolute; top: 10px; right: 10px; padding: 8px 15px; background: var(--color-primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                üìã Copy
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="downloadMermaidFile()">üíæ Download .mmd File</button>
                            <a href="https://mermaid.live" target="_blank" class="btn btn-secondary">Open Mermaid Live ‚Üí</a>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function copyMermaidCode() {
            const textarea = document.getElementById('mermaid-code');
            textarea.select();
            document.execCommand('copy');
            alert('Copied to clipboard!');
        }
        
        function downloadMermaidFile() {
            const code = document.getElementById('mermaid-code').value;
            const blob = new Blob([code], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `story-web-diagram.mmd`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        async function exportToMarkdown() {
            const storyId = window.currentWebStoryId;
            if (!storyId) {
                alert('Please select a story first.');
                return;
            }
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story || !story.nodes?.length) {
                alert('No nodes to export.');
                return;
            }
            
            // Generate Markdown
            let md = `# ${story.title || 'Story Web'}\n\n`;
            md += `*Exported: ${new Date().toLocaleString()}*\n\n`;
            md += `---\n\n`;
            
            // Group by STAR
            const layers = {situation: [], task: [], action: [], result: []};
            story.nodes.forEach(node => {
                if (layers[node.starComponent]) {
                    layers[node.starComponent].push(node);
                }
            });
            
            const starLabels = {
                situation: 'üèîÔ∏è SITUATION',
                task: 'üéØ TASK',
                action: '‚ö° ACTIONS',
                result: 'üíé RESULTS'
            };
            
            ['situation', 'task', 'action', 'result'].forEach(component => {
                const nodes = layers[component];
                if (nodes.length === 0) return;
                
                md += `## ${starLabels[component]}\n\n`;
                
                nodes.forEach(node => {
                    const emoji = node.visual?.anchor?.emoji || 'üìå';
                    const keyword = node.visual?.anchor?.keyword || '';
                    
                    md += `### ${emoji} ${node.eventTitle}\n\n`;
                    md += `**üîë Memory Anchor:** ${keyword}\n\n`;
                    
                    // Dimensions
                    if (node.dimensions) {
                        if (node.dimensions.stakeholders?.length) {
                            md += `**Stakeholders:** ${Array.isArray(node.dimensions.stakeholders) ? node.dimensions.stakeholders.join(', ') : node.dimensions.stakeholders}\n\n`;
                        }
                        if (node.dimensions.problem) md += `**Problem:** ${node.dimensions.problem}\n\n`;
                        if (node.dimensions.solution) md += `**Solution:** ${node.dimensions.solution}\n\n`;
                        if (node.dimensions.metrics) md += `**üìä Metrics:** ${node.dimensions.metrics}\n\n`;
                        if (node.dimensions.alternatives) md += `**Alternatives:** ${node.dimensions.alternatives}\n\n`;
                        if (node.dimensions.tradeoffs) md += `**Tradeoffs:** ${node.dimensions.tradeoffs}\n\n`;
                    }
                    
                    // LPs
                    if (node.leadershipPrinciples?.length) {
                        md += `**üéØ LPs:** ${node.leadershipPrinciples.join(', ')}\n\n`;
                    }
                    
                    // Chips
                    const chips = node.detailChips || [];
                    if (chips.length > 0) {
                        md += `**üè∑Ô∏è Detail Chips:**\n`;
                        chips.forEach(chip => {
                            const chipEmoji = CHIP_TYPES[chip.type]?.emoji || 'üìù';
                            md += `- ${chipEmoji} **${chip.title}**: ${chip.content}\n`;
                        });
                        md += `\n`;
                    }
                    
                    md += `---\n\n`;
                });
            });
            
            // Summary
            const allLPs = [...new Set(story.nodes.flatMap(n => n.leadershipPrinciples || []).filter(lp => lp))];
            const totalChips = story.nodes.reduce((sum, n) => sum + (n.detailChips?.length || 0), 0);
            
            md += `## üìä Summary\n\n`;
            md += `- **Total Events:** ${story.nodes.length}\n`;
            md += `- **LPs Covered:** ${allLPs.length} (${allLPs.join(', ')})\n`;
            md += `- **Detail Chips:** ${totalChips}\n`;
            
            // Download
            const blob = new Blob([md], {type: 'text/markdown'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${story.title?.replace(/[^a-z0-9]/gi, '-') || 'story-web'}.md`;
            a.click();
            URL.revokeObjectURL(url);
            
            document.getElementById('export-menu').style.display = 'none';
        }

        async function addEventNode() {
            const storyId = document.getElementById('web-story-select').value;
            if (!storyId) {
                alert('Please select a story first.');
                return;
            }
            
            const title = document.getElementById('event-title').value.trim();
            if (!title) {
                alert('Please enter an event title.');
                return;
            }

            const node = {
                id: 'node_' + Date.now(),
                eventTitle: title,
                starComponent: document.getElementById('event-star-component').value,
                dimensions: {
                    stakeholders: document.getElementById('event-stakeholders').value.split(',').map(s => s.trim()).filter(s => s),
                    problem: document.getElementById('event-problem').value,
                    solution: document.getElementById('event-solution').value,
                    alternatives: document.getElementById('event-alternatives').value,
                    metrics: document.getElementById('event-metrics').value,
                    tradeoffs: document.getElementById('event-tradeoffs').value
                },
                visual: {
                    anchor: {
                        emoji: document.getElementById('event-emoji').value || 'üìå',
                        keyword: document.getElementById('event-keyword').value || title.split(' ')[0]
                    }
                },
                leadershipPrinciples: Array.from(document.querySelectorAll('#event-lps input:checked')).map(cb => cb.value)
            };

            const stories = await storage.load('stories') || {};
            if (!stories[storyId]) {
                stories[storyId] = {id: storyId, title: storyId, nodes: [], connections: []};
            }
            stories[storyId].nodes.push(node);
            
            await storage.save('stories', stories);
            
            // Clear all form fields
            document.getElementById('event-title').value = '';
            document.getElementById('event-stakeholders').value = '';
            document.getElementById('event-problem').value = '';
            document.getElementById('event-solution').value = '';
            document.getElementById('event-alternatives').value = '';
            document.getElementById('event-metrics').value = '';
            document.getElementById('event-tradeoffs').value = '';
            document.getElementById('event-emoji').value = '';
            document.getElementById('event-keyword').value = '';
            document.querySelectorAll('#event-lps input:checked').forEach(cb => cb.checked = false);
            
            // Hide manual editor and refresh canvas
            toggleManualEditor();
            await loadStoryWeb();
        }

        async function saveStoryWeb() {
            // Stories are auto-saved when nodes are added
            alert('Story web is auto-saved!');
        }

        // ==================== TAB 3: LP COVERAGE ====================
        async function analyzeCoverage() {
            const storiesText = document.getElementById('stories-bulk-input').value.trim();
            if (!storiesText) {
                alert('Please paste your stories!');
                return;
            }

            const stories = storiesText.split(/---+|\n\n\n/).filter(s => s.trim().length > 100);
            const loading = document.getElementById('coverage-loading');
            const results = document.getElementById('coverage-results');

            loading.classList.add('show');
            results.classList.remove('show');

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 4000,
                        messages: [{
                            role: "user",
                            content: `Analyze LP coverage for ${stories.length} ${CURRENT_COMPANY} stories.

STORIES: ${stories.map((s, i) => `Story ${i+1}: ${s.substring(0, 500)}`).join('\n\n')}

Respond with JSON:
{
  "coverage_matrix": {
    "Dive Deep": [2, 0, 3],
    "Ownership": [3, 2, 1]
  },
  "gaps": ["Need more Backbone stories"],
  "strongest": ["Deliver Results"],
  "mece_score": 7
}`
                        }]
                    })
                });

                const data = await response.json();
                const text = data.content[0].text.replace(/```json|```/g, "").trim();
                const analysis = JSON.parse(text);
                displayCoverageMap(analysis, stories.length);
            } catch (error) {
                console.error('Error:', error);
                alert('Error analyzing coverage.');
            } finally {
                loading.classList.remove('show');
            }
        }

        function displayCoverageMap(analysis, storyCount) {
            const results = document.getElementById('coverage-results');
            const lps = Object.keys(analysis.coverage_matrix);
            
            let gridHTML = `
                <div class="heatmap-cell heatmap-label">Leadership Principle</div>
                ${Array.from({length: storyCount}, (_, i) => `
                    <div class="heatmap-cell heatmap-header">Story ${i+1}</div>
                `).join('')}
            `;

            lps.forEach(lp => {
                gridHTML += `<div class="heatmap-cell heatmap-label">${lp}</div>`;
                analysis.coverage_matrix[lp].forEach(score => {
                    const coverageClass = score === 0 ? 'coverage-none' :
                                        score === 1 ? 'coverage-low' :
                                        score === 2 ? 'coverage-medium' : 'coverage-high';
                    gridHTML += `<div class="heatmap-cell ${coverageClass}">${score === 0 ? '-' : score}</div>`;
                });
            });

            results.innerHTML = `
                <div class="heatmap-container">
                    <h2>LP Coverage Heat Map</h2>
                    <p>MECE Score: ${analysis.mece_score}/10</p>
                    <div class="heatmap-grid">${gridHTML}</div>
                </div>
                <div class="guide-section">
                    <h3>‚úÖ Strongest LPs</h3>
                    <ul>${analysis.strongest.map(lp => `<li>${lp}</li>`).join('')}</ul>
                </div>
                <div class="highlight-box">
                    <strong>‚ö†Ô∏è Gaps:</strong>
                    <ul>${analysis.gaps.map(gap => `<li>${gap}</li>`).join('')}</ul>
                </div>
            `;
            results.classList.add('show');
        }

        // ==================== TAB 4: QUESTION DRILL ====================
        async function startQuestionDrill() {
            const selectedLPs = Array.from(document.querySelectorAll('#drill-lp-selection input:checked')).map(cb => cb.value);
            if (selectedLPs.length === 0) {
                alert('Please select at least one Leadership Principle!');
                return;
            }

            document.getElementById('drill-session').style.display = 'block';
            
            // Generate question
            const lp = selectedLPs[Math.floor(Math.random() * selectedLPs.length)];
            const question = await generateQuestion(lp);
            const questionId = 'q_' + lp.toLowerCase().replace(/ /g, '_') + '_' + Date.now();
            
            document.getElementById('drill-question').textContent = question;
            
            currentDrill = {
                question: question,
                questionId: questionId,
                lp: lp,
                startTime: Date.now(),
                followUps: []
            };

            // Reset previous state
            document.getElementById('drill-evaluation').classList.remove('show');
            document.getElementById('followup-section').style.display = 'none';
            document.getElementById('followup-container').innerHTML = '';
            document.getElementById('drill-response').value = '';
            starTimings = {situation: 0, task: 0, action: 0, result: 0};
            currentTimerSeconds = 0;
        }

        async function generateQuestion(lp) {
            const questions = QUESTION_BANK[lp] || [];
            if (questions.length === 0) {
                return "Tell me about a time you demonstrated " + lp;
            }
            
            // Check which questions from this LP haven't been practiced recently
            const history = await storage.load('practice_history') || {sessions: []};
            const recentQuestions = history.sessions
                .filter(s => s.lp === lp)
                .map(s => s.question)
                .slice(-5); // Last 5 questions
            
            // Prefer questions not recently practiced
            const unasked = questions.filter(q => !recentQuestions.includes(q));
            const pool = unasked.length > 0 ? unasked : questions;
            
            return pool[Math.floor(Math.random() * pool.length)];
        }

        async function showQuestionHints() {
            const question = document.getElementById('drill-question').textContent;
            const hints = document.getElementById('question-hints');
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 500,
                        messages: [{
                            role: "user",
                            content: `Tag this interview question into parts:

"${question}"

Respond with JSON:
{"tags": [{"type": "context", "text": "..."}, {"type": "specific_ask", "text": "..."}]}`
                        }]
                    })
                });

                const data = await response.json();
                const text = data.content[0].text.replace(/```json|```/g, "").trim();
                const tagged = JSON.parse(text);
                
                hints.innerHTML = `
                    <div class="question-tags">
                        ${tagged.tags.map(tag => `
                            <span class="question-tag ${tag.type}">${tag.type}: ${tag.text}</span>
                        `).join('')}
                    </div>
                `;
                hints.style.display = 'block';
            } catch (err) {
                console.error(err);
            }
        }

        function toggleRecording() {
            const btn = document.getElementById('record-btn');
            if (!audioRecorder) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({audio: true});
                audioRecorder = new MediaRecorder(stream);
                const chunks = [];
                
                audioRecorder.ondataavailable = e => chunks.push(e.data);
                audioRecorder.onstop = () => {
                    audioBlob = new Blob(chunks, {type: 'audio/webm'});
                    document.getElementById('playback-btn').style.display = 'inline-block';
                    document.getElementById('audio-wave').textContent = '‚úÖ Recording captured';
                };
                
                audioRecorder.start();
                document.getElementById('record-btn').textContent = '‚èπ Stop Recording';
                document.getElementById('record-btn').classList.remove('btn-danger');
                document.getElementById('record-btn').classList.add('btn-warning');
                
                // Start timer
                startTimer();
            } catch (err) {
                alert('Microphone access denied. Please type your response.');
            }
        }

        function stopRecording() {
            if (audioRecorder && audioRecorder.state !== 'inactive') {
                audioRecorder.stop();
                audioRecorder.stream.getTracks().forEach(track => track.stop());
                audioRecorder = null;
                
                document.getElementById('record-btn').textContent = 'üé§ Start Recording';
                document.getElementById('record-btn').classList.remove('btn-warning');
                document.getElementById('record-btn').classList.add('btn-danger');
                
                stopTimer();
            }
        }

        function playbackAudio() {
            if (audioBlob) {
                const url = URL.createObjectURL(audioBlob);
                const audio = new Audio(url);
                audio.play();
            }
        }

        function startTimer() {
            currentTimerSeconds = 0;
            const timerDisplay = document.getElementById('main-timer');
            const timerValue = document.getElementById('timer-value');
            
            timerDisplay.classList.add('running');
            
            if (document.getElementById('timer-visible').checked) {
                document.getElementById('star-breakdown').style.display = 'grid';
            }
            
            timerInterval = setInterval(() => {
                currentTimerSeconds++;
                const mins = Math.floor(currentTimerSeconds / 60);
                const secs = currentTimerSeconds % 60;
                timerValue.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                // Update STAR component timings (simplified - would need manual marking in production)
                starTimings[currentComponent]++;
                updateSTARDisplay();
                
                if (currentTimerSeconds >= 60) {
                    timerDisplay.classList.add('expired');
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                document.getElementById('main-timer').classList.remove('running');
            }
        }

        function updateSTARDisplay() {
            document.getElementById('timer-s').textContent = starTimings.situation + 's';
            document.getElementById('timer-t').textContent = starTimings.task + 's';
            document.getElementById('timer-a').textContent = starTimings.action + 's';
            document.getElementById('timer-r').textContent = starTimings.result + 's';
        }

        async function submitDrillResponse() {
            const response = document.getElementById('drill-response').value.trim();
            if (!response) {
                alert('Please provide a response!');
                return;
            }

            stopTimer();
            
            // Evaluate response
            try {
                const evalResponse = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 3000,
                        messages: [{
                            role: "user",
                            content: `Evaluate this ${CURRENT_COMPANY} interview response.

QUESTION: ${currentDrill.question}
RESPONSE: ${response}

Respond with JSON:
{
  "score": 85,
  "starStructure": {"situation": {"present": true, "feedback": "..."}},
  "lpDemonstration": {"Dive Deep": {"score": 8, "evidence": "..."}},
  "strengths": ["..."],
  "weaknesses": ["..."]
}`
                        }]
                    })
                });

                const data = await evalResponse.json();
                const text = data.content[0].text.replace(/```json|```/g, "").trim();
                const evaluation = JSON.parse(text);
                
                displayDrillEvaluation(evaluation);
                currentDrill.evaluation = evaluation;
                currentDrill.response = response;
                
                document.getElementById('followup-section').style.display = 'block';
            } catch (err) {
                console.error(err);
                alert('Error evaluating response.');
            }
        }

        function displayDrillEvaluation(evaluation) {
            const container = document.getElementById('drill-evaluation');
            
            // Store evaluation for saving to story web
            window.lastDrillEvaluation = evaluation;
            
            container.innerHTML = `
                <div class="evaluation-card">
                    <h3>Response Evaluation</h3>
                    <div class="score-display">${evaluation.score}/100</div>
                    
                    <div class="feedback-section">
                        <h4>‚úÖ Strengths</h4>
                        ${evaluation.strengths.map(s => `
                            <div class="feedback-item strength">${s}</div>
                        `).join('')}
                    </div>
                    
                    ${evaluation.weaknesses.length > 0 ? `
                        <div class="feedback-section">
                            <h4>‚ö†Ô∏è Areas to Improve</h4>
                            ${evaluation.weaknesses.map(w => `
                                <div class="feedback-item weakness">${w}</div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #eee;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                            <button class="btn btn-sm btn-primary" onclick="generateNodeFromResponse()">
                                ü§ñ Generate Story Node from Response
                            </button>
                            <button class="btn btn-sm btn-success" onclick="showSaveToStoryWebModal()">
                                üíæ Save as Detail Chip
                            </button>
                        </div>
                        <p style="font-size: 0.8em; color: #666; margin: 0;">
                            Generate Node = Creates new event in Story Web | Save Chip = Adds detail to existing node
                        </p>
                    </div>
                </div>
            `;
            container.classList.add('show');
        }
        
        async function generateNodeFromResponse() {
            if (!currentDrill?.response) {
                alert('No response found to generate from.');
                return;
            }
            
            const stories = await storage.load('stories') || {};
            const storyKeys = Object.keys(stories);
            
            if (storyKeys.length === 0) {
                alert('No stories found. Please analyze a story first in Tab 1.');
                return;
            }
            
            // Show loading modal
            const loadingHtml = `
                <div id="generate-node-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px;">
                    <div style="background: white; border-radius: 15px; padding: 30px; text-align: center; max-width: 400px;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 15px;">Analyzing your response and generating node...</p>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', loadingHtml);
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 2000,
                        messages: [{
                            role: "user",
                            content: `Analyze this interview practice response and create a story web node that captures the key event/action described.

INTERVIEW QUESTION: ${currentDrill.question}

CANDIDATE'S RESPONSE: ${currentDrill.response}

${currentDrill.followUps?.length > 0 ? `FOLLOW-UP Q&A:\n${currentDrill.followUps.map(f => `Q: ${f.question}\nA: ${f.response || '(not answered)'}`).join('\n\n')}` : ''}

Create a structured node capturing the main event/action from this response. Extract specific details, metrics, and leadership principles demonstrated.

Respond ONLY with valid JSON (no markdown):
{
  "eventTitle": "3-6 word title describing the key action/event",
  "starComponent": "situation|task|action|result",
  "dimensions": {
    "stakeholders": ["who was involved"],
    "problem": "what challenge or context was described",
    "solution": "what action was taken",
    "metrics": "specific numbers, percentages, or impact mentioned",
    "alternatives": "other options considered if mentioned",
    "tradeoffs": "any tradeoffs or challenges faced"
  },
  "visual": {
    "anchor": {
      "emoji": "single relevant emoji",
      "keyword": "one memorable word from the response"
    }
  },
  "leadershipPrinciples": ["LP1", "LP2"],
  "keyQuotes": ["1-2 strong phrases from the response worth remembering"]
}`
                        }]
                    })
                });

                const data = await response.json();
                let nodeData;
                
                try {
                    const text = data.content[0].text;
                    const cleaned = text.replace(/```json\n?|\n?```/g, '').trim();
                    nodeData = JSON.parse(cleaned);
                } catch (e) {
                    throw new Error('Failed to parse AI response');
                }
                
                // Remove loading, show review modal
                document.getElementById('generate-node-modal').remove();
                showGeneratedNodeReview(nodeData, storyKeys, stories);
                
            } catch (error) {
                console.error('Generate node error:', error);
                document.getElementById('generate-node-modal')?.remove();
                alert('Error generating node. Please try again.');
            }
        }
        
        function showGeneratedNodeReview(nodeData, storyKeys, stories) {
            const starColors = {
                situation: '#e3f2fd',
                task: '#fff8e1',
                action: '#e8f5e9',
                result: '#fce4ec'
            };
            const starEmojis = {
                situation: 'üèîÔ∏è',
                task: 'üéØ',
                action: '‚ö°',
                result: 'üíé'
            };
            
            // Store for editing
            window.generatedNodeData = nodeData;
            window.availableStories = stories;
            
            // Default to first story with nodes
            const defaultStoryId = storyKeys.find(k => stories[k].nodes?.length > 0) || storyKeys[0];
            
            const modalHtml = `
                <div id="review-node-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px;" onclick="if(event.target === this) this.remove()">
                    <div style="background: white; border-radius: 15px; padding: 25px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto;">
                        <h3 style="margin: 0 0 15px;">ü§ñ AI Generated Content - Review & Place</h3>
                        
                        <!-- Preview of generated content -->
                        <div style="background: ${starColors[nodeData.starComponent] || '#f5f5f5'}; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                <span style="font-size: 2em;">${nodeData.visual?.anchor?.emoji || 'üìå'}</span>
                                <div>
                                    <div style="font-weight: bold; font-size: 1.1em;">${nodeData.eventTitle}</div>
                                    <div style="font-size: 0.85em; color: #666;">
                                        ${starEmojis[nodeData.starComponent]} ${nodeData.starComponent?.charAt(0).toUpperCase() + nodeData.starComponent?.slice(1)}
                                        ${nodeData.dimensions?.metrics ? ` ‚Ä¢ üìä ${nodeData.dimensions.metrics}` : ''}
                                    </div>
                                </div>
                            </div>
                            ${nodeData.dimensions?.solution ? `<div style="font-size: 0.9em; color: #444;">${nodeData.dimensions.solution}</div>` : ''}
                            ${nodeData.keyQuotes?.length ? `<div style="margin-top: 10px; font-style: italic; font-size: 0.85em; color: #666;">"${nodeData.keyQuotes[0]}"</div>` : ''}
                        </div>
                        
                        <!-- Step 1: Select Story -->
                        <div style="margin-bottom: 20px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 8px;">1Ô∏è‚É£ Which story does this belong to?</label>
                            <select id="gen-node-story" onchange="updateExistingNodesForAttachment()" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                                ${storyKeys.map(key => `<option value="${key}" ${key === defaultStoryId ? 'selected' : ''}>${stories[key].title || key}</option>`).join('')}
                            </select>
                        </div>
                        
                        <!-- Step 2: Attachment Type - 3 options -->
                        <div style="margin-bottom: 20px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 8px;">2Ô∏è‚É£ How should this be added?</label>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <label id="option-chip" style="padding: 15px; border: 2px solid #4CAF50; border-radius: 10px; cursor: pointer; background: #e8f5e9;" onclick="selectAttachmentType('chip')">
                                    <input type="radio" name="attachment-type" value="chip" checked style="margin-right: 8px;">
                                    <strong>üè∑Ô∏è Add as Detail Chip</strong>
                                    <div style="font-size: 0.8em; color: #666; margin-top: 5px; margin-left: 24px;">Metadata attached inside an existing node (for small details, metrics, quotes)</div>
                                </label>
                                <label id="option-child" style="padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; background: white;" onclick="selectAttachmentType('child')">
                                    <input type="radio" name="attachment-type" value="child" style="margin-right: 8px;">
                                    <strong>üîó Add as Linked Child Node</strong>
                                    <div style="font-size: 0.8em; color: #666; margin-top: 5px; margin-left: 24px;">Separate card connected to parent node (for elaborations, sub-events)</div>
                                </label>
                                <label id="option-standalone" style="padding: 15px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; background: white;" onclick="selectAttachmentType('standalone')">
                                    <input type="radio" name="attachment-type" value="standalone" style="margin-right: 8px;">
                                    <strong>‚ûï Create Standalone Node</strong>
                                    <div style="font-size: 0.8em; color: #666; margin-top: 5px; margin-left: 24px;">Independent node, not linked to anything (for completely new events)</div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Step 3: Select parent node (shown for chip and child options) -->
                        <div id="existing-node-selector" style="margin-bottom: 20px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 8px;">3Ô∏è‚É£ Attach to which node?</label>
                            <div id="existing-nodes-list" style="max-height: 200px; overflow-y: auto; border: 2px solid #ddd; border-radius: 8px;">
                                <!-- Populated by updateExistingNodesForAttachment -->
                            </div>
                        </div>
                        
                        <!-- Standalone node options (hidden by default) -->
                        <div id="standalone-options" style="display: none; margin-bottom: 20px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 8px;">3Ô∏è‚É£ Configure new node:</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <select id="gen-node-star" style="padding: 10px; border-radius: 6px; border: 1px solid #ddd;">
                                    <option value="situation" ${nodeData.starComponent === 'situation' ? 'selected' : ''}>üèîÔ∏è Situation</option>
                                    <option value="task" ${nodeData.starComponent === 'task' ? 'selected' : ''}>üéØ Task</option>
                                    <option value="action" ${nodeData.starComponent === 'action' ? 'selected' : ''}>‚ö° Action</option>
                                    <option value="result" ${nodeData.starComponent === 'result' ? 'selected' : ''}>üíé Result</option>
                                </select>
                                <input type="text" id="gen-node-keyword" value="${nodeData.visual?.anchor?.keyword || ''}" placeholder="Keyword anchor" style="padding: 10px; border-radius: 6px; border: 1px solid #ddd; flex: 1;">
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="confirmAddGeneratedNode()">‚úÖ Add to Story Web</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('review-node-modal').remove()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Initialize the existing nodes list
            updateExistingNodesForAttachment();
        }
        
        function selectAttachmentType(type) {
            const chipLabel = document.getElementById('option-chip');
            const childLabel = document.getElementById('option-child');
            const standaloneLabel = document.getElementById('option-standalone');
            
            // Reset all
            [chipLabel, childLabel, standaloneLabel].forEach(label => {
                label.style.border = '2px solid #ddd';
                label.style.background = 'white';
            });
            
            // Highlight selected
            if (type === 'chip') {
                chipLabel.style.border = '2px solid #4CAF50';
                chipLabel.style.background = '#e8f5e9';
                document.getElementById('existing-node-selector').style.display = 'block';
                document.getElementById('standalone-options').style.display = 'none';
            } else if (type === 'child') {
                childLabel.style.border = '2px solid #2196F3';
                childLabel.style.background = '#e3f2fd';
                document.getElementById('existing-node-selector').style.display = 'block';
                document.getElementById('standalone-options').style.display = 'none';
            } else {
                standaloneLabel.style.border = '2px solid #ff9800';
                standaloneLabel.style.background = '#fff3e0';
                document.getElementById('existing-node-selector').style.display = 'none';
                document.getElementById('standalone-options').style.display = 'block';
            }
        }
        
        function updateExistingNodesForAttachment() {
            const storyId = document.getElementById('gen-node-story').value;
            const story = window.availableStories[storyId];
            const container = document.getElementById('existing-nodes-list');
            
            if (!story?.nodes?.length) {
                container.innerHTML = `<div style="padding: 20px; text-align: center; color: #666;">
                    No nodes in this story yet. Choose "Create new standalone node" instead.
                </div>`;
                return;
            }
            
            const starEmojis = { situation: 'üèîÔ∏è', task: 'üéØ', action: '‚ö°', result: 'üíé' };
            
            container.innerHTML = story.nodes.map((node, idx) => `
                <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;" 
                       onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                    <input type="radio" name="attach-to-node" value="${node.id}" ${idx === 0 ? 'checked' : ''} style="width: 18px; height: 18px;">
                    <span style="font-size: 1.5em;">${node.visual?.anchor?.emoji || 'üìå'}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">${node.eventTitle || 'Untitled'}</div>
                        <div style="font-size: 0.8em; color: #666;">
                            ${starEmojis[node.starComponent]} ${node.starComponent} ‚Ä¢ üîë ${node.visual?.anchor?.keyword || '‚Äî'}
                            ${node.detailChips?.length ? ` ‚Ä¢ üè∑Ô∏è ${node.detailChips.length} chips` : ''}
                        </div>
                    </div>
                </label>
            `).join('');
        }
        
        async function confirmAddGeneratedNode() {
            const storyId = document.getElementById('gen-node-story').value;
            if (!storyId) {
                alert('Please select a story.');
                return;
            }
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            if (!story) return;
            
            const attachmentType = document.querySelector('input[name="attachment-type"]:checked')?.value || 'chip';
            
            if (attachmentType === 'chip') {
                // Add as detail chip to existing node
                const selectedNodeId = document.querySelector('input[name="attach-to-node"]:checked')?.value;
                if (!selectedNodeId) {
                    alert('Please select a node to attach to.');
                    return;
                }
                
                const targetNode = story.nodes.find(n => n.id === selectedNodeId);
                if (!targetNode) {
                    alert('Selected node not found.');
                    return;
                }
                
                // Create a rich detail chip from the generated content
                const chip = {
                    id: 'chip_' + Date.now(),
                    type: 'detail',
                    title: window.generatedNodeData.eventTitle,
                    content: [
                        window.generatedNodeData.dimensions?.solution,
                        window.generatedNodeData.dimensions?.metrics ? `üìä ${window.generatedNodeData.dimensions.metrics}` : null,
                        window.generatedNodeData.keyQuotes?.[0] ? `"${window.generatedNodeData.keyQuotes[0]}"` : null
                    ].filter(Boolean).join('\n\n'),
                    createdAt: new Date().toISOString(),
                    createdFrom: 'AI Generated from Practice',
                    sourceData: {
                        starComponent: window.generatedNodeData.starComponent,
                        lps: window.generatedNodeData.leadershipPrinciples,
                        emoji: window.generatedNodeData.visual?.anchor?.emoji
                    }
                };
                
                // Determine chip type based on content
                if (window.generatedNodeData.dimensions?.metrics) {
                    chip.type = 'metric';
                } else if (window.generatedNodeData.leadershipPrinciples?.length) {
                    chip.type = 'insight';
                }
                
                targetNode.detailChips = targetNode.detailChips || [];
                targetNode.detailChips.push(chip);
                
                await storage.save('stories', stories);
                document.getElementById('review-node-modal').remove();
                alert(`‚úÖ Added detail chip to "${targetNode.eventTitle}"!\n\nView it in Tab 2: Story Web.`);
                
            } else if (attachmentType === 'child') {
                // Create child node linked to parent
                const selectedNodeId = document.querySelector('input[name="attach-to-node"]:checked')?.value;
                if (!selectedNodeId) {
                    alert('Please select a parent node.');
                    return;
                }
                
                const parentNode = story.nodes.find(n => n.id === selectedNodeId);
                if (!parentNode) {
                    alert('Selected parent node not found.');
                    return;
                }
                
                // Create child node with parentId reference
                const childNode = {
                    id: 'node_' + Date.now(),
                    parentId: selectedNodeId, // Link to parent!
                    eventTitle: window.generatedNodeData.eventTitle,
                    starComponent: parentNode.starComponent, // Inherit parent's STAR component
                    dimensions: {
                        stakeholders: window.generatedNodeData.dimensions?.stakeholders || [],
                        problem: window.generatedNodeData.dimensions?.problem || '',
                        solution: window.generatedNodeData.dimensions?.solution || '',
                        metrics: window.generatedNodeData.dimensions?.metrics || '',
                        alternatives: window.generatedNodeData.dimensions?.alternatives || '',
                        tradeoffs: window.generatedNodeData.dimensions?.tradeoffs || ''
                    },
                    visual: {
                        anchor: {
                            emoji: window.generatedNodeData.visual?.anchor?.emoji || 'üìå',
                            keyword: window.generatedNodeData.visual?.anchor?.keyword || ''
                        }
                    },
                    leadershipPrinciples: window.generatedNodeData.leadershipPrinciples || [],
                    detailChips: [],
                    generatedFrom: 'practice-response',
                    generatedAt: new Date().toISOString()
                };
                
                // Add key quote as initial chip
                if (window.generatedNodeData.keyQuotes?.length) {
                    childNode.detailChips.push({
                        id: 'chip_' + Date.now(),
                        type: 'insight',
                        title: 'Key Quote',
                        content: window.generatedNodeData.keyQuotes[0],
                        createdAt: new Date().toISOString(),
                        createdFrom: 'AI Generated'
                    });
                }
                
                story.nodes.push(childNode);
                await storage.save('stories', stories);
                
                document.getElementById('review-node-modal').remove();
                alert(`‚úÖ Created child node "${childNode.eventTitle}" linked to "${parentNode.eventTitle}"!\n\nView it in Tab 2: Story Web.`);
                
            } else {
                // Create new standalone node (not linked to anything)
                const node = {
                    id: 'node_' + Date.now(),
                    eventTitle: window.generatedNodeData.eventTitle,
                    starComponent: document.getElementById('gen-node-star').value,
                    dimensions: {
                        stakeholders: window.generatedNodeData.dimensions?.stakeholders || [],
                        problem: window.generatedNodeData.dimensions?.problem || '',
                        solution: window.generatedNodeData.dimensions?.solution || '',
                        metrics: window.generatedNodeData.dimensions?.metrics || '',
                        alternatives: window.generatedNodeData.dimensions?.alternatives || '',
                        tradeoffs: window.generatedNodeData.dimensions?.tradeoffs || ''
                    },
                    visual: {
                        anchor: {
                            emoji: window.generatedNodeData.visual?.anchor?.emoji || 'üìå',
                            keyword: document.getElementById('gen-node-keyword').value || window.generatedNodeData.visual?.anchor?.keyword || ''
                        }
                    },
                    leadershipPrinciples: window.generatedNodeData.leadershipPrinciples || [],
                    detailChips: [],
                    generatedFrom: 'practice-response',
                    generatedAt: new Date().toISOString()
                };
                
                // Add key quote as initial chip
                if (window.generatedNodeData.keyQuotes?.length) {
                    node.detailChips.push({
                        id: 'chip_' + Date.now(),
                        type: 'insight',
                        title: 'Key Quote',
                        content: window.generatedNodeData.keyQuotes[0],
                        createdAt: new Date().toISOString(),
                        createdFrom: 'AI Generated'
                    });
                }
                
                story.nodes.push(node);
                await storage.save('stories', stories);
                
                document.getElementById('review-node-modal').remove();
                alert(`‚úÖ Created standalone node "${node.eventTitle}"!\n\nView it in Tab 2: Story Web.`);
            }
        }
        
        async function showSaveToStoryWebModal() {
            const stories = await storage.load('stories') || {};
            const storyKeys = Object.keys(stories);
            
            if (storyKeys.length === 0) {
                alert('No stories found. Analyze a story first in Tab 1.');
                return;
            }
            
            // Build modal content
            let modalHtml = `
                <div id="save-chip-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px;" onclick="if(event.target === this) this.remove()">
                    <div style="background: white; border-radius: 15px; padding: 25px; width: 100%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                        <h3>üíæ Save to Story Web</h3>
                        <p style="color: #666; margin-bottom: 15px;">Save key learnings as a chip attached to a story node.</p>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Select Story</label>
                            <select id="save-chip-story" onchange="updateNodeSelector()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                                <option value="">-- Select story --</option>
                                ${storyKeys.map(key => `<option value="${key}">${stories[key].title || key}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Select Node</label>
                            <select id="save-chip-node" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                                <option value="">-- Select story first --</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Chip Title</label>
                            <input type="text" id="save-chip-title" placeholder="e.g., 'Metrics deep-dive', 'VP pushback'" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Content (key points to remember)</label>
                            <textarea id="save-chip-content" rows="4" placeholder="Summarize the key points from your answer or learnings..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">${window.lastDrillEvaluation?.strengths?.join('; ') || ''}</textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="saveDrillToStoryWeb()">Save Chip</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('save-chip-modal').remove()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        async function updateNodeSelector() {
            const storyId = document.getElementById('save-chip-story').value;
            const nodeSelect = document.getElementById('save-chip-node');
            
            if (!storyId) {
                nodeSelect.innerHTML = '<option value="">-- Select story first --</option>';
                return;
            }
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            
            if (!story || !story.nodes || story.nodes.length === 0) {
                nodeSelect.innerHTML = '<option value="">-- No nodes in this story --</option>';
                return;
            }
            
            const starEmojis = {situation: 'üèîÔ∏è', task: 'üéØ', action: '‚ö°', result: 'üíé'};
            nodeSelect.innerHTML = '<option value="">-- Select node --</option>' + 
                story.nodes.map(n => `<option value="${n.id}">${starEmojis[n.starComponent] || 'üìå'} ${n.eventTitle}</option>`).join('');
        }
        
        async function saveDrillToStoryWeb() {
            const storyId = document.getElementById('save-chip-story').value;
            const nodeId = document.getElementById('save-chip-node').value;
            const title = document.getElementById('save-chip-title').value.trim();
            const content = document.getElementById('save-chip-content').value.trim();
            
            if (!storyId || !nodeId) {
                alert('Please select a story and node.');
                return;
            }
            if (!title || !content) {
                alert('Please fill in title and content.');
                return;
            }
            
            const question = currentDrill?.question || 'Practice drill';
            const success = await saveAnswerAsChip(storyId, nodeId, title, content, `Q: ${question.substring(0, 50)}...`);
            
            if (success) {
                alert('Saved to story web! View in Tab 2.');
                document.getElementById('save-chip-modal')?.remove();
            } else {
                alert('Error saving. Try again.');
            }
        }

        async function generateNextFollowUp() {
            if (!currentDrill) return;
            
            // Track topics and depth for bar-raiser behavior
            const followUpCount = currentDrill.followUps.length;
            const lastFollowUp = currentDrill.followUps[currentDrill.followUps.length - 1];
            
            // Determine if we should go deep or broad
            // Bar raisers typically: 2 deep dives per topic, then pivot to new LP/topic
            const currentDepthOnTopic = currentDrill.currentTopicDepth || 0;
            const shouldPivot = currentDepthOnTopic >= 2;
            
            // LPs we haven't explored yet
            const allLPs = ['Customer Obsession', 'Ownership', 'Invent and Simplify', 'Learn and Be Curious', 
                           'Hire and Develop the Best', 'Insist on Highest Standards', 'Think Big', 'Bias for Action',
                           'Frugality', 'Earn Trust', 'Dive Deep', 'Have Backbone', 'Deliver Results'];
            const exploredLPs = currentDrill.exploredLPs || [];
            const unexploredLPs = allLPs.filter(lp => !exploredLPs.includes(lp));
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 500,
                        messages: [{
                            role: "user",
                            content: `You are a BAR RAISING Amazon interviewer conducting a behavioral interview.

ORIGINAL QUESTION: ${currentDrill.question}
CANDIDATE'S MAIN RESPONSE: ${currentDrill.response}

${currentDrill.followUps.length > 0 ? `FOLLOW-UP HISTORY:
${currentDrill.followUps.map((f, i) => `Q${i+1}: ${f.question}\nA${i+1}: ${f.response || '(pending)'}`).join('\n\n')}` : ''}

INTERVIEW DEPTH: ${followUpCount} follow-ups asked so far
CURRENT TOPIC DEPTH: ${currentDepthOnTopic} questions on current thread

${shouldPivot ? `
‚ö†Ô∏è TIME TO PIVOT: You've gone 2 levels deep on this thread. 
Now CHANGE DIRECTION to explore a DIFFERENT aspect of the story.
Target one of these LPs not yet covered: ${unexploredLPs.slice(0, 3).join(', ')}

Good pivots:
- "Let's step back - tell me about [different stakeholder/challenge]"
- "I want to understand [new LP area] - what about..."
- "You mentioned X earlier, let's explore that instead"
` : `
Keep diving into the current thread (${2 - currentDepthOnTopic} more deep questions allowed).
Look for: specifics, metrics, alternatives considered, who pushed back, what could have gone wrong.
`}

RULES:
1. Ask about SPECIFIC details, not generalities
2. Tie to a Leadership Principle when possible
3. Look for: metrics, tradeoffs, stakeholder conflicts, what they'd do differently
4. If they gave a weak answer, probe harder on that area
5. One question only, be direct

Generate ONE bar-raiser follow-up question:`
                        }]
                    })
                });

                const data = await response.json();
                const followUpQ = data.content[0].text.trim();
                
                // Update depth tracking
                if (shouldPivot) {
                    currentDrill.currentTopicDepth = 1;
                    // Try to detect which LP this new question targets
                    const detectedLP = allLPs.find(lp => followUpQ.toLowerCase().includes(lp.toLowerCase().split(' ')[0]));
                    if (detectedLP) {
                        currentDrill.exploredLPs = [...(currentDrill.exploredLPs || []), detectedLP];
                    }
                } else {
                    currentDrill.currentTopicDepth = (currentDrill.currentTopicDepth || 0) + 1;
                }
                
                const container = document.getElementById('followup-container');
                const followUpDiv = document.createElement('div');
                followUpDiv.className = 'question-card';
                
                // Show depth indicator
                const depthIndicator = shouldPivot ? 'üîÑ PIVOT' : `üìç Depth ${currentDrill.currentTopicDepth}/2`;
                
                followUpDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span class="question-text" style="flex: 1;">${followUpQ}</span>
                        <span style="font-size: 0.75em; background: ${shouldPivot ? '#fff3cd' : '#e3f2fd'}; padding: 3px 8px; border-radius: 10px; margin-left: 10px;">${depthIndicator}</span>
                    </div>
                    <div class="timer-display">‚è± Max 10s</div>
                    <textarea placeholder="Your 10-second response..." rows="3" id="followup-response-${currentDrill.followUps.length}"></textarea>
                    <button class="btn btn-sm btn-primary" onclick="submitFollowUpResponse(${currentDrill.followUps.length}, '${followUpQ.replace(/'/g, "\\'")}')">Submit</button>
                `;
                container.appendChild(followUpDiv);
                
                currentDrill.followUps.push({question: followUpQ, response: null});
                
            } catch (err) {
                console.error(err);
            }
        }

        async function submitFollowUpResponse(index, question) {
            const response = document.getElementById(`followup-response-${index}`).value.trim();
            if (!response) return;
            
            currentDrill.followUps[index].response = response;
            
            // Store for potential save-to-web
            window.lastFollowUpAnswer = {
                question: question,
                response: response
            };
            
            // Store for the save button
            window.lastFollowUpData = { question, response, index };
            
            // Replace textarea with saved response + save option
            const textarea = document.getElementById(`followup-response-${index}`);
            textarea.parentElement.innerHTML = `
                <div class="question-text">${question}</div>
                <div style="background: #f0f8f0; padding: 12px; border-radius: 8px; margin: 10px 0;">
                    <strong>Your answer:</strong> ${response}
                </div>
                <button class="btn btn-sm btn-success" onclick="saveFollowUpToWebFromLast()">
                    üíæ Save to Story Web
                </button>
                <span style="color: #666; font-size: 0.8em; margin-left: 8px;">‚úì Saved</span>
            `;
        }
        
        function saveFollowUpToWebFromLast() {
            if (window.lastFollowUpData) {
                saveFollowUpToWeb(window.lastFollowUpData.question, window.lastFollowUpData.response);
            }
        }
        
        async function saveFollowUpToWeb(question, answer) {
            // Reuse the same modal from drill evaluation
            const stories = await storage.load('stories') || {};
            const storyKeys = Object.keys(stories);
            
            if (storyKeys.length === 0) {
                alert('No stories found. Analyze a story first in Tab 1.');
                return;
            }
            
            let modalHtml = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px;" onclick="if(event.target === this) this.remove()" id="followup-save-modal">
                    <div style="background: white; border-radius: 15px; padding: 25px; width: 100%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                        <h3>üíæ Save Follow-up to Story Web</h3>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em;">
                            <strong>Q:</strong> ${question.substring(0, 100)}...<br>
                            <strong>A:</strong> ${answer.substring(0, 150)}...
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Select Story</label>
                            <select id="followup-save-story" onchange="updateFollowupNodeSelector()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                                <option value="">-- Select story --</option>
                                ${storyKeys.map(key => `<option value="${key}">${stories[key].title || key}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Attach to Node</label>
                            <select id="followup-save-node" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                                <option value="">-- Select story first --</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Chip Title (short summary)</label>
                            <input type="text" id="followup-save-title" placeholder="e.g., 'Metrics deep-dive'" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 5px;">Content</label>
                            <textarea id="followup-save-content" rows="3" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">${answer}</textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="confirmSaveFollowUp()">Save Chip</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('followup-save-modal').remove()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        async function updateFollowupNodeSelector() {
            const storyId = document.getElementById('followup-save-story').value;
            const nodeSelect = document.getElementById('followup-save-node');
            
            if (!storyId) {
                nodeSelect.innerHTML = '<option value="">-- Select story first --</option>';
                return;
            }
            
            const stories = await storage.load('stories') || {};
            const story = stories[storyId];
            
            if (!story || !story.nodes || story.nodes.length === 0) {
                nodeSelect.innerHTML = '<option value="">-- No nodes --</option>';
                return;
            }
            
            const starEmojis = {situation: 'üèîÔ∏è', task: 'üéØ', action: '‚ö°', result: 'üíé'};
            nodeSelect.innerHTML = '<option value="">-- Select node --</option>' + 
                story.nodes.map(n => `<option value="${n.id}">${starEmojis[n.starComponent] || 'üìå'} ${n.eventTitle}</option>`).join('');
        }
        
        async function confirmSaveFollowUp() {
            const storyId = document.getElementById('followup-save-story').value;
            const nodeId = document.getElementById('followup-save-node').value;
            const title = document.getElementById('followup-save-title').value.trim();
            const content = document.getElementById('followup-save-content').value.trim();
            
            if (!storyId || !nodeId || !title || !content) {
                alert('Please fill in all fields.');
                return;
            }
            
            const success = await saveAnswerAsChip(storyId, nodeId, title, content, 'Follow-up Practice');
            
            if (success) {
                alert('Saved! View in Tab 2 Story Web.');
                document.getElementById('followup-save-modal')?.remove();
            } else {
                alert('Error saving.');
            }
        }

        async function endDrill() {
            // Save session
            const questionId = currentDrill.questionId || 'q_' + Date.now();
            const session = {
                id: 'session_' + Date.now(),
                date: new Date().toISOString(),
                lp: currentDrill.lp,
                question: currentDrill.question,
                questionId: questionId,
                storyId: document.getElementById('drill-story-select')?.value || null,
                response: currentDrill.response,
                score: currentDrill.evaluation?.score || 0,
                duration: currentTimerSeconds,
                followUps: currentDrill.followUps
            };

            const history = await storage.load('practice_history') || {sessions: [], stats: {}};
            history.sessions.push(session);
            await storage.save('practice_history', history);
            await storage.cleanupOldSessions();

            // Add to spaced repetition queue if score < 80
            if (session.score < 80) {
                await spacedRepetition.addToQueue(
                    questionId,
                    currentDrill.lp,
                    session.score,
                    currentDrill.question
                );
            }

            alert('‚úÖ Practice session saved! ' + (session.score < 80 ? 'Added to review queue for future practice.' : ''));
            
            // Reset
            document.getElementById('drill-session').style.display = 'none';
            document.getElementById('drill-evaluation').classList.remove('show');
            document.getElementById('followup-section').style.display = 'none';
            document.getElementById('followup-container').innerHTML = '';
            document.getElementById('drill-response').value = '';
            currentDrill = null;
            currentTimerSeconds = 0;
            starTimings = {situation: 0, task: 0, action: 0, result: 0};
            audioBlob = null;
        }

        function loadFromQueue() {
            alert('Review queue feature - load questions due for practice');
        }

        // ==================== TAB 5: SIMULATOR ====================
        async function startSimulation() {
            const story = document.getElementById('simulator-story-input').value.trim();
            if (!story) {
                alert('Please paste your story!');
                return;
            }

            // Store mode info and reset all tracking
            window.simulatorMode = 'story';
            window.simulatorLP = null;
            window.simulatorTopicDepth = 0;
            window.simulatorExploredLPs = [];
            window.interviewThreads = []; // Initialize interview memory

            conversationHistory = [{role: 'candidate', content: story}];
            const thread = document.getElementById('conversation-thread');
            thread.innerHTML = `
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <strong>üìù Your Story</strong><br>${story}
                </div>
            `;

            // Hide setup, show simulator
            document.getElementById('simulator-setup').style.display = 'none';
            document.getElementById('simulator-area').style.display = 'block';
            
            // Show context
            document.getElementById('simulator-context').style.display = 'block';
            document.getElementById('simulator-mode-label').textContent = 'üìñ Story Mode';
            document.getElementById('simulator-mode-value').textContent = 'Follow-up questions based on your story';
            
            await generateSimulatorFollowUp();
        }
        
        async function startLPSimulation() {
            const lp = document.getElementById('simulator-lp-select').value;
            if (!lp) {
                alert('Please select a Leadership Principle!');
                return;
            }
            
            // Store mode info and reset all tracking
            window.simulatorMode = 'lp';
            window.simulatorLP = lp;
            window.simulatorTopicDepth = 0;
            window.simulatorExploredLPs = [lp];
            window.interviewThreads = []; // Initialize interview memory
            
            conversationHistory = [];
            const thread = document.getElementById('conversation-thread');
            thread.innerHTML = '';
            
            // Hide setup, show simulator
            document.getElementById('simulator-setup').style.display = 'none';
            document.getElementById('simulator-area').style.display = 'block';
            
            // Show context
            document.getElementById('simulator-context').style.display = 'block';
            document.getElementById('simulator-mode-label').textContent = 'üéØ LP Mode';
            document.getElementById('simulator-mode-value').textContent = lp;
            
            // Generate first LP question
            await generateLPQuestion(lp);
        }
        
        async function generateLPQuestion(lp) {
            // Build interview memory
            const interviewMemory = buildInterviewMemory();
            
            // Get job and resume context
            const jobContext = await getJobContext();
            const resumeContext = await getResumeContext();
            
            // Count candidate responses to track depth
            const candidateResponses = conversationHistory.filter(m => m.role === 'candidate').length;
            const currentDepth = window.simulatorTopicDepth || 0;
            const shouldPivot = currentDepth >= 2 && candidateResponses > 0;
            
            // Track explored LPs - prioritize job's top LPs if available
            const defaultLPs = ['Customer Obsession', 'Ownership', 'Invent and Simplify', 'Learn and Be Curious', 
                           'Hire and Develop the Best', 'Insist on Highest Standards', 'Think Big', 'Bias for Action',
                           'Frugality', 'Earn Trust', 'Dive Deep', 'Have Backbone', 'Deliver Results'];
            const priorityLPs = jobContext?.analysis?.top_lps || [];
            const allLPs = [...new Set([...priorityLPs, ...defaultLPs])];
            
            window.simulatorExploredLPs = window.simulatorExploredLPs || [lp];
            const unexploredLPs = allLPs.filter(l => !window.simulatorExploredLPs.includes(l));
            
            // If pivoting, pick a new LP to explore
            const targetLP = shouldPivot && unexploredLPs.length > 0 ? unexploredLPs[0] : lp;
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 500,
                        messages: [{
                            role: "user",
                            content: `You are a BAR RAISING Amazon interviewer. You must remember the FULL context.

===== INTERVIEW MEMORY (YOUR NOTES) =====
${interviewMemory}
${jobContext ? `
===== TARGET ROLE CONTEXT =====
Role: ${jobContext.title || 'Amazon Position'}
Key skills for this role: ${jobContext.analysis?.key_skills?.join(', ') || 'Not specified'}
Top LPs to assess: ${jobContext.analysis?.top_lps?.join(', ') || 'Not specified'}
Things to probe for: ${jobContext.analysis?.things_to_emphasize?.join('; ') || 'Not specified'}
Red flags to watch: ${jobContext.analysis?.red_flags_to_avoid?.join('; ') || 'Not specified'}
` : ''}
${resumeContext ? `
===== CANDIDATE BACKGROUND (from resume) =====
${resumeContext.substring(0, 800)}
` : ''}

===== CONVERSATION =====
${conversationHistory.length > 0 ? conversationHistory.map(m => `[${m.role.toUpperCase()}]: ${m.content}`).join('\n\n') : '(Starting interview)'}

===== INTERVIEW STATE =====
- Primary LP focus: ${lp}
- Current thread depth: ${currentDepth}/2
- LPs explored: ${window.simulatorExploredLPs.join(', ')}
- LPs NOT explored: ${unexploredLPs.slice(0, 4).join(', ')}

===== YOUR NEXT MOVE =====
${shouldPivot ? `
üîÑ PIVOT NOW: You've probed deep enough (${currentDepth} questions on this thread).
Switch to: ${targetLP}
DO NOT continue the same topic - explore a NEW aspect!
` : `
üìç CONTINUE PROBING (${2 - currentDepth} deep questions left).
Target: ${targetLP}
Look for: specifics, metrics, conflicts, alternatives, what could fail.
`}

${conversationHistory.length === 0 ? `Generate an OPENING behavioral question for ${targetLP}. Ask about a specific time/situation.${jobContext ? ' Consider asking about experiences relevant to their target role.' : ''}` : `Generate ONE bar-raiser follow-up question.`}

RULES:
1. Be specific, reference their previous answers
2. Target ${targetLP}
3. If their answer was weak/vague, probe harder
4. One question only, be direct
${jobContext ? `5. Probe for skills relevant to ${jobContext.title}: ${jobContext.analysis?.key_skills?.slice(0, 3).join(', ')}` : ''}

YOUR QUESTION:`
                        }]
                    })
                });

                const data = await response.json();
                const question = data.content[0].text.trim();
                
                // Update tracking
                if (shouldPivot) {
                    window.simulatorTopicDepth = 1;
                    if (!window.simulatorExploredLPs.includes(targetLP)) {
                        window.simulatorExploredLPs.push(targetLP);
                    }
                    addToInterviewMemory('pivot', targetLP, question);
                } else {
                    window.simulatorTopicDepth = (window.simulatorTopicDepth || 0) + 1;
                    addToInterviewMemory('probe', targetLP, question);
                }
                
                conversationHistory.push({role: 'interviewer', content: question, lp: targetLP});
                
                const thread = document.getElementById('conversation-thread');
                const qDiv = document.createElement('div');
                qDiv.style.cssText = 'background: #e7e3ff; padding: 15px; border-radius: 8px; margin: 10px 0;';
                
                const depthLabel = shouldPivot ? 'üîÑ PIVOT' : `üìç ${currentDepth + 1}/2`;
                
                qDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div><strong>‚ùì Interviewer</strong> <span style="font-size: 0.8em; color: #666;">(${targetLP})</span></div>
                        <span style="font-size: 0.75em; background: ${shouldPivot ? '#fff3cd' : '#e3f2fd'}; padding: 3px 8px; border-radius: 10px;">${depthLabel}</span>
                    </div>
                    <div style="margin-top: 8px;">${question}</div>
                `;
                thread.appendChild(qDiv);
                thread.scrollTop = thread.scrollHeight;
            } catch (err) {
                console.error(err);
            }
        }

        async function generateSimulatorFollowUp() {
            // If in LP mode, use LP-specific generation
            if (window.simulatorMode === 'lp' && window.simulatorLP) {
                await generateLPQuestion(window.simulatorLP);
                return;
            }
            
            // Build rich interview memory
            const interviewMemory = buildInterviewMemory();
            
            // Story mode - track depth and pivot
            const candidateResponses = conversationHistory.filter(m => m.role === 'candidate').length;
            const currentDepth = window.simulatorTopicDepth || 0;
            const shouldPivot = currentDepth >= 2 && candidateResponses > 1;
            
            // Get job and resume context
            const jobContext = await getJobContext();
            const resumeContext = await getResumeContext();
            
            // Prioritize job's top LPs if available
            const defaultLPs = ['Customer Obsession', 'Ownership', 'Invent and Simplify', 'Learn and Be Curious', 
                           'Dive Deep', 'Have Backbone', 'Deliver Results', 'Earn Trust', 'Bias for Action'];
            const priorityLPs = jobContext?.analysis?.top_lps || [];
            const allLPs = [...new Set([...priorityLPs, ...defaultLPs])];
            
            window.simulatorExploredLPs = window.simulatorExploredLPs || [];
            const unexploredLPs = allLPs.filter(l => !window.simulatorExploredLPs.includes(l));
            const nextLP = unexploredLPs[0] || allLPs[Math.floor(Math.random() * allLPs.length)];
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 500,
                        messages: [{
                            role: "user",
                            content: `You are a BAR RAISING Amazon interviewer. You must remember the FULL context of this interview.

===== INTERVIEW MEMORY (YOUR NOTES) =====
${interviewMemory}
${jobContext ? `
===== TARGET ROLE CONTEXT =====
Role: ${jobContext.title || 'Amazon Position'}
Key skills for this role: ${jobContext.analysis?.key_skills?.join(', ') || 'Not specified'}
Top LPs to assess: ${jobContext.analysis?.top_lps?.join(', ') || 'Not specified'}
Things to probe for: ${jobContext.analysis?.things_to_emphasize?.join('; ') || 'Not specified'}
Red flags to watch: ${jobContext.analysis?.red_flags_to_avoid?.join('; ') || 'Not specified'}
` : ''}
${resumeContext ? `
===== CANDIDATE BACKGROUND (from resume) =====
${resumeContext.substring(0, 800)}
` : ''}

===== FULL CONVERSATION =====
${conversationHistory.map(m => `[${m.role.toUpperCase()}]: ${m.content}`).join('\n\n')}

===== INTERVIEW STRATEGY STATE =====
- Total questions asked: ${conversationHistory.filter(m => m.role === 'interviewer').length}
- Current thread depth: ${currentDepth}/2 (max 2 deep, then pivot)
- LPs explored so far: ${window.simulatorExploredLPs.join(', ') || 'none yet'}
- LPs NOT yet explored: ${unexploredLPs.slice(0, 4).join(', ')}

===== YOUR NEXT MOVE =====
${shouldPivot ? `
üîÑ PIVOT NOW: You've probed this thread deep enough (${currentDepth} questions).
DO NOT ask another question about the same topic.
CHANGE to a NEW aspect of the story or target: ${nextLP}

Pivot techniques:
- "Let's shift gears - tell me about [DIFFERENT stakeholder/challenge]"
- "You mentioned [X from earlier in story] - let's explore that"
- "I want to understand your ${nextLP} - what about..."
- "Stepping back - how did you [different aspect]?"
` : `
üìç CONTINUE PROBING this thread (${2 - currentDepth} more deep question(s) allowed).
Look for gaps in their answer:
- Missing specific metrics/numbers?
- Who pushed back and why?
- What alternatives were considered?
- What could have gone wrong?
- How did they handle disagreement?
`}

===== RULES =====
1. Ask ONE specific question (not generic)
2. Reference something SPECIFIC from their previous answer
3. If their answer was weak/vague, probe harder there
4. Question only - no preamble, no "Great answer"
${jobContext ? `5. Probe for skills relevant to their target role: ${jobContext.analysis?.key_skills?.slice(0, 3).join(', ')}` : ''}

YOUR QUESTION:`
                        }]
                    })
                });

                const data = await response.json();
                const question = data.content[0].text.trim();
                
                // Update tracking
                if (shouldPivot) {
                    window.simulatorTopicDepth = 1;
                    window.simulatorExploredLPs.push(nextLP);
                    // Track this as a new thread in memory
                    addToInterviewMemory('pivot', nextLP, question);
                } else {
                    window.simulatorTopicDepth = (window.simulatorTopicDepth || 0) + 1;
                    addToInterviewMemory('probe', null, question);
                }
                
                conversationHistory.push({role: 'interviewer', content: question});
                
                const thread = document.getElementById('conversation-thread');
                const qDiv = document.createElement('div');
                qDiv.style.cssText = 'background: #e7e3ff; padding: 15px; border-radius: 8px; margin: 10px 0;';
                
                const depthLabel = shouldPivot ? 'üîÑ PIVOT' : `üìç ${currentDepth + 1}/2`;
                
                qDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <strong>‚ùì Interviewer</strong>
                        <span style="font-size: 0.75em; background: ${shouldPivot ? '#fff3cd' : '#e3f2fd'}; padding: 3px 8px; border-radius: 10px;">${depthLabel}</span>
                    </div>
                    <div style="margin-top: 8px;">${question}</div>
                `;
                thread.appendChild(qDiv);
                thread.scrollTop = thread.scrollHeight;
            } catch (err) {
                console.error(err);
            }
        }
        
        // Build a rich memory summary for the interviewer
        function buildInterviewMemory() {
            if (!window.interviewThreads || window.interviewThreads.length === 0) {
                return "This is the START of the interview. No threads explored yet.";
            }
            
            let memory = "THREADS EXPLORED:\n";
            window.interviewThreads.forEach((thread, i) => {
                memory += `\n${i + 1}. ${thread.topic || 'Initial story'}`;
                if (thread.lp) memory += ` (${thread.lp})`;
                memory += `\n   Questions: ${thread.questions.length}`;
                if (thread.keyFindings.length > 0) {
                    memory += `\n   Key findings: ${thread.keyFindings.join('; ')}`;
                }
                if (thread.gaps.length > 0) {
                    memory += `\n   Still unclear: ${thread.gaps.join('; ')}`;
                }
            });
            
            // Summarize overall assessment
            const totalQs = conversationHistory.filter(m => m.role === 'interviewer').length;
            memory += `\n\nOVERALL: ${totalQs} questions asked across ${window.interviewThreads.length} thread(s).`;
            
            return memory;
        }
        
        // Add to interview memory when asking questions
        function addToInterviewMemory(type, lp, question) {
            window.interviewThreads = window.interviewThreads || [];
            
            if (type === 'pivot' || window.interviewThreads.length === 0) {
                // Start new thread
                window.interviewThreads.push({
                    topic: extractTopic(question),
                    lp: lp,
                    questions: [question],
                    keyFindings: [],
                    gaps: []
                });
            } else {
                // Add to current thread
                const currentThread = window.interviewThreads[window.interviewThreads.length - 1];
                currentThread.questions.push(question);
            }
        }
        
        // Extract topic from question for memory
        function extractTopic(question) {
            // Simple extraction - get first few meaningful words
            const words = question.replace(/[?"]/g, '').split(' ').slice(0, 8).join(' ');
            return words.length > 40 ? words.substring(0, 40) + '...' : words;
        }
        
        // Update memory when candidate responds (to track findings/gaps)
        function updateInterviewMemoryWithResponse(response) {
            if (!window.interviewThreads || window.interviewThreads.length === 0) return;
            
            const currentThread = window.interviewThreads[window.interviewThreads.length - 1];
            
            // Simple heuristics for findings vs gaps
            if (response.match(/\d+%|\$\d+|\d+ (days|hours|weeks|months)/)) {
                currentThread.keyFindings.push('Has specific metrics');
            }
            if (response.length < 100) {
                currentThread.gaps.push('Short/vague answer - probe deeper');
            }
            if (response.toLowerCase().includes('stakeholder') || response.toLowerCase().includes('manager') || response.toLowerCase().includes('team')) {
                currentThread.keyFindings.push('Mentioned stakeholders');
            }
        }

        async function suggestSimulatorResponse() {
            const lastQ = conversationHistory[conversationHistory.length - 1];
            if (lastQ.role !== 'interviewer') return;
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 800,
                        messages: [{
                            role: "user",
                            content: `Suggest strong response to: ${lastQ.content}

Context: ${conversationHistory[0].content.substring(0, 500)}

2-3 sentences with specifics.`
                        }]
                    })
                });

                const data = await response.json();
                const suggestion = data.content[0].text.trim();
                
                // Store suggestion for potential node generation
                window.lastSimulatorSuggestion = suggestion;
                
                const thread = document.getElementById('conversation-thread');
                const sDiv = document.createElement('div');
                sDiv.style.cssText = 'background: #fff3cd; padding: 15px; border-radius: 8px; margin: 10px 0;';
                sDiv.innerHTML = `
                    <strong>üí° Suggested Response</strong><br>
                    "${suggestion}"
                    <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="useSuggestionAsResponse()" class="btn btn-sm btn-success">‚úÖ Use This Response</button>
                        <button onclick="generateNodeFromSuggestion()" class="btn btn-sm btn-primary">ü§ñ Generate Node from This</button>
                    </div>
                `;
                thread.appendChild(sDiv);
                thread.scrollTop = thread.scrollHeight;
            } catch (err) {
                console.error(err);
            }
        }
        
        function useSuggestionAsResponse() {
            if (window.lastSimulatorSuggestion) {
                document.getElementById('candidate-response').value = window.lastSimulatorSuggestion;
            }
        }
        
        async function generateNodeFromSuggestion() {
            if (!window.lastSimulatorSuggestion) {
                alert('No suggestion available.');
                return;
            }
            
            const stories = await storage.load('stories') || {};
            const storyKeys = Object.keys(stories);
            
            if (storyKeys.length === 0) {
                alert('No stories found. Please analyze a story first in Tab 1.');
                return;
            }
            
            // Get last question
            const lastQ = conversationHistory.filter(m => m.role === 'interviewer').pop();
            const question = lastQ?.content || 'Interview question';
            
            // Show loading
            const loadingHtml = `
                <div id="generate-sugg-node-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px;">
                    <div style="background: white; border-radius: 15px; padding: 30px; text-align: center; max-width: 400px;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 15px;">Generating node from suggestion...</p>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', loadingHtml);
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 2000,
                        messages: [{
                            role: "user",
                            content: `Create a story web node from this interview Q&A.

QUESTION: ${question}

RESPONSE: ${window.lastSimulatorSuggestion}

Respond ONLY with valid JSON (no markdown):
{
  "eventTitle": "3-6 word title",
  "starComponent": "situation|task|action|result",
  "dimensions": {
    "stakeholders": ["who"],
    "problem": "challenge",
    "solution": "action taken",
    "metrics": "numbers/impact",
    "alternatives": "",
    "tradeoffs": ""
  },
  "visual": {
    "anchor": {
      "emoji": "üìä",
      "keyword": "memorable word"
    }
  },
  "leadershipPrinciples": ["LP1"],
  "keyQuotes": ["key phrase"]
}`
                        }]
                    })
                });

                const data = await response.json();
                const text = data.content[0].text;
                const cleaned = text.replace(/```json\n?|\n?```/g, '').trim();
                const nodeData = JSON.parse(cleaned);
                
                document.getElementById('generate-sugg-node-modal').remove();
                
                window.generatedNodeData = nodeData;
                showGeneratedNodeReview(nodeData, storyKeys, stories);
                
            } catch (error) {
                console.error(error);
                document.getElementById('generate-sugg-node-modal')?.remove();
                alert('Error generating node.');
            }
        }

        function submitSimulatorResponse() {
            const response = document.getElementById('candidate-response').value.trim();
            if (!response) return;
            
            conversationHistory.push({role: 'candidate', content: response});
            
            // Update interview memory with response analysis
            updateInterviewMemoryWithResponse(response);
            
            const thread = document.getElementById('conversation-thread');
            const rDiv = document.createElement('div');
            rDiv.style.cssText = 'background: #d4edda; padding: 15px; border-radius: 8px; margin: 10px 0;';
            rDiv.innerHTML = `<strong>üìù You</strong><br>${response}`;
            thread.appendChild(rDiv);
            thread.scrollTop = thread.scrollHeight;
            
            document.getElementById('candidate-response').value = '';
        }

        function resetSimulation() {
            conversationHistory = [];
            window.simulatorMode = null;
            window.simulatorLP = null;
            window.simulatorTopicDepth = 0;
            window.simulatorExploredLPs = [];
            window.interviewThreads = []; // Reset interview memory
            document.getElementById('conversation-thread').innerHTML = '';
            document.getElementById('simulator-area').style.display = 'none';
            document.getElementById('simulator-setup').style.display = 'block';
            document.getElementById('simulator-context').style.display = 'none';
            document.getElementById('simulator-story-input').value = '';
            document.getElementById('simulator-lp-select').value = '';
        }
        
        async function generateNodeFromSimulator() {
            if (conversationHistory.length === 0) {
                alert('No conversation yet. Submit some responses first!');
                return;
            }
            
            const stories = await storage.load('stories') || {};
            const storyKeys = Object.keys(stories);
            
            if (storyKeys.length === 0) {
                alert('No stories found. Please analyze a story first in Tab 1.');
                return;
            }
            
            // Get the original story text from simulator
            const simulatorStory = document.getElementById('simulator-story-input').value.trim();
            
            // Build conversation context
            const conversationText = conversationHistory.map(msg => {
                if (msg.role === 'interviewer') return `Interviewer: ${msg.content}`;
                if (msg.role === 'candidate') return `You: ${msg.content}`;
                if (msg.role === 'suggestion') return `[Suggested: ${msg.content}]`;
                return '';
            }).filter(m => m).join('\n\n');
            
            // Show loading modal
            const loadingHtml = `
                <div id="generate-sim-node-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px;">
                    <div style="background: white; border-radius: 15px; padding: 30px; text-align: center; max-width: 400px;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 15px;">Analyzing conversation and generating node...</p>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', loadingHtml);
            
            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 2000,
                        messages: [{
                            role: "user",
                            content: `Analyze this interview simulation conversation and create a story web node that captures the key event/action described.

ORIGINAL STORY CONTEXT:
${simulatorStory || '(Not provided)'}

INTERVIEW CONVERSATION:
${conversationText}

Create a structured node capturing the main event/action from the candidate's responses. Extract specific details, metrics, and leadership principles demonstrated.

Respond ONLY with valid JSON (no markdown):
{
  "eventTitle": "3-6 word title describing the key action/event",
  "starComponent": "situation|task|action|result",
  "dimensions": {
    "stakeholders": ["who was involved"],
    "problem": "what challenge or context was described",
    "solution": "what action was taken",
    "metrics": "specific numbers, percentages, or impact mentioned",
    "alternatives": "other options considered if mentioned",
    "tradeoffs": "any tradeoffs or challenges faced"
  },
  "visual": {
    "anchor": {
      "emoji": "single relevant emoji",
      "keyword": "one memorable word from the responses"
    }
  },
  "leadershipPrinciples": ["LP1", "LP2"],
  "keyQuotes": ["1-2 strong phrases from the responses worth remembering"]
}`
                        }]
                    })
                });

                const data = await response.json();
                let nodeData;
                
                try {
                    const text = data.content[0].text;
                    const cleaned = text.replace(/```json\n?|\n?```/g, '').trim();
                    nodeData = JSON.parse(cleaned);
                } catch (e) {
                    throw new Error('Failed to parse AI response');
                }
                
                // Remove loading, show review modal
                document.getElementById('generate-sim-node-modal').remove();
                
                // Store for use in review
                window.generatedNodeData = nodeData;
                window.nodeGenerationSource = 'simulator';
                
                showGeneratedNodeReview(nodeData, storyKeys, stories);
                
            } catch (error) {
                console.error('Generate node error:', error);
                document.getElementById('generate-sim-node-modal')?.remove();
                alert('Error generating node. Please try again.');
            }
        }

        // ==================== TAB 6: Q&A ANALYZER ====================
        async function analyzeQA() {
            const qaText = document.getElementById('qa-input').value.trim();
            if (!qaText) {
                alert('Please paste Q&A!');
                return;
            }

            const loading = document.getElementById('qa-loading');
            const results = document.getElementById('qa-results');

            loading.classList.add('show');
            results.classList.remove('show');

            try {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {"Content-Type": "application/json", "x-api-key": getApiKey(), "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true"},
                    body: JSON.stringify({
                        model: "claude-sonnet-4-5-20250929",
                        max_tokens: 4000,
                        messages: [{
                            role: "user",
                            content: `Analyze Q&A for ${CURRENT_COMPANY}:

${qaText}

Respond with JSON:
{
  "overall_score": 80,
  "qa_pairs": [
    {
      "question": "...",
      "answer": "...",
      "score": 85,
      "strengths": ["..."],
      "suggestions": ["..."],
      "improved_answer": "Here's a stronger version: ..."
    }
  ]
}`
                        }]
                    })
                });

                const data = await response.json();
                const text = data.content[0].text.replace(/```json|```/g, "").trim();
                const analysis = JSON.parse(text);
                displayQAResults(analysis);
            } catch (err) {
                console.error(err);
                alert('Error analyzing Q&A.');
            } finally {
                loading.classList.remove('show');
            }
        }

        function displayQAResults(analysis) {
            const results = document.getElementById('qa-results');
            results.innerHTML = `
                <div class="evaluation-card">
                    <h2>Overall Score: ${analysis.overall_score}/100</h2>
                </div>
                ${analysis.qa_pairs.map((pair, i) => `
                    <div class="evaluation-card">
                        <h3>Q&A Pair ${i + 1}</h3>
                        <div style="background: #e7e3ff; padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <strong>Q:</strong> ${pair.question}
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                            <strong>Your A:</strong> ${pair.answer}
                        </div>
                        <div class="feedback-section">
                            <h4>Score: ${pair.score}/100</h4>
                            <h4>‚úÖ Strengths</h4>
                            ${pair.strengths.map(s => `<div class="feedback-item strength">${s}</div>`).join('')}
                            <h4>üí° Suggestions</h4>
                            ${pair.suggestions.map(s => `<div class="feedback-item suggestion">${s}</div>`).join('')}
                        </div>
                        ${pair.improved_answer ? `
                            <div class="highlight-box">
                                <strong>‚ú® Improved Version:</strong><br>
                                ${pair.improved_answer}
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            `;
            results.classList.add('show');
        }

        function clearQA() {
            document.getElementById('qa-input').value = '';
            document.getElementById('qa-results').classList.remove('show');
        }

        // ==================== ANALYTICS DASHBOARD ====================
        async function showAnalyticsDashboard() {
            const history = await storage.load('practice_history') || {sessions: [], stats: {byLP: {}, byStory: {}}};
            const queue = await storage.load('review_queue') || [];
            
            // Calculate stats
            const stats = calculateStats(history);
            
            const content = document.getElementById('analytics-content');
            content.innerHTML = `
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <h3>üìà Total Sessions</h3>
                        <div class="stat-value">${history.sessions.length}</div>
                        <div class="stat-label">Practice sessions completed</div>
                    </div>
                    <div class="stat-card">
                        <h3>‚è±Ô∏è Total Time</h3>
                        <div class="stat-value">${(stats.totalTime / 3600).toFixed(1)}h</div>
                        <div class="stat-label">Time invested in practice</div>
                    </div>
                    <div class="stat-card">
                        <h3>üéØ Average Score</h3>
                        <div class="stat-value">${stats.avgScore}</div>
                        <div class="stat-label">Overall performance</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${stats.avgScore}%;"></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>üìö Review Queue</h3>
                        <div class="stat-value">${queue.length}</div>
                        <div class="stat-label">Questions due for practice</div>
                    </div>
                </div>

                <div class="guide-section" style="margin-top: 30px;">
                    <h3>üìä Performance by Leadership Principle</h3>
                    <div style="margin-top: 20px;">
                        ${renderLPStats(stats.byLP)}
                    </div>
                </div>

                ${stats.byStory && Object.keys(stats.byStory).length > 0 ? `
                    <div class="guide-section" style="margin-top: 30px;">
                        <h3>üìù Performance by Story</h3>
                        <div style="margin-top: 20px;">
                            ${renderStoryStats(stats.byStory)}
                        </div>
                    </div>
                ` : ''}

                ${history.sessions.length >= 5 ? `
                    <div class="guide-section" style="margin-top: 30px;">
                        <h3>üìà Progress Over Time (Last 30 Days)</h3>
                        <div style="margin-top: 20px;">
                            ${renderProgressChart(history.sessions)}
                        </div>
                    </div>
                ` : ''}

                ${queue.length > 0 ? `
                    <div class="highlight-box" style="margin-top: 30px;">
                        <strong>‚ö†Ô∏è Review Queue (${queue.length} questions due)</strong>
                        <ul style="margin-top: 15px;">
                            ${queue.slice(0, 10).map(q => `
                                <li>${q.lp}: Last practiced ${getDaysAgo(q.lastPracticed)} days ago (Score: ${q.lastScore})</li>
                            `).join('')}
                        </ul>
                        ${queue.length > 10 ? `<p style="margin-top: 10px; font-style: italic;">...and ${queue.length - 10} more</p>` : ''}
                    </div>
                ` : ''}
            `;
            
            document.getElementById('analytics-modal').style.display = 'block';
        }

        function closeAnalyticsDashboard() {
            document.getElementById('analytics-modal').style.display = 'none';
        }

        function calculateStats(history) {
            const sessions = history.sessions || [];
            
            if (sessions.length === 0) {
                return {
                    totalTime: 0,
                    avgScore: 0,
                    byLP: {},
                    byStory: {}
                };
            }

            const totalTime = sessions.reduce((sum, s) => sum + (s.duration || 0), 0);
            const totalScore = sessions.reduce((sum, s) => sum + (s.score || 0), 0);
            const avgScore = Math.round(totalScore / sessions.length);

            // By LP
            const byLP = {};
            sessions.forEach(s => {
                if (!s.lp) return;
                if (!byLP[s.lp]) {
                    byLP[s.lp] = {
                        practiced: 0,
                        totalScore: 0,
                        avgScore: 0,
                        lastPracticed: null
                    };
                }
                byLP[s.lp].practiced++;
                byLP[s.lp].totalScore += s.score || 0;
                byLP[s.lp].lastPracticed = s.date;
            });

            Object.keys(byLP).forEach(lp => {
                byLP[lp].avgScore = Math.round(byLP[lp].totalScore / byLP[lp].practiced);
            });

            // By Story
            const byStory = {};
            sessions.forEach(s => {
                if (!s.storyId) return;
                if (!byStory[s.storyId]) {
                    byStory[s.storyId] = {
                        practiced: 0,
                        totalScore: 0,
                        avgScore: 0,
                        followUpDefenseRate: 0
                    };
                }
                byStory[s.storyId].practiced++;
                byStory[s.storyId].totalScore += s.score || 0;
            });

            Object.keys(byStory).forEach(story => {
                byStory[story].avgScore = Math.round(byStory[story].totalScore / byStory[story].practiced);
            });

            return {
                totalTime,
                avgScore,
                byLP,
                byStory
            };
        }

        function renderLPStats(byLP) {
            if (!byLP || Object.keys(byLP).length === 0) {
                return '<p style="color: #999;">No practice data yet. Start drilling to see stats!</p>';
            }

            const lpEntries = Object.entries(byLP).sort((a, b) => b[1].avgScore - a[1].avgScore);
            
            return lpEntries.map(([lp, stats]) => {
                const lpClass = lp.toLowerCase().replace(/ /g, '-').replace(/&/g, '');
                const daysAgo = getDaysAgo(stats.lastPracticed);
                const alertClass = daysAgo > 7 ? 'red' : daysAgo > 3 ? 'yellow' : 'green';
                
                return `
                    <div style="background: white; padding: 20px; border-radius: 10px; margin: 10px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <span class="lp-tag ${lpClass}">${lp}</span>
                                    <span class="alert-badge ${alertClass}">${daysAgo}d</span>
                                </div>
                                <div style="font-size: 0.9em; color: #666;">
                                    Practiced ${stats.practiced} times | Avg Score: ${stats.avgScore}/100
                                </div>
                            </div>
                            <div style="font-size: 2em; font-weight: 700; color: var(--color-primary);">
                                ${stats.avgScore}
                            </div>
                        </div>
                        <div class="progress-bar" style="margin-top: 15px;">
                            <div class="progress-fill" style="width: ${stats.avgScore}%;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderStoryStats(byStory) {
            if (!byStory || Object.keys(byStory).length === 0) {
                return '<p style="color: #999;">No story-specific data yet.</p>';
            }

            const storyEntries = Object.entries(byStory).sort((a, b) => b[1].avgScore - a[1].avgScore);
            
            return storyEntries.map(([storyId, stats]) => `
                <div style="background: white; padding: 15px; border-radius: 8px; margin: 8px 0; border-left: 4px solid var(--color-primary);">
                    <strong>${storyId}</strong>
                    <div style="margin-top: 5px; color: #666;">
                        ${stats.practiced} sessions | Avg: ${stats.avgScore}/100
                    </div>
                    <div class="progress-bar" style="margin-top: 10px;">
                        <div class="progress-fill" style="width: ${stats.avgScore}%;"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderProgressChart(sessions) {
            // Get last 30 days
            const now = new Date();
            const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
            
            const recentSessions = sessions.filter(s => new Date(s.date) >= thirtyDaysAgo);
            
            if (recentSessions.length === 0) {
                return '<p style="color: #999;">Not enough data for chart yet.</p>';
            }

            // Group by date
            const byDate = {};
            recentSessions.forEach(s => {
                const date = new Date(s.date).toLocaleDateString();
                if (!byDate[date]) {
                    byDate[date] = {count: 0, totalScore: 0};
                }
                byDate[date].count++;
                byDate[date].totalScore += s.score || 0;
            });

            // Create simple bar chart
            const entries = Object.entries(byDate).slice(-10); // Last 10 days with data
            
            return `
                <div style="display: flex; align-items: flex-end; gap: 10px; height: 200px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    ${entries.map(([date, data]) => {
                        const avgScore = Math.round(data.totalScore / data.count);
                        const height = (avgScore / 100) * 160;
                        return `
                            <div style="flex: 1; text-align: center;">
                                <div style="background: var(--color-success); height: ${height}px; border-radius: 5px 5px 0 0; transition: all 0.3s;"></div>
                                <div style="font-size: 0.7em; margin-top: 5px; color: #666;">${date.split('/').slice(0,2).join('/')}</div>
                                <div style="font-size: 0.8em; font-weight: 700; color: var(--color-primary);">${avgScore}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function getDaysAgo(dateString) {
            if (!dateString) return 999;
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        // ==================== SPACED REPETITION ====================
        class SpacedRepetitionManager {
            calculateNextReview(score, lastReview, repetition) {
                const now = new Date(lastReview);
                
                // SM-2 inspired algorithm
                let interval;
                if (repetition === 0) {
                    interval = 1; // 1 day
                } else if (repetition === 1) {
                    interval = 6; // 6 days
                } else {
                    // Based on score
                    const easinessFactor = Math.max(1.3, 2.5 - (100 - score) / 50);
                    interval = Math.round(repetition * easinessFactor);
                }

                const nextDate = new Date(now);
                nextDate.setDate(nextDate.getDate() + interval);
                return nextDate;
            }

            async addToQueue(questionId, lp, lastScore, question) {
                const queue = await storage.load('review_queue') || [];
                
                const existing = queue.find(q => q.questionId === questionId);
                if (existing) {
                    existing.lastScore = lastScore;
                    existing.lastPracticed = new Date().toISOString();
                    existing.repetition = (existing.repetition || 0) + 1;
                    existing.nextReview = this.calculateNextReview(
                        lastScore,
                        existing.lastPracticed,
                        existing.repetition
                    ).toISOString();
                } else {
                    queue.push({
                        questionId,
                        lp,
                        question,
                        lastScore,
                        lastPracticed: new Date().toISOString(),
                        repetition: 0,
                        nextReview: this.calculateNextReview(
                            lastScore,
                            new Date().toISOString(),
                            0
                        ).toISOString()
                    });
                }

                await storage.save('review_queue', queue);
            }

            async getQueuedQuestions(date = new Date()) {
                const queue = await storage.load('review_queue') || [];
                return queue.filter(q => new Date(q.nextReview) <= date);
            }
        }

        const spacedRepetition = new SpacedRepetitionManager();

        async function loadFromQueue() {
            const dueQuestions = await spacedRepetition.getQueuedQuestions();
            
            if (dueQuestions.length === 0) {
                alert('üéâ No questions due for review! Your queue is clear.');
                return;
            }

            // Pick the most overdue
            const sorted = dueQuestions.sort((a, b) => 
                new Date(a.nextReview) - new Date(b.nextReview)
            );
            
            const question = sorted[0];
            
            document.getElementById('drill-session').style.display = 'block';
            document.getElementById('drill-question').textContent = question.question;
            
            currentDrill = {
                question: question.question,
                questionId: question.questionId,
                lp: question.lp,
                startTime: Date.now(),
                followUps: [],
                fromQueue: true
            };
        }

        // ==================== INITIALIZE ON LOAD ====================
        window.addEventListener('DOMContentLoaded', initializeApp);
        
        // Explicitly expose ALL functions to global scope for onclick handlers
        // Story management
        window.deleteStory = deleteStory;
        window.deleteStoryFromManager = deleteStoryFromManager;
        window.deleteCurrentStory = deleteCurrentStory;
        window.showStoryManager = showStoryManager;
        window.viewStoryInWeb = viewStoryInWeb;
        window.analyzeStory = analyzeStory;
        window.clearStoryAnalyzer = clearStoryAnalyzer;
        window.loadStoryWeb = loadStoryWeb;
        window.regenerateStoryWeb = regenerateStoryWeb;
        window.goToStoryWebBuilder = goToStoryWebBuilder;
        window.exportAllStories = exportAllStories;
        window.confirmDeleteAllStories = confirmDeleteAllStories;
        
        // Resume & Job
        window.saveResume = saveResume;
        window.clearResume = clearResume;
        window.toggleResumeSection = toggleResumeSection;
        window.saveJobPosting = saveJobPosting;
        window.clearJobPosting = clearJobPosting;
        window.toggleJobSection = toggleJobSection;
        window.refreshGuide = refreshGuide;
        
        // Node editing
        window.showNodeDetail = showNodeDetail;
        window.closeNodeDetail = closeNodeDetail;
        window.toggleNodeEditMode = toggleNodeEditMode;
        window.saveNodeEdits = saveNodeEdits;
        window.deleteNode = deleteNode;
        window.addEventNode = addEventNode;
        window.toggleManualEditor = toggleManualEditor;
        window.toggleRawStory = toggleRawStory;
        
        // Child nodes
        window.deleteChildNode = deleteChildNode;
        window.showAddChildNodeForm = showAddChildNodeForm;
        window.hideAddChildNodeForm = hideAddChildNodeForm;
        window.saveNewChildNode = saveNewChildNode;
        window.toggleChildNodes = toggleChildNodes;
        window.viewChildNode = viewChildNode;
        
        // Chips
        window.deleteChip = deleteChip;
        window.editChip = editChip;
        window.saveChipEdit = saveChipEdit;
        window.cancelChipEdit = cancelChipEdit;
        window.showAddChipForm = showAddChipForm;
        window.hideAddChipForm = hideAddChipForm;
        window.saveNewChip = saveNewChip;
        window.moveChipPrompt = moveChipPrompt;
        
        // AI suggestions
        window.aiSuggestNodeFields = aiSuggestNodeFields;
        window.aiSuggestChildNodeFields = aiSuggestChildNodeFields;
        window.applySuggestion = applySuggestion;
        window.selectSuggestedLP = selectSuggestedLP;
        window.showAISuggestModal = showAISuggestModal;
        window.generateAISuggestions = generateAISuggestions;
        window.addSelectedSuggestions = addSelectedSuggestions;
        window.confirmAddGeneratedNode = confirmAddGeneratedNode;
        window.editSuggestion = editSuggestion;
        window.removeSuggestion = removeSuggestion;
        
        // Export functions
        window.exportToVisualHTML = exportToVisualHTML;
        window.exportToJSON = exportToJSON;
        window.exportToMarkdown = exportToMarkdown;
        window.importFromJSON = importFromJSON;
        window.toggleExportMenu = toggleExportMenu;
        window.downloadExportedHTML = downloadExportedHTML;
        window.printExportedHTML = printExportedHTML;
        window.copyMermaidCode = copyMermaidCode;
        window.downloadMermaidFile = downloadMermaidFile;
        
        // Practice & Drill
        window.startQuestionDrill = startQuestionDrill;
        window.submitDrillResponse = submitDrillResponse;
        window.endDrill = endDrill;
        window.showQuestionHints = showQuestionHints;
        window.toggleRecording = toggleRecording;
        window.playbackAudio = playbackAudio;
        window.loadFromQueue = loadFromQueue;
        window.generateNextFollowUp = generateNextFollowUp;
        window.confirmSaveFollowUp = confirmSaveFollowUp;
        window.saveDrillToStoryWeb = saveDrillToStoryWeb;
        window.handlePracticeClick = handlePracticeClick;
        window.ratePracticeNode = ratePracticeNode;
        
        // Simulator
        window.startSimulation = startSimulation;
        window.startLPSimulation = startLPSimulation;
        window.submitSimulatorResponse = submitSimulatorResponse;
        window.generateSimulatorFollowUp = generateSimulatorFollowUp;
        window.resetSimulation = resetSimulation;
        window.suggestSimulatorResponse = suggestSimulatorResponse;
        window.useSuggestionAsResponse = useSuggestionAsResponse;
        window.showSaveToStoryWebModal = showSaveToStoryWebModal;
        window.generateNodeFromSimulator = generateNodeFromSimulator;
        window.saveFollowUpToWebFromLast = saveFollowUpToWebFromLast;
        window.generateNodeFromResponse = generateNodeFromResponse;
        window.generateNodeFromSuggestion = generateNodeFromSuggestion;
        
        // QA & Analytics
        window.analyzeQA = analyzeQA;
        window.clearQA = clearQA;
        window.analyzeCoverage = analyzeCoverage;
        window.showAnalyticsDashboard = showAnalyticsDashboard;
        window.closeAnalyticsDashboard = closeAnalyticsDashboard;
        window.submitFollowUpResponse = submitFollowUpResponse;
        
        // BYOK API Key Management
        window.saveApiKey = saveApiKey;
        window.skipApiKey = skipApiKey;
        window.updateApiKey = updateApiKey;
        window.clearApiKey = clearApiKey;
        window.showApiKeyModal = showApiKeyModal;
        window.updateApiStatus = updateApiStatus;
        window.hasApiKey = hasApiKey;
        window.getApiKey = getApiKey;

        // Timeline
        window.loadTimeline = loadTimeline;
        window.regenerateTimeline = regenerateTimeline;
        window.loadTimelineStorySelector = loadTimelineStorySelector;

        // Saved Research
        window.loadSavedResearch = loadSavedResearch;

        // Settings & Company
        window.loadCompanyPreset = loadCompanyPreset;
        window.saveCompanySettings = saveCompanySettings;
        window.resetCompanySettings = resetCompanySettings;

        // Data Management
        window.exportAllData = exportAllData;
        window.importAllData = importAllData;
        window.handleDataImport = handleDataImport;
        window.clearAllData = clearAllData;

        // Company Research
        window.startCompanyResearch = startCompanyResearch;
        window.useResearchedCompetencies = useResearchedCompetencies;
        window.saveResearchResults = saveResearchResults;
        window.loadSavedResearchItem = loadSavedResearchItem;
        window.deleteSavedResearch = deleteSavedResearch;
        window.clearResearchResults = clearResearchResults;
        window.exportResearchResults = exportResearchResults;

        // Misc UI
        window.showSection = showSection;
        window.setWebMode = setWebMode;
        window.selectAttachmentType = selectAttachmentType;

        // Debug test function - call from browser console: runDebugTests()
        window.runDebugTests = async function() {
            console.log('=== Running Debug Tests ===');
            
            // Test 1: Check critical functions
            const criticalFuncs = ['deleteStory', 'deleteStoryFromManager', 'deleteCurrentStory', 
                'deleteChip', 'deleteChildNode', 'deleteNode', 'exportToVisualHTML', 'printExportedHTML'];
            criticalFuncs.forEach(fn => {
                console.log(fn + ':', typeof window[fn] === 'function' ? '‚úÖ exists' : '‚ùå MISSING');
            });
            
            // Test 2: Check storage
            try {
                const stories = await storage.load('stories');
                console.log('Stories in storage:', Object.keys(stories || {}).length);
            } catch (e) {
                console.log('Storage error:', e.message);
            }
            
            // Test 3: Check current state
            console.log('currentWebStoryId:', window.currentWebStoryId);
            console.log('currentEditingNode:', window.currentEditingNode);
            
            console.log('=== Debug Tests Complete ===');
            return 'Tests completed - check console for results';
        };
        
        console.log('Behavioral Interview Coach v' + APP_VERSION + ' loaded. Run runDebugTests() in console for diagnostics.');
    </script>
</body>
</html>